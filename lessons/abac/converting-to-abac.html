<!DOCTYPE html><html><head><meta charSet="utf-8" data-next-head=""/><meta name="viewport" content="width=device-width" data-next-head=""/><link rel="apple-touch-icon" sizes="180x180" href="/fem-permission-systems-that-scale/images/apple-touch-icon.png" data-next-head=""/><link rel="icon" type="image/png" sizes="32x32" href="/fem-permission-systems-that-scale/images/favicon-32x32.png" data-next-head=""/><link rel="icon" type="image/png" sizes="16x16" href="/fem-permission-systems-that-scale/images/favicon-16x16.png" data-next-head=""/><link rel="icon" type="image/png" sizes="16x16" href="/fem-permission-systems-that-scale/images/favicon-16x16.png" data-next-head=""/><link rel="icon" type="image/x-icon" href="/fem-permission-systems-that-scale/images/favicon.ico" data-next-head=""/><title data-next-head="">Converting to ABAC – Permission Systems that Scale</title><meta name="description" content="Learn how to implement robust permission systems in your web applications. Master RBAC, ABAC, field-level permissions, and build your own authorization engine from scratch using TypeScript." data-next-head=""/><meta name="keywords" content="Permissions,Authorization,RBAC,ABAC,Access Control,TypeScript,Security,CASL,Web Dev Simplified,Frontend Masters" data-next-head=""/><meta name="og:description" content="Learn how to implement robust permission systems in your web applications. Master RBAC, ABAC, field-level permissions, and build your own authorization engine from scratch using TypeScript." data-next-head=""/><meta name="og:title" content="Converting to ABAC – Permission Systems that Scale" data-next-head=""/><meta name="og:image" content="/fem-permission-systems-that-scale/images/social-share-cover.jpg" data-next-head=""/><meta name="twitter:card" content="summary_large_image" data-next-head=""/><link data-next-font="size-adjust" rel="preconnect" href="/" crossorigin="anonymous"/><link rel="preload" href="/fem-permission-systems-that-scale/_next/static/css/3e2d260a483e4ce6.css" as="style"/><link rel="stylesheet" href="/fem-permission-systems-that-scale/_next/static/css/3e2d260a483e4ce6.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" noModule="" src="/fem-permission-systems-that-scale/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/fem-permission-systems-that-scale/_next/static/chunks/webpack-561d6b920ac5fc2e.js" defer=""></script><script src="/fem-permission-systems-that-scale/_next/static/chunks/framework-2f335d22a7318891.js" defer=""></script><script src="/fem-permission-systems-that-scale/_next/static/chunks/main-8377b0572add80b6.js" defer=""></script><script src="/fem-permission-systems-that-scale/_next/static/chunks/pages/_app-ab9f88be91011ccd.js" defer=""></script><script src="/fem-permission-systems-that-scale/_next/static/chunks/pages/lessons/%5Bsection%5D/%5Bslug%5D-c23b0a3ff434a742.js" defer=""></script><script src="/fem-permission-systems-that-scale/_next/static/Z1s-VsOExbnNujkBZEKnx/_buildManifest.js" defer=""></script><script src="/fem-permission-systems-that-scale/_next/static/Z1s-VsOExbnNujkBZEKnx/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="remix-app"><header class="navbar"><h1 class="navbar-brand"><a href="/fem-permission-systems-that-scale">Permission Systems that Scale</a></h1><div class="navbar-info"></div></header><div class="content-container"><div class="main"><div class="lesson-container"><div class="lesson"><div class="lesson-content"><p>Let&#39;s convert our RBAC system to ABAC. This first pass will have <strong>identical functionality</strong>—we&#39;re just restructuring the code to use an attribute-based model instead of a role-based one.</p>
<h2>The Goal</h2>
<p>Replace this hybrid RBAC code:</p>
<pre><code class="hljs language-typescript"><button class="copy-btn">Copy</button><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">canUpdateDocument</span>(<span class="hljs-params">user, <span class="hljs-variable language_">document</span></span>) {
  <span class="hljs-keyword">if</span> (user.<span class="hljs-property">role</span> === <span class="hljs-string">&quot;admin&quot;</span>) <span class="hljs-keyword">return</span> !<span class="hljs-variable language_">document</span>.<span class="hljs-property">isLocked</span>
  <span class="hljs-keyword">if</span> (user.<span class="hljs-property">role</span> === <span class="hljs-string">&quot;editor&quot;</span>) <span class="hljs-keyword">return</span> !<span class="hljs-variable language_">document</span>.<span class="hljs-property">isLocked</span>
  <span class="hljs-keyword">if</span> (user.<span class="hljs-property">role</span> === <span class="hljs-string">&quot;author&quot;</span>) {
    <span class="hljs-keyword">return</span> (
      <span class="hljs-variable language_">document</span>.<span class="hljs-property">creatorId</span> === user.<span class="hljs-property">id</span> &amp;&amp;
      !<span class="hljs-variable language_">document</span>.<span class="hljs-property">isLocked</span> &amp;&amp;
      <span class="hljs-variable language_">document</span>.<span class="hljs-property">status</span> === <span class="hljs-string">&quot;draft&quot;</span>
    )
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
}
</code></pre><p>With a unified ABAC API:</p>
<pre><code class="hljs language-typescript"><button class="copy-btn">Copy</button><span class="hljs-comment">// Single ABAC check handles everything</span>
<span class="hljs-keyword">if</span> (!permissions.<span class="hljs-title function_">can</span>(<span class="hljs-string">&quot;document&quot;</span>, <span class="hljs-string">&quot;update&quot;</span>, <span class="hljs-variable language_">document</span>)) {
  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthorizationError</span>()
}
</code></pre><h2>How ABAC Works</h2>
<p>In ABAC, we evaluate <strong>attributes</strong> from multiple sources to make access decisions:</p>
<p><img src="/fem-permission-systems-that-scale/images/04-abac/abac-flow.svg" alt="ABAC Flow"></p>
<p>Policies evaluate attributes from both subject and resource to make decisions. The key difference from RBAC: instead of looking up permissions by role alone, we evaluate <strong>conditions</strong> against the actual data at runtime.</p>
<h2>Step 1: Create the ABAC Module</h2>
<p>Here&#39;s the core idea in minimal code:</p>
<pre><code class="hljs language-typescript"><button class="copy-btn">Copy</button><span class="hljs-comment">// 1. Build permissions with conditions</span>
<span class="hljs-keyword">const</span> builder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PermissionBuilder</span>()
builder.<span class="hljs-title function_">allow</span>(<span class="hljs-string">&quot;document&quot;</span>, <span class="hljs-string">&quot;update&quot;</span>, { <span class="hljs-attr">creatorId</span>: user.<span class="hljs-property">id</span>, <span class="hljs-attr">isLocked</span>: <span class="hljs-literal">false</span> })
<span class="hljs-keyword">const</span> permissions = builder.<span class="hljs-title function_">build</span>()

<span class="hljs-comment">// 2. Check against actual resource data</span>
permissions.<span class="hljs-title function_">can</span>(<span class="hljs-string">&quot;document&quot;</span>, <span class="hljs-string">&quot;update&quot;</span>, <span class="hljs-variable language_">document</span>) <span class="hljs-comment">// true if all conditions match</span>
</code></pre><p>The <code>allow()</code> call says &quot;this user can update documents <strong>where</strong> they&#39;re the creator AND it&#39;s not locked.&quot; The <code>can()</code> call evaluates those conditions against the actual document.</p>
<h3>The Entry Point</h3>
<p>We&#39;ll create <code>src/permissions/abac.ts</code>. The entry point routes to role-specific policy builders:</p>
<pre><code class="hljs language-typescript"><button class="copy-btn">Copy</button><span class="hljs-comment">// src/permissions/abac.ts</span>

<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Document</span>, <span class="hljs-title class_">Project</span>, <span class="hljs-title class_">User</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/drizzle/schema&quot;</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserPermissions</span>(<span class="hljs-params">
  <span class="hljs-attr">user</span>: <span class="hljs-title class_">Pick</span>&lt;<span class="hljs-title class_">User</span>, <span class="hljs-string">&quot;department&quot;</span> | <span class="hljs-string">&quot;id&quot;</span> | <span class="hljs-string">&quot;role&quot;</span>&gt; | <span class="hljs-literal">null</span>,
</span>) {
  <span class="hljs-keyword">const</span> builder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PermissionBuilder</span>()
  <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> builder.<span class="hljs-title function_">build</span>()

  <span class="hljs-comment">// Add role-specific permissions...</span>

  <span class="hljs-keyword">return</span> builder.<span class="hljs-title function_">build</span>()
}
</code></pre><h2>Step 2: Define Role-Specific Policies</h2>
<p>Next we need to define the policies for each role.</p>
<h3>Editor Permissions Example</h3>
<pre><code class="hljs language-typescript"><button class="copy-btn">Copy</button>builder
  <span class="hljs-comment">// Can read projects in their department or global projects</span>
  .<span class="hljs-title function_">allow</span>(<span class="hljs-string">&quot;project&quot;</span>, <span class="hljs-string">&quot;read&quot;</span>, { <span class="hljs-attr">department</span>: user.<span class="hljs-property">department</span> })
  .<span class="hljs-title function_">allow</span>(<span class="hljs-string">&quot;project&quot;</span>, <span class="hljs-string">&quot;read&quot;</span>, { <span class="hljs-attr">department</span>: <span class="hljs-literal">null</span> })
  <span class="hljs-comment">// Can read all documents, edit unlocked ones</span>
  .<span class="hljs-title function_">allow</span>(<span class="hljs-string">&quot;document&quot;</span>, <span class="hljs-string">&quot;read&quot;</span>)
  .<span class="hljs-title function_">allow</span>(<span class="hljs-string">&quot;document&quot;</span>, <span class="hljs-string">&quot;update&quot;</span>, { <span class="hljs-attr">isLocked</span>: <span class="hljs-literal">false</span> })
</code></pre><p>Look at that last <code>.allow()</code> call: &quot;editors can update documents that are unlocked.&quot; In RBAC, this would require a helper function with manual attribute checks. In ABAC, it&#39;s declarative.</p>
<h2>Step 3: The Permission Builder</h2>
<p>The builder pattern makes policies easy to compose. Let&#39;s build it piece by piece.</p>
<h3>Type Definitions</h3>
<p>First, we define what resources exist and what attributes they have:</p>
<pre><code class="hljs language-typescript"><button class="copy-btn">Copy</button><span class="hljs-keyword">type</span> <span class="hljs-title class_">Resources</span> = {
  <span class="hljs-attr">project</span>: {
    <span class="hljs-attr">action</span>: <span class="hljs-string">&quot;create&quot;</span> | <span class="hljs-string">&quot;read&quot;</span> | <span class="hljs-string">&quot;update&quot;</span> | <span class="hljs-string">&quot;delete&quot;</span>
    <span class="hljs-attr">condition</span>: <span class="hljs-title class_">Pick</span>&lt;<span class="hljs-title class_">Project</span>, <span class="hljs-string">&quot;department&quot;</span>&gt;
  }
  <span class="hljs-attr">document</span>: {
    <span class="hljs-attr">action</span>: <span class="hljs-string">&quot;create&quot;</span> | <span class="hljs-string">&quot;read&quot;</span> | <span class="hljs-string">&quot;update&quot;</span> | <span class="hljs-string">&quot;delete&quot;</span>
    <span class="hljs-attr">condition</span>: <span class="hljs-title class_">Pick</span>&lt;<span class="hljs-title class_">Document</span>, <span class="hljs-string">&quot;projectId&quot;</span> | <span class="hljs-string">&quot;creatorId&quot;</span> | <span class="hljs-string">&quot;status&quot;</span> | <span class="hljs-string">&quot;isLocked&quot;</span>&gt;
  }
}
</code></pre><p>This gives us type safety: TypeScript knows that <code>project</code> conditions can only include <code>department</code>, while <code>document</code> conditions can include <code>status</code>, <code>isLocked</code>, etc.</p>
<h3>The <code>allow()</code> Method</h3>
<p>The <code>allow()</code> method accumulates permission rules:</p>
<pre><code class="hljs language-typescript"><button class="copy-btn">Copy</button><span class="hljs-keyword">class</span> <span class="hljs-title class_">PermissionBuilder</span> {
  #<span class="hljs-attr">permissions</span>: <span class="hljs-title class_">PermissionStore</span> = {
    <span class="hljs-attr">project</span>: [],
    <span class="hljs-attr">document</span>: [],
  }

  allow&lt;<span class="hljs-title class_">Res</span> <span class="hljs-keyword">extends</span> keyof <span class="hljs-title class_">Resources</span>&gt;(
    <span class="hljs-attr">resource</span>: <span class="hljs-title class_">Res</span>,
    <span class="hljs-attr">action</span>: <span class="hljs-title class_">Resources</span>[<span class="hljs-title class_">Res</span>][<span class="hljs-string">&quot;action&quot;</span>],
    <span class="hljs-attr">condition</span>?: <span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">Resources</span>[<span class="hljs-title class_">Res</span>][<span class="hljs-string">&quot;condition&quot;</span>]&gt;,
  ) {
    <span class="hljs-variable language_">this</span>.#permissions[resource].<span class="hljs-title function_">push</span>({ action, condition })
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span> <span class="hljs-comment">// Enable chaining: .allow(...).allow(...)</span>
  }
}
</code></pre><h3>The <code>can()</code> Method</h3>
<p>The <code>can()</code> method is where the magic happens—it evaluates conditions against actual data:</p>
<pre><code class="hljs language-typescript"><button class="copy-btn">Copy</button><span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> permissions = <span class="hljs-variable language_">this</span>.#permissions

  <span class="hljs-keyword">return</span> {
    can&lt;<span class="hljs-title class_">Res</span> <span class="hljs-keyword">extends</span> keyof <span class="hljs-title class_">Resources</span>&gt;(
      <span class="hljs-attr">resource</span>: <span class="hljs-title class_">Res</span>,
      <span class="hljs-attr">action</span>: <span class="hljs-title class_">Resources</span>[<span class="hljs-title class_">Res</span>][<span class="hljs-string">&quot;action&quot;</span>],
      <span class="hljs-attr">data</span>?: <span class="hljs-title class_">Resources</span>[<span class="hljs-title class_">Res</span>][<span class="hljs-string">&quot;condition&quot;</span>],
    ) {
      <span class="hljs-keyword">return</span> permissions[resource].<span class="hljs-title function_">some</span>(<span class="hljs-function">(<span class="hljs-params">perm</span>) =&gt;</span> {
        <span class="hljs-comment">// Must match the requested action</span>
        <span class="hljs-keyword">if</span> (perm.<span class="hljs-property">action</span> !== action) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>

        <span class="hljs-comment">// No condition = always allowed for this action</span>
        <span class="hljs-keyword">if</span> (perm.<span class="hljs-property">condition</span> == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>

        <span class="hljs-comment">// No data provided = just checking if action is possible</span>
        <span class="hljs-keyword">if</span> (data == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>

        <span class="hljs-comment">// Check all conditions match the resource</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(perm.<span class="hljs-property">condition</span>).<span class="hljs-title function_">every</span>(
          <span class="hljs-function">(<span class="hljs-params">[key, value]</span>) =&gt;</span> data[key <span class="hljs-keyword">as</span> keyof <span class="hljs-keyword">typeof</span> data] === value,
        )
      })
    },
  }
}
</code></pre><p>The algorithm:</p>
<ol>
<li>Find any permission matching the action</li>
<li>If that permission has no conditions, allow immediately</li>
<li>Otherwise, verify every condition matches the resource&#39;s attributes</li>
</ol>
<h2>Step 4: Update the Codebase</h2>
<p>Now we replace all permission checks with the new API.</p>
<h3>Before (Page Component)</h3>
<pre><code class="hljs language-typescript"><button class="copy-btn">Copy</button><span class="hljs-keyword">import</span> { can } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/permissions/rbac&quot;</span>
<span class="hljs-keyword">import</span> { canReadProject } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/permissions/projects&quot;</span>
<span class="hljs-keyword">import</span> { canUpdateDocument } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/permissions/documents&quot;</span>

<span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getCurrentUser</span>()
<span class="hljs-keyword">if</span> (!<span class="hljs-title function_">canReadProject</span>(user, project)) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">redirect</span>(<span class="hljs-string">&quot;/&quot;</span>)
}
<span class="hljs-keyword">if</span> (!<span class="hljs-title function_">canUpdateDocument</span>(user, <span class="hljs-variable language_">document</span>)) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">redirect</span>(<span class="hljs-string">`/projects/<span class="hljs-subst">${projectId}</span>`</span>)
}
</code></pre><h3>After (Page Component)</h3>
<pre><code class="hljs language-typescript"><button class="copy-btn">Copy</button><span class="hljs-keyword">import</span> { getUserPermissions } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/permissions/abac&quot;</span>

<span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getCurrentUser</span>()
<span class="hljs-keyword">const</span> permissions = <span class="hljs-title function_">getUserPermissions</span>(user)

<span class="hljs-keyword">if</span> (!permissions.<span class="hljs-title function_">can</span>(<span class="hljs-string">&quot;project&quot;</span>, <span class="hljs-string">&quot;read&quot;</span>, project)) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">redirect</span>(<span class="hljs-string">&quot;/&quot;</span>)
}
<span class="hljs-keyword">if</span> (!permissions.<span class="hljs-title function_">can</span>(<span class="hljs-string">&quot;document&quot;</span>, <span class="hljs-string">&quot;update&quot;</span>, <span class="hljs-variable language_">document</span>)) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">redirect</span>(<span class="hljs-string">`/projects/<span class="hljs-subst">${projectId}</span>`</span>)
}
</code></pre><h3>Before (Mutation)</h3>
<pre><code class="hljs language-typescript"><button class="copy-btn">Copy</button><span class="hljs-keyword">import</span> { can } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/permissions/rbac&quot;</span>
<span class="hljs-keyword">import</span> { canUpdateDocument } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/permissions/documents&quot;</span>

<span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getCurrentUser</span>()
<span class="hljs-keyword">const</span> <span class="hljs-variable language_">document</span> = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getDocumentById</span>(documentId)
<span class="hljs-keyword">if</span> (!<span class="hljs-title function_">canUpdateDocument</span>(user, <span class="hljs-variable language_">document</span>)) {
  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthorizationError</span>()
}
</code></pre><h3>After (Mutation)</h3>
<pre><code class="hljs language-typescript"><button class="copy-btn">Copy</button><span class="hljs-keyword">import</span> { getUserPermissions } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/permissions/abac&quot;</span>

<span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getCurrentUser</span>()
<span class="hljs-keyword">const</span> permissions = <span class="hljs-title function_">getUserPermissions</span>(user)
<span class="hljs-keyword">const</span> <span class="hljs-variable language_">document</span> = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getDocumentById</span>(documentId)

<span class="hljs-keyword">if</span> (!permissions.<span class="hljs-title function_">can</span>(<span class="hljs-string">&quot;document&quot;</span>, <span class="hljs-string">&quot;update&quot;</span>, <span class="hljs-variable language_">document</span>)) {
  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthorizationError</span>()
}
</code></pre><h2>What We Gain</h2>
<table>
<thead>
<tr>
<th>Benefit</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Unified API</strong></td>
<td>One <code>can()</code> function for all checks</td>
</tr>
<tr>
<td><strong>Declarative policies</strong></td>
<td>Conditions describe what&#39;s allowed</td>
</tr>
<tr>
<td><strong>No helper functions</strong></td>
<td>No more <code>canUpdateDocument</code>, <code>canReadProject</code>, etc.</td>
</tr>
<tr>
<td><strong>Type safety</strong></td>
<td>TypeScript enforces valid resources, actions, and conditions</td>
</tr>
<tr>
<td><strong>Composable</strong></td>
<td>Easy to add new conditions without new permission strings</td>
</tr>
</tbody></table>
<h2>What We Delete</h2>
<p>With ABAC in place, we can remove:</p>
<ul>
<li><code>src/permissions/rbac.ts</code> - The old RBAC module</li>
<li><code>src/permissions/documents.ts</code> - The document helper functions</li>
<li><code>src/permissions/projects.ts</code> - The project helper functions</li>
</ul>
<p>Everything is now in <code>src/permissions/abac.ts</code>.</p>
<h2>Branch Checkpoint</h2>
<p>After completing this conversion, your code should match:</p>
<pre><code class="hljs language-text"><button class="copy-btn">Copy</button>Branch: 5-abac-basic
</code></pre><p>Run the following to sync up:</p>
<pre><code class="hljs language-bash"><button class="copy-btn">Copy</button>git checkout 5-abac-basic
</code></pre><h2>What&#39;s Next</h2>
<p>This basic ABAC system has the same functionality as our RBAC + helpers approach, just with cleaner architecture. In the next lesson, we&#39;ll add <strong>advanced features</strong> that ABAC makes possible—like field-level permissions and automatic query filtering.</p>
</div><div class="lesson-links"><a href="/fem-permission-systems-that-scale/lessons/abac/what-is-abac" class="prev">← Previous</a><a href="/fem-permission-systems-that-scale/lessons/abac/advanced-abac-features" class="next">Next →</a></div></div><div class="details-bg"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="154" height="154" viewBox="0 0 154 154"><defs><clipPath id="clip-path"><rect id="Rectangle_2238" data-name="Rectangle 2238" width="154" height="154" transform="translate(9467 350)" fill="#fff" stroke="#707070" stroke-width="1"></rect></clipPath><clipPath id="clip-corner-image-active"><rect width="154" height="154"></rect></clipPath></defs><g id="corner-image-active" clip-path="url(#clip-corner-image-active)"><g id="Corner-image-active-2" data-name="Corner-image-active" transform="translate(-9467 -350)" clip-path="url(#clip-path)"><path id="Subtraction_34" data-name="Subtraction 34" d="M-3857.365,1740.766h0l-7.07-7.07,12.89-12.89v14.142l-5.818,5.818Zm-14.142-14.142h0l-7.071-7.07,27.033-27.033v14.143l-19.96,19.96Zm-14.143-14.143h0l-7.07-7.069,41.175-41.175v14.142Zm-14.142-14.142h0l-7.07-7.069,55.317-55.317v14.142Zm-14.142-14.142h0l-7.07-7.069,69.459-69.459v14.142Zm-14.142-14.142h0l-7.07-7.069,76.739-76.739h6.862v7.28Zm-14.143-14.143h0l-7.07-7.069,62.6-62.6h14.142Zm-14.142-14.142h0l-7.07-7.069,48.454-48.454h14.142Zm-14.142-14.142h0l-7.07-7.069,34.312-34.312h14.142Zm-14.142-14.142h0l-7.07-7.069,20.17-20.17h14.142Zm-14.142-14.142h0l-7.071-7.071,6.027-6.027h14.144l-13.1,13.1Zm367.24-56.114v-.909l.455.455-.453.453Z" transform="translate(13472.546 -1236.766)" fill="var(--corner-fill)"></path></g></g></svg></div></div></div></div><footer class="footer"><ul class="socials"><li class="social"><a href="https://twitter.com/DevSimplified"><svg fill="none" height="100%" width="32" xmlns="http://www.w3.org/2000/svg" viewBox="0.254 0.25 500 451.95400000000006"><path d="M394.033.25h76.67L303.202 191.693l197.052 260.511h-154.29L225.118 294.205 86.844 452.204H10.127l179.16-204.77L.254.25H158.46l109.234 144.417zm-26.908 406.063h42.483L135.377 43.73h-45.59z" fill="var(--footer-icons)"></path></svg></a></li><li class="social"><a href="https://github.com/WebDevSimplified"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32" height="32" viewBox="0 0 32 32"><defs><clipPath id="clip-github-social"><rect width="32" height="32"></rect></clipPath></defs><g id="github-social" clip-path="url(#clip-github-social)"><g id="Group_272" data-name="Group 272" transform="translate(13522.5 -6994)"><path id="Subtraction_33" data-name="Subtraction 33" d="M-24967.5,8041a15.9,15.9,0,0,1-11.312-4.688A15.893,15.893,0,0,1-24983.5,8025a15.893,15.893,0,0,1,4.689-11.315A15.894,15.894,0,0,1-24967.5,8009a15.894,15.894,0,0,1,11.313,4.686A15.893,15.893,0,0,1-24951.5,8025a15.893,15.893,0,0,1-4.689,11.313A15.9,15.9,0,0,1-24967.5,8041Zm-3.781-4.571h0v3.918h7.895v-6.665a1.836,1.836,0,0,0-1.2-1.718c5.1-.617,7.467-2.975,7.467-7.424a7.176,7.176,0,0,0-1.637-4.728,6.74,6.74,0,0,0,.275-1.812,4.34,4.34,0,0,0-.52-2.452.574.574,0,0,0-.359-.1c-1.061,0-3.465,1.411-3.936,1.694a16.644,16.644,0,0,0-4.2-.489,16.379,16.379,0,0,0-3.969.445c-.846-.5-2.91-1.649-3.859-1.649a.566.566,0,0,0-.354.095,4.3,4.3,0,0,0-.521,2.452,6.7,6.7,0,0,0,.244,1.718,7.346,7.346,0,0,0-1.6,4.822,7.263,7.263,0,0,0,1.533,4.985c1.193,1.359,3.115,2.165,5.871,2.464a1.826,1.826,0,0,0-1.129,1.693v.5h0l-.006,0a7.121,7.121,0,0,1-2.033.363,2.608,2.608,0,0,1-.965-.158,4.438,4.438,0,0,1-1.836-1.881,2.361,2.361,0,0,0-1.248-1.091,3.472,3.472,0,0,0-1.217-.3.584.584,0,0,0-.545.224.282.282,0,0,0,.027.367,1.875,1.875,0,0,0,.447.307,4.732,4.732,0,0,1,.561.355,10.726,10.726,0,0,1,1.682,2.755c.043.092.078.163.105.217a3.876,3.876,0,0,0,2.42,1.185,6.036,6.036,0,0,0,.607.025c.875,0,1.988-.124,2-.125Z" transform="translate(11461 -1015)" fill="var(--footer-icons)"></path><g id="Ellipse_670" data-name="Ellipse 670" transform="translate(-13522.5 6994)" fill="none" stroke="var(--footer-icons)" stroke-width="1"><circle cx="16" cy="16" r="16" stroke="none"></circle><circle cx="16" cy="16" r="15.5" fill="none"></circle></g></g></g></svg></a></li><li class="social"><div class="terms"><p>Content Licensed Under CC-BY-NC-4.0</p><p>Code Samples and Exercises Licensed Under Apache 2.0</p><p>Site Designed by<!-- --> <a href="https://www.alexdanielson.com/">Alex Danielson</a></p></div></li></ul><div class="theme-icons"><button aria-label="Activate dark mode" title="Activate dark mode" class="theme-toggle"><svg xmlns="http://www.w3.org/2000/svg" width="36px" height="100%" viewBox="0 -960 960 960" fill="var(--text-footer)" role="img"><title>Dark Mode Icon</title><path d="M480-120q-150 0-255-105T120-480q0-150 105-255t255-105q14 0 27.5 1t26.5 3q-41 29-65.5 75.5T444-660q0 90 63 153t153 63q55 0 101-24.5t75-65.5q2 13 3 26.5t1 27.5q0 150-105 255T480-120Zm0-80q88 0 158-48.5T740-375q-20 5-40 8t-40 3q-123 0-209.5-86.5T364-660q0-20 3-40t8-40q-78 32-126.5 102T200-480q0 116 82 198t198 82Z"></path></svg></button></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"attributes":{"title":"Converting to ABAC"},"html":"\u003cp\u003eLet\u0026#39;s convert our RBAC system to ABAC. This first pass will have \u003cstrong\u003eidentical functionality\u003c/strong\u003e—we\u0026#39;re just restructuring the code to use an attribute-based model instead of a role-based one.\u003c/p\u003e\n\u003ch2\u003eThe Goal\u003c/h2\u003e\n\u003cp\u003eReplace this hybrid RBAC code:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cbutton class=\"copy-btn\"\u003eCopy\u003c/button\u003e\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ecanUpdateDocument\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003euser, \u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (user.\u003cspan class=\"hljs-property\"\u003erole\u003c/span\u003e === \u003cspan class=\"hljs-string\"\u003e\u0026quot;admin\u0026quot;\u003c/span\u003e) \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e !\u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eisLocked\u003c/span\u003e\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (user.\u003cspan class=\"hljs-property\"\u003erole\u003c/span\u003e === \u003cspan class=\"hljs-string\"\u003e\u0026quot;editor\u0026quot;\u003c/span\u003e) \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e !\u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eisLocked\u003c/span\u003e\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (user.\u003cspan class=\"hljs-property\"\u003erole\u003c/span\u003e === \u003cspan class=\"hljs-string\"\u003e\u0026quot;author\u0026quot;\u003c/span\u003e) {\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e (\n      \u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ecreatorId\u003c/span\u003e === user.\u003cspan class=\"hljs-property\"\u003eid\u003c/span\u003e \u0026amp;\u0026amp;\n      !\u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eisLocked\u003c/span\u003e \u0026amp;\u0026amp;\n      \u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003estatus\u003c/span\u003e === \u003cspan class=\"hljs-string\"\u003e\u0026quot;draft\u0026quot;\u003c/span\u003e\n    )\n  }\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e\n}\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eWith a unified ABAC API:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cbutton class=\"copy-btn\"\u003eCopy\u003c/button\u003e\u003cspan class=\"hljs-comment\"\u003e// Single ABAC check handles everything\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!permissions.\u003cspan class=\"hljs-title function_\"\u003ecan\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;document\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;update\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e)) {\n  \u003cspan class=\"hljs-keyword\"\u003ethrow\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eAuthorizationError\u003c/span\u003e()\n}\n\u003c/code\u003e\u003c/pre\u003e\u003ch2\u003eHow ABAC Works\u003c/h2\u003e\n\u003cp\u003eIn ABAC, we evaluate \u003cstrong\u003eattributes\u003c/strong\u003e from multiple sources to make access decisions:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/fem-permission-systems-that-scale/images/04-abac/abac-flow.svg\" alt=\"ABAC Flow\"\u003e\u003c/p\u003e\n\u003cp\u003ePolicies evaluate attributes from both subject and resource to make decisions. The key difference from RBAC: instead of looking up permissions by role alone, we evaluate \u003cstrong\u003econditions\u003c/strong\u003e against the actual data at runtime.\u003c/p\u003e\n\u003ch2\u003eStep 1: Create the ABAC Module\u003c/h2\u003e\n\u003cp\u003eHere\u0026#39;s the core idea in minimal code:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cbutton class=\"copy-btn\"\u003eCopy\u003c/button\u003e\u003cspan class=\"hljs-comment\"\u003e// 1. Build permissions with conditions\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e builder = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003ePermissionBuilder\u003c/span\u003e()\nbuilder.\u003cspan class=\"hljs-title function_\"\u003eallow\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;document\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;update\u0026quot;\u003c/span\u003e, { \u003cspan class=\"hljs-attr\"\u003ecreatorId\u003c/span\u003e: user.\u003cspan class=\"hljs-property\"\u003eid\u003c/span\u003e, \u003cspan class=\"hljs-attr\"\u003eisLocked\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e })\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e permissions = builder.\u003cspan class=\"hljs-title function_\"\u003ebuild\u003c/span\u003e()\n\n\u003cspan class=\"hljs-comment\"\u003e// 2. Check against actual resource data\u003c/span\u003e\npermissions.\u003cspan class=\"hljs-title function_\"\u003ecan\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;document\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;update\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e) \u003cspan class=\"hljs-comment\"\u003e// true if all conditions match\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eThe \u003ccode\u003eallow()\u003c/code\u003e call says \u0026quot;this user can update documents \u003cstrong\u003ewhere\u003c/strong\u003e they\u0026#39;re the creator AND it\u0026#39;s not locked.\u0026quot; The \u003ccode\u003ecan()\u003c/code\u003e call evaluates those conditions against the actual document.\u003c/p\u003e\n\u003ch3\u003eThe Entry Point\u003c/h3\u003e\n\u003cp\u003eWe\u0026#39;ll create \u003ccode\u003esrc/permissions/abac.ts\u003c/code\u003e. The entry point routes to role-specific policy builders:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cbutton class=\"copy-btn\"\u003eCopy\u003c/button\u003e\u003cspan class=\"hljs-comment\"\u003e// src/permissions/abac.ts\u003c/span\u003e\n\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e { \u003cspan class=\"hljs-title class_\"\u003eDocument\u003c/span\u003e, \u003cspan class=\"hljs-title class_\"\u003eProject\u003c/span\u003e, \u003cspan class=\"hljs-title class_\"\u003eUser\u003c/span\u003e } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;@/drizzle/schema\u0026quot;\u003c/span\u003e\n\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003egetUserPermissions\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\n  \u003cspan class=\"hljs-attr\"\u003euser\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003ePick\u003c/span\u003e\u0026lt;\u003cspan class=\"hljs-title class_\"\u003eUser\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;department\u0026quot;\u003c/span\u003e | \u003cspan class=\"hljs-string\"\u003e\u0026quot;id\u0026quot;\u003c/span\u003e | \u003cspan class=\"hljs-string\"\u003e\u0026quot;role\u0026quot;\u003c/span\u003e\u0026gt; | \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\n\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e builder = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003ePermissionBuilder\u003c/span\u003e()\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (user == \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e builder.\u003cspan class=\"hljs-title function_\"\u003ebuild\u003c/span\u003e()\n\n  \u003cspan class=\"hljs-comment\"\u003e// Add role-specific permissions...\u003c/span\u003e\n\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e builder.\u003cspan class=\"hljs-title function_\"\u003ebuild\u003c/span\u003e()\n}\n\u003c/code\u003e\u003c/pre\u003e\u003ch2\u003eStep 2: Define Role-Specific Policies\u003c/h2\u003e\n\u003cp\u003eNext we need to define the policies for each role.\u003c/p\u003e\n\u003ch3\u003eEditor Permissions Example\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cbutton class=\"copy-btn\"\u003eCopy\u003c/button\u003ebuilder\n  \u003cspan class=\"hljs-comment\"\u003e// Can read projects in their department or global projects\u003c/span\u003e\n  .\u003cspan class=\"hljs-title function_\"\u003eallow\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;project\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;read\u0026quot;\u003c/span\u003e, { \u003cspan class=\"hljs-attr\"\u003edepartment\u003c/span\u003e: user.\u003cspan class=\"hljs-property\"\u003edepartment\u003c/span\u003e })\n  .\u003cspan class=\"hljs-title function_\"\u003eallow\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;project\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;read\u0026quot;\u003c/span\u003e, { \u003cspan class=\"hljs-attr\"\u003edepartment\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e })\n  \u003cspan class=\"hljs-comment\"\u003e// Can read all documents, edit unlocked ones\u003c/span\u003e\n  .\u003cspan class=\"hljs-title function_\"\u003eallow\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;document\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;read\u0026quot;\u003c/span\u003e)\n  .\u003cspan class=\"hljs-title function_\"\u003eallow\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;document\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;update\u0026quot;\u003c/span\u003e, { \u003cspan class=\"hljs-attr\"\u003eisLocked\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e })\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eLook at that last \u003ccode\u003e.allow()\u003c/code\u003e call: \u0026quot;editors can update documents that are unlocked.\u0026quot; In RBAC, this would require a helper function with manual attribute checks. In ABAC, it\u0026#39;s declarative.\u003c/p\u003e\n\u003ch2\u003eStep 3: The Permission Builder\u003c/h2\u003e\n\u003cp\u003eThe builder pattern makes policies easy to compose. Let\u0026#39;s build it piece by piece.\u003c/p\u003e\n\u003ch3\u003eType Definitions\u003c/h3\u003e\n\u003cp\u003eFirst, we define what resources exist and what attributes they have:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cbutton class=\"copy-btn\"\u003eCopy\u003c/button\u003e\u003cspan class=\"hljs-keyword\"\u003etype\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eResources\u003c/span\u003e = {\n  \u003cspan class=\"hljs-attr\"\u003eproject\u003c/span\u003e: {\n    \u003cspan class=\"hljs-attr\"\u003eaction\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;create\u0026quot;\u003c/span\u003e | \u003cspan class=\"hljs-string\"\u003e\u0026quot;read\u0026quot;\u003c/span\u003e | \u003cspan class=\"hljs-string\"\u003e\u0026quot;update\u0026quot;\u003c/span\u003e | \u003cspan class=\"hljs-string\"\u003e\u0026quot;delete\u0026quot;\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003econdition\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003ePick\u003c/span\u003e\u0026lt;\u003cspan class=\"hljs-title class_\"\u003eProject\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;department\u0026quot;\u003c/span\u003e\u0026gt;\n  }\n  \u003cspan class=\"hljs-attr\"\u003edocument\u003c/span\u003e: {\n    \u003cspan class=\"hljs-attr\"\u003eaction\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;create\u0026quot;\u003c/span\u003e | \u003cspan class=\"hljs-string\"\u003e\u0026quot;read\u0026quot;\u003c/span\u003e | \u003cspan class=\"hljs-string\"\u003e\u0026quot;update\u0026quot;\u003c/span\u003e | \u003cspan class=\"hljs-string\"\u003e\u0026quot;delete\u0026quot;\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003econdition\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003ePick\u003c/span\u003e\u0026lt;\u003cspan class=\"hljs-title class_\"\u003eDocument\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;projectId\u0026quot;\u003c/span\u003e | \u003cspan class=\"hljs-string\"\u003e\u0026quot;creatorId\u0026quot;\u003c/span\u003e | \u003cspan class=\"hljs-string\"\u003e\u0026quot;status\u0026quot;\u003c/span\u003e | \u003cspan class=\"hljs-string\"\u003e\u0026quot;isLocked\u0026quot;\u003c/span\u003e\u0026gt;\n  }\n}\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eThis gives us type safety: TypeScript knows that \u003ccode\u003eproject\u003c/code\u003e conditions can only include \u003ccode\u003edepartment\u003c/code\u003e, while \u003ccode\u003edocument\u003c/code\u003e conditions can include \u003ccode\u003estatus\u003c/code\u003e, \u003ccode\u003eisLocked\u003c/code\u003e, etc.\u003c/p\u003e\n\u003ch3\u003eThe \u003ccode\u003eallow()\u003c/code\u003e Method\u003c/h3\u003e\n\u003cp\u003eThe \u003ccode\u003eallow()\u003c/code\u003e method accumulates permission rules:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cbutton class=\"copy-btn\"\u003eCopy\u003c/button\u003e\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003ePermissionBuilder\u003c/span\u003e {\n  #\u003cspan class=\"hljs-attr\"\u003epermissions\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003ePermissionStore\u003c/span\u003e = {\n    \u003cspan class=\"hljs-attr\"\u003eproject\u003c/span\u003e: [],\n    \u003cspan class=\"hljs-attr\"\u003edocument\u003c/span\u003e: [],\n  }\n\n  allow\u0026lt;\u003cspan class=\"hljs-title class_\"\u003eRes\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eextends\u003c/span\u003e keyof \u003cspan class=\"hljs-title class_\"\u003eResources\u003c/span\u003e\u0026gt;(\n    \u003cspan class=\"hljs-attr\"\u003eresource\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eRes\u003c/span\u003e,\n    \u003cspan class=\"hljs-attr\"\u003eaction\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eResources\u003c/span\u003e[\u003cspan class=\"hljs-title class_\"\u003eRes\u003c/span\u003e][\u003cspan class=\"hljs-string\"\u003e\u0026quot;action\u0026quot;\u003c/span\u003e],\n    \u003cspan class=\"hljs-attr\"\u003econdition\u003c/span\u003e?: \u003cspan class=\"hljs-title class_\"\u003ePartial\u003c/span\u003e\u0026lt;\u003cspan class=\"hljs-title class_\"\u003eResources\u003c/span\u003e[\u003cspan class=\"hljs-title class_\"\u003eRes\u003c/span\u003e][\u003cspan class=\"hljs-string\"\u003e\u0026quot;condition\u0026quot;\u003c/span\u003e]\u0026gt;,\n  ) {\n    \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.#permissions[resource].\u003cspan class=\"hljs-title function_\"\u003epush\u003c/span\u003e({ action, condition })\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e \u003cspan class=\"hljs-comment\"\u003e// Enable chaining: .allow(...).allow(...)\u003c/span\u003e\n  }\n}\n\u003c/code\u003e\u003c/pre\u003e\u003ch3\u003eThe \u003ccode\u003ecan()\u003c/code\u003e Method\u003c/h3\u003e\n\u003cp\u003eThe \u003ccode\u003ecan()\u003c/code\u003e method is where the magic happens—it evaluates conditions against actual data:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cbutton class=\"copy-btn\"\u003eCopy\u003c/button\u003e\u003cspan class=\"hljs-title function_\"\u003ebuild\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e permissions = \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.#permissions\n\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e {\n    can\u0026lt;\u003cspan class=\"hljs-title class_\"\u003eRes\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eextends\u003c/span\u003e keyof \u003cspan class=\"hljs-title class_\"\u003eResources\u003c/span\u003e\u0026gt;(\n      \u003cspan class=\"hljs-attr\"\u003eresource\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eRes\u003c/span\u003e,\n      \u003cspan class=\"hljs-attr\"\u003eaction\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eResources\u003c/span\u003e[\u003cspan class=\"hljs-title class_\"\u003eRes\u003c/span\u003e][\u003cspan class=\"hljs-string\"\u003e\u0026quot;action\u0026quot;\u003c/span\u003e],\n      \u003cspan class=\"hljs-attr\"\u003edata\u003c/span\u003e?: \u003cspan class=\"hljs-title class_\"\u003eResources\u003c/span\u003e[\u003cspan class=\"hljs-title class_\"\u003eRes\u003c/span\u003e][\u003cspan class=\"hljs-string\"\u003e\u0026quot;condition\u0026quot;\u003c/span\u003e],\n    ) {\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e permissions[resource].\u003cspan class=\"hljs-title function_\"\u003esome\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003eperm\u003c/span\u003e) =\u0026gt;\u003c/span\u003e {\n        \u003cspan class=\"hljs-comment\"\u003e// Must match the requested action\u003c/span\u003e\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (perm.\u003cspan class=\"hljs-property\"\u003eaction\u003c/span\u003e !== action) \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e\n\n        \u003cspan class=\"hljs-comment\"\u003e// No condition = always allowed for this action\u003c/span\u003e\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (perm.\u003cspan class=\"hljs-property\"\u003econdition\u003c/span\u003e == \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e\n\n        \u003cspan class=\"hljs-comment\"\u003e// No data provided = just checking if action is possible\u003c/span\u003e\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (data == \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e\n\n        \u003cspan class=\"hljs-comment\"\u003e// Check all conditions match the resource\u003c/span\u003e\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eObject\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eentries\u003c/span\u003e(perm.\u003cspan class=\"hljs-property\"\u003econdition\u003c/span\u003e).\u003cspan class=\"hljs-title function_\"\u003eevery\u003c/span\u003e(\n          \u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003e[key, value]\u003c/span\u003e) =\u0026gt;\u003c/span\u003e data[key \u003cspan class=\"hljs-keyword\"\u003eas\u003c/span\u003e keyof \u003cspan class=\"hljs-keyword\"\u003etypeof\u003c/span\u003e data] === value,\n        )\n      })\n    },\n  }\n}\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eThe algorithm:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eFind any permission matching the action\u003c/li\u003e\n\u003cli\u003eIf that permission has no conditions, allow immediately\u003c/li\u003e\n\u003cli\u003eOtherwise, verify every condition matches the resource\u0026#39;s attributes\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2\u003eStep 4: Update the Codebase\u003c/h2\u003e\n\u003cp\u003eNow we replace all permission checks with the new API.\u003c/p\u003e\n\u003ch3\u003eBefore (Page Component)\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cbutton class=\"copy-btn\"\u003eCopy\u003c/button\u003e\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e { can } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;@/permissions/rbac\u0026quot;\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e { canReadProject } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;@/permissions/projects\u0026quot;\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e { canUpdateDocument } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;@/permissions/documents\u0026quot;\u003c/span\u003e\n\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e user = \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003egetCurrentUser\u003c/span\u003e()\n\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!\u003cspan class=\"hljs-title function_\"\u003ecanReadProject\u003c/span\u003e(user, project)) {\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eredirect\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;/\u0026quot;\u003c/span\u003e)\n}\n\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!\u003cspan class=\"hljs-title function_\"\u003ecanUpdateDocument\u003c/span\u003e(user, \u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e)) {\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eredirect\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e`/projects/\u003cspan class=\"hljs-subst\"\u003e${projectId}\u003c/span\u003e`\u003c/span\u003e)\n}\n\u003c/code\u003e\u003c/pre\u003e\u003ch3\u003eAfter (Page Component)\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cbutton class=\"copy-btn\"\u003eCopy\u003c/button\u003e\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e { getUserPermissions } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;@/permissions/abac\u0026quot;\u003c/span\u003e\n\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e user = \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003egetCurrentUser\u003c/span\u003e()\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e permissions = \u003cspan class=\"hljs-title function_\"\u003egetUserPermissions\u003c/span\u003e(user)\n\n\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!permissions.\u003cspan class=\"hljs-title function_\"\u003ecan\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;project\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;read\u0026quot;\u003c/span\u003e, project)) {\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eredirect\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;/\u0026quot;\u003c/span\u003e)\n}\n\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!permissions.\u003cspan class=\"hljs-title function_\"\u003ecan\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;document\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;update\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e)) {\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eredirect\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e`/projects/\u003cspan class=\"hljs-subst\"\u003e${projectId}\u003c/span\u003e`\u003c/span\u003e)\n}\n\u003c/code\u003e\u003c/pre\u003e\u003ch3\u003eBefore (Mutation)\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cbutton class=\"copy-btn\"\u003eCopy\u003c/button\u003e\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e { can } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;@/permissions/rbac\u0026quot;\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e { canUpdateDocument } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;@/permissions/documents\u0026quot;\u003c/span\u003e\n\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e user = \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003egetCurrentUser\u003c/span\u003e()\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e = \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003egetDocumentById\u003c/span\u003e(documentId)\n\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!\u003cspan class=\"hljs-title function_\"\u003ecanUpdateDocument\u003c/span\u003e(user, \u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e)) {\n  \u003cspan class=\"hljs-keyword\"\u003ethrow\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eAuthorizationError\u003c/span\u003e()\n}\n\u003c/code\u003e\u003c/pre\u003e\u003ch3\u003eAfter (Mutation)\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cbutton class=\"copy-btn\"\u003eCopy\u003c/button\u003e\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e { getUserPermissions } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;@/permissions/abac\u0026quot;\u003c/span\u003e\n\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e user = \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003egetCurrentUser\u003c/span\u003e()\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e permissions = \u003cspan class=\"hljs-title function_\"\u003egetUserPermissions\u003c/span\u003e(user)\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e = \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003egetDocumentById\u003c/span\u003e(documentId)\n\n\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!permissions.\u003cspan class=\"hljs-title function_\"\u003ecan\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;document\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;update\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e)) {\n  \u003cspan class=\"hljs-keyword\"\u003ethrow\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eAuthorizationError\u003c/span\u003e()\n}\n\u003c/code\u003e\u003c/pre\u003e\u003ch2\u003eWhat We Gain\u003c/h2\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003eBenefit\u003c/th\u003e\n\u003cth\u003eDescription\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\u003ctr\u003e\n\u003ctd\u003e\u003cstrong\u003eUnified API\u003c/strong\u003e\u003c/td\u003e\n\u003ctd\u003eOne \u003ccode\u003ecan()\u003c/code\u003e function for all checks\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003cstrong\u003eDeclarative policies\u003c/strong\u003e\u003c/td\u003e\n\u003ctd\u003eConditions describe what\u0026#39;s allowed\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003cstrong\u003eNo helper functions\u003c/strong\u003e\u003c/td\u003e\n\u003ctd\u003eNo more \u003ccode\u003ecanUpdateDocument\u003c/code\u003e, \u003ccode\u003ecanReadProject\u003c/code\u003e, etc.\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003cstrong\u003eType safety\u003c/strong\u003e\u003c/td\u003e\n\u003ctd\u003eTypeScript enforces valid resources, actions, and conditions\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003cstrong\u003eComposable\u003c/strong\u003e\u003c/td\u003e\n\u003ctd\u003eEasy to add new conditions without new permission strings\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\u003c/table\u003e\n\u003ch2\u003eWhat We Delete\u003c/h2\u003e\n\u003cp\u003eWith ABAC in place, we can remove:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003esrc/permissions/rbac.ts\u003c/code\u003e - The old RBAC module\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003esrc/permissions/documents.ts\u003c/code\u003e - The document helper functions\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003esrc/permissions/projects.ts\u003c/code\u003e - The project helper functions\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eEverything is now in \u003ccode\u003esrc/permissions/abac.ts\u003c/code\u003e.\u003c/p\u003e\n\u003ch2\u003eBranch Checkpoint\u003c/h2\u003e\n\u003cp\u003eAfter completing this conversion, your code should match:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-text\"\u003e\u003cbutton class=\"copy-btn\"\u003eCopy\u003c/button\u003eBranch: 5-abac-basic\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eRun the following to sync up:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e\u003cbutton class=\"copy-btn\"\u003eCopy\u003c/button\u003egit checkout 5-abac-basic\n\u003c/code\u003e\u003c/pre\u003e\u003ch2\u003eWhat\u0026#39;s Next\u003c/h2\u003e\n\u003cp\u003eThis basic ABAC system has the same functionality as our RBAC + helpers approach, just with cleaner architecture. In the next lesson, we\u0026#39;ll add \u003cstrong\u003eadvanced features\u003c/strong\u003e that ABAC makes possible—like field-level permissions and automatic query filtering.\u003c/p\u003e\n","markdown":"\nLet's convert our RBAC system to ABAC. This first pass will have **identical functionality**—we're just restructuring the code to use an attribute-based model instead of a role-based one.\n\n## The Goal\n\nReplace this hybrid RBAC code:\n\n```typescript\nexport function canUpdateDocument(user, document) {\n  if (user.role === \"admin\") return !document.isLocked\n  if (user.role === \"editor\") return !document.isLocked\n  if (user.role === \"author\") {\n    return (\n      document.creatorId === user.id \u0026\u0026\n      !document.isLocked \u0026\u0026\n      document.status === \"draft\"\n    )\n  }\n  return false\n}\n```\n\nWith a unified ABAC API:\n\n```typescript\n// Single ABAC check handles everything\nif (!permissions.can(\"document\", \"update\", document)) {\n  throw new AuthorizationError()\n}\n```\n\n## How ABAC Works\n\nIn ABAC, we evaluate **attributes** from multiple sources to make access decisions:\n\n![ABAC Flow](/fem-permission-systems-that-scale/images/04-abac/abac-flow.svg)\n\nPolicies evaluate attributes from both subject and resource to make decisions. The key difference from RBAC: instead of looking up permissions by role alone, we evaluate **conditions** against the actual data at runtime.\n\n## Step 1: Create the ABAC Module\n\nHere's the core idea in minimal code:\n\n```typescript\n// 1. Build permissions with conditions\nconst builder = new PermissionBuilder()\nbuilder.allow(\"document\", \"update\", { creatorId: user.id, isLocked: false })\nconst permissions = builder.build()\n\n// 2. Check against actual resource data\npermissions.can(\"document\", \"update\", document) // true if all conditions match\n```\n\nThe `allow()` call says \"this user can update documents **where** they're the creator AND it's not locked.\" The `can()` call evaluates those conditions against the actual document.\n\n### The Entry Point\n\nWe'll create `src/permissions/abac.ts`. The entry point routes to role-specific policy builders:\n\n```typescript\n// src/permissions/abac.ts\n\nimport { Document, Project, User } from \"@/drizzle/schema\"\n\nexport function getUserPermissions(\n  user: Pick\u003cUser, \"department\" | \"id\" | \"role\"\u003e | null,\n) {\n  const builder = new PermissionBuilder()\n  if (user == null) return builder.build()\n\n  // Add role-specific permissions...\n\n  return builder.build()\n}\n```\n\n## Step 2: Define Role-Specific Policies\n\nNext we need to define the policies for each role.\n\n### Editor Permissions Example\n\n```typescript\nbuilder\n  // Can read projects in their department or global projects\n  .allow(\"project\", \"read\", { department: user.department })\n  .allow(\"project\", \"read\", { department: null })\n  // Can read all documents, edit unlocked ones\n  .allow(\"document\", \"read\")\n  .allow(\"document\", \"update\", { isLocked: false })\n```\n\nLook at that last `.allow()` call: \"editors can update documents that are unlocked.\" In RBAC, this would require a helper function with manual attribute checks. In ABAC, it's declarative.\n\n## Step 3: The Permission Builder\n\nThe builder pattern makes policies easy to compose. Let's build it piece by piece.\n\n### Type Definitions\n\nFirst, we define what resources exist and what attributes they have:\n\n```typescript\ntype Resources = {\n  project: {\n    action: \"create\" | \"read\" | \"update\" | \"delete\"\n    condition: Pick\u003cProject, \"department\"\u003e\n  }\n  document: {\n    action: \"create\" | \"read\" | \"update\" | \"delete\"\n    condition: Pick\u003cDocument, \"projectId\" | \"creatorId\" | \"status\" | \"isLocked\"\u003e\n  }\n}\n```\n\nThis gives us type safety: TypeScript knows that `project` conditions can only include `department`, while `document` conditions can include `status`, `isLocked`, etc.\n\n### The `allow()` Method\n\nThe `allow()` method accumulates permission rules:\n\n```typescript\nclass PermissionBuilder {\n  #permissions: PermissionStore = {\n    project: [],\n    document: [],\n  }\n\n  allow\u003cRes extends keyof Resources\u003e(\n    resource: Res,\n    action: Resources[Res][\"action\"],\n    condition?: Partial\u003cResources[Res][\"condition\"]\u003e,\n  ) {\n    this.#permissions[resource].push({ action, condition })\n    return this // Enable chaining: .allow(...).allow(...)\n  }\n}\n```\n\n### The `can()` Method\n\nThe `can()` method is where the magic happens—it evaluates conditions against actual data:\n\n```typescript\nbuild() {\n  const permissions = this.#permissions\n\n  return {\n    can\u003cRes extends keyof Resources\u003e(\n      resource: Res,\n      action: Resources[Res][\"action\"],\n      data?: Resources[Res][\"condition\"],\n    ) {\n      return permissions[resource].some((perm) =\u003e {\n        // Must match the requested action\n        if (perm.action !== action) return false\n\n        // No condition = always allowed for this action\n        if (perm.condition == null) return true\n\n        // No data provided = just checking if action is possible\n        if (data == null) return true\n\n        // Check all conditions match the resource\n        return Object.entries(perm.condition).every(\n          ([key, value]) =\u003e data[key as keyof typeof data] === value,\n        )\n      })\n    },\n  }\n}\n```\n\nThe algorithm:\n\n1. Find any permission matching the action\n2. If that permission has no conditions, allow immediately\n3. Otherwise, verify every condition matches the resource's attributes\n\n## Step 4: Update the Codebase\n\nNow we replace all permission checks with the new API.\n\n### Before (Page Component)\n\n```typescript\nimport { can } from \"@/permissions/rbac\"\nimport { canReadProject } from \"@/permissions/projects\"\nimport { canUpdateDocument } from \"@/permissions/documents\"\n\nconst user = await getCurrentUser()\nif (!canReadProject(user, project)) {\n  return redirect(\"/\")\n}\nif (!canUpdateDocument(user, document)) {\n  return redirect(`/projects/${projectId}`)\n}\n```\n\n### After (Page Component)\n\n```typescript\nimport { getUserPermissions } from \"@/permissions/abac\"\n\nconst user = await getCurrentUser()\nconst permissions = getUserPermissions(user)\n\nif (!permissions.can(\"project\", \"read\", project)) {\n  return redirect(\"/\")\n}\nif (!permissions.can(\"document\", \"update\", document)) {\n  return redirect(`/projects/${projectId}`)\n}\n```\n\n### Before (Mutation)\n\n```typescript\nimport { can } from \"@/permissions/rbac\"\nimport { canUpdateDocument } from \"@/permissions/documents\"\n\nconst user = await getCurrentUser()\nconst document = await getDocumentById(documentId)\nif (!canUpdateDocument(user, document)) {\n  throw new AuthorizationError()\n}\n```\n\n### After (Mutation)\n\n```typescript\nimport { getUserPermissions } from \"@/permissions/abac\"\n\nconst user = await getCurrentUser()\nconst permissions = getUserPermissions(user)\nconst document = await getDocumentById(documentId)\n\nif (!permissions.can(\"document\", \"update\", document)) {\n  throw new AuthorizationError()\n}\n```\n\n## What We Gain\n\n| Benefit                  | Description                                                  |\n| ------------------------ | ------------------------------------------------------------ |\n| **Unified API**          | One `can()` function for all checks                          |\n| **Declarative policies** | Conditions describe what's allowed                           |\n| **No helper functions**  | No more `canUpdateDocument`, `canReadProject`, etc.          |\n| **Type safety**          | TypeScript enforces valid resources, actions, and conditions |\n| **Composable**           | Easy to add new conditions without new permission strings    |\n\n## What We Delete\n\nWith ABAC in place, we can remove:\n\n- `src/permissions/rbac.ts` - The old RBAC module\n- `src/permissions/documents.ts` - The document helper functions\n- `src/permissions/projects.ts` - The project helper functions\n\nEverything is now in `src/permissions/abac.ts`.\n\n## Branch Checkpoint\n\nAfter completing this conversion, your code should match:\n\n```text\nBranch: 5-abac-basic\n```\n\nRun the following to sync up:\n\n```bash\ngit checkout 5-abac-basic\n```\n\n## What's Next\n\nThis basic ABAC system has the same functionality as our RBAC + helpers approach, just with cleaner architecture. In the next lesson, we'll add **advanced features** that ABAC makes possible—like field-level permissions and automatic query filtering.\n","slug":"converting-to-abac","title":"Converting to ABAC","section":"Attribute-Based Access Control (ABAC)","icon":"cog","filePath":"/home/runner/work/fem-permission-systems-that-scale/fem-permission-systems-that-scale/lessons/04-abac/B-converting-to-abac.md","nextSlug":"/fem-permission-systems-that-scale/lessons/abac/advanced-abac-features","prevSlug":"/fem-permission-systems-that-scale/lessons/abac/what-is-abac"}},"__N_SSG":true},"page":"/lessons/[section]/[slug]","query":{"section":"abac","slug":"converting-to-abac"},"buildId":"Z1s-VsOExbnNujkBZEKnx","assetPrefix":"/fem-permission-systems-that-scale","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>
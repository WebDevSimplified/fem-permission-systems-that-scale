<!DOCTYPE html><html><head><meta charSet="utf-8" data-next-head=""/><meta name="viewport" content="width=device-width" data-next-head=""/><link rel="apple-touch-icon" sizes="180x180" href="/fem-permission-systems-that-scale/images/apple-touch-icon.png" data-next-head=""/><link rel="icon" type="image/png" sizes="32x32" href="/fem-permission-systems-that-scale/images/favicon-32x32.png" data-next-head=""/><link rel="icon" type="image/png" sizes="16x16" href="/fem-permission-systems-that-scale/images/favicon-16x16.png" data-next-head=""/><link rel="icon" type="image/png" sizes="16x16" href="/fem-permission-systems-that-scale/images/favicon-16x16.png" data-next-head=""/><link rel="icon" type="image/x-icon" href="/fem-permission-systems-that-scale/images/favicon.ico" data-next-head=""/><title data-next-head="">Upgrading to CASL – Permission Systems that Scale</title><meta name="description" content="Learn how to implement robust permission systems in your web applications. Master RBAC, ABAC, field-level permissions, and build your own authorization engine from scratch using TypeScript." data-next-head=""/><meta name="keywords" content="Permissions,Authorization,RBAC,ABAC,Access Control,TypeScript,Security,CASL,Web Dev Simplified,Frontend Masters" data-next-head=""/><meta name="og:description" content="Learn how to implement robust permission systems in your web applications. Master RBAC, ABAC, field-level permissions, and build your own authorization engine from scratch using TypeScript." data-next-head=""/><meta name="og:title" content="Upgrading to CASL – Permission Systems that Scale" data-next-head=""/><meta name="og:image" content="/fem-permission-systems-that-scale/images/social-share-cover.jpg" data-next-head=""/><meta name="twitter:card" content="summary_large_image" data-next-head=""/><link data-next-font="size-adjust" rel="preconnect" href="/" crossorigin="anonymous"/><link rel="preload" href="/fem-permission-systems-that-scale/_next/static/css/3e2d260a483e4ce6.css" as="style"/><link rel="stylesheet" href="/fem-permission-systems-that-scale/_next/static/css/3e2d260a483e4ce6.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" noModule="" src="/fem-permission-systems-that-scale/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/fem-permission-systems-that-scale/_next/static/chunks/webpack-561d6b920ac5fc2e.js" defer=""></script><script src="/fem-permission-systems-that-scale/_next/static/chunks/framework-2f335d22a7318891.js" defer=""></script><script src="/fem-permission-systems-that-scale/_next/static/chunks/main-8377b0572add80b6.js" defer=""></script><script src="/fem-permission-systems-that-scale/_next/static/chunks/pages/_app-ab9f88be91011ccd.js" defer=""></script><script src="/fem-permission-systems-that-scale/_next/static/chunks/pages/lessons/%5Bsection%5D/%5Bslug%5D-c23b0a3ff434a742.js" defer=""></script><script src="/fem-permission-systems-that-scale/_next/static/Z1s-VsOExbnNujkBZEKnx/_buildManifest.js" defer=""></script><script src="/fem-permission-systems-that-scale/_next/static/Z1s-VsOExbnNujkBZEKnx/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="remix-app"><header class="navbar"><h1 class="navbar-brand"><a href="/fem-permission-systems-that-scale">Permission Systems that Scale</a></h1><div class="navbar-info"></div></header><div class="content-container"><div class="main"><div class="lesson-container"><div class="lesson"><div class="lesson-content"><p>Let&#39;s upgrade our custom ABAC implementation to use CASL.</p>
<h2>Installing CASL</h2>
<p>First, install the CASL packages:</p>
<pre><code class="hljs language-bash"><button class="copy-btn">Copy</button>npm install @casl/ability
</code></pre><h2>Updating the Permission Module</h2>
<h3>Key Changes</h3>
<p>Here&#39;s what changes when migrating to CASL:</p>
<pre><code class="hljs language-typescript"><button class="copy-btn">Copy</button><span class="hljs-comment">// BEFORE (custom): resource first, action second</span>
builder.<span class="hljs-title function_">can</span>(<span class="hljs-string">&quot;document&quot;</span>, <span class="hljs-string">&quot;read&quot;</span>)
builder.<span class="hljs-title function_">can</span>(<span class="hljs-string">&quot;document&quot;</span>, <span class="hljs-string">&quot;read&quot;</span>, { <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;published&quot;</span> }, [<span class="hljs-string">&quot;title&quot;</span>, <span class="hljs-string">&quot;content&quot;</span>])

<span class="hljs-comment">// AFTER (CASL): action first, resource second, fields before conditions</span>
<span class="hljs-title function_">can</span>(<span class="hljs-string">&quot;read&quot;</span>, <span class="hljs-string">&quot;document&quot;</span>)
<span class="hljs-title function_">can</span>(<span class="hljs-string">&quot;read&quot;</span>, <span class="hljs-string">&quot;document&quot;</span>, [<span class="hljs-string">&quot;title&quot;</span>, <span class="hljs-string">&quot;content&quot;</span>], { <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;published&quot;</span> })
</code></pre><h3>Type Setup</h3>
<p>CASL needs types to understand your resources which are broken down into subjects and actions:</p>
<pre><code class="hljs language-typescript"><button class="copy-btn">Copy</button><span class="hljs-keyword">type</span> <span class="hljs-title class_">FullCRUD</span> = <span class="hljs-string">&quot;create&quot;</span> | <span class="hljs-string">&quot;read&quot;</span> | <span class="hljs-string">&quot;update&quot;</span> | <span class="hljs-string">&quot;delete&quot;</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">ProjectSubject</span> = <span class="hljs-string">&quot;project&quot;</span> | <span class="hljs-title class_">Pick</span>&lt;<span class="hljs-title class_">Project</span>, <span class="hljs-string">&quot;department&quot;</span>&gt;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">DocumentSubject</span> =
  | <span class="hljs-string">&quot;document&quot;</span>
  | <span class="hljs-title class_">Pick</span>&lt;<span class="hljs-title class_">Document</span>, <span class="hljs-string">&quot;projectId&quot;</span> | <span class="hljs-string">&quot;creatorId&quot;</span> | <span class="hljs-string">&quot;status&quot;</span> | <span class="hljs-string">&quot;isLocked&quot;</span>&gt;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">MyAbility</span> = <span class="hljs-title class_">MongoAbility</span>&lt;
  [<span class="hljs-title class_">FullCRUD</span>, <span class="hljs-title class_">ProjectSubject</span>] | [<span class="hljs-title class_">FullCRUD</span>, <span class="hljs-title class_">DocumentSubject</span>]
&gt;
</code></pre><h3>Building Permissions</h3>
<pre><code class="hljs language-typescript"><button class="copy-btn">Copy</button><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserPermissionsInternal</span>(<span class="hljs-params"><span class="hljs-attr">user</span>: <span class="hljs-title class_">User</span></span>) {
  <span class="hljs-keyword">const</span> { <span class="hljs-attr">can</span>: allow, build } = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbilityBuilder</span>&lt;<span class="hljs-title class_">MyAbility</span>&gt;(
    createMongoAbility,
  )

  <span class="hljs-keyword">if</span> (user.<span class="hljs-property">role</span> === <span class="hljs-string">&quot;admin&quot;</span>) {
    <span class="hljs-title function_">allow</span>(<span class="hljs-string">&quot;read&quot;</span>, <span class="hljs-string">&quot;document&quot;</span>)
    <span class="hljs-title function_">allow</span>(<span class="hljs-string">&quot;read&quot;</span>, <span class="hljs-string">&quot;project&quot;</span>)
  }

  <span class="hljs-keyword">if</span> (user.<span class="hljs-property">role</span> === <span class="hljs-string">&quot;viewer&quot;</span>) {
    <span class="hljs-comment">// Fields come BEFORE conditions in CASL</span>
    <span class="hljs-title function_">allow</span>(<span class="hljs-string">&quot;read&quot;</span>, <span class="hljs-string">&quot;document&quot;</span>, [<span class="hljs-string">&quot;title&quot;</span>, <span class="hljs-string">&quot;content&quot;</span>], { <span class="hljs-attr">status</span>: <span class="hljs-string">&quot;published&quot;</span> })
  }

  <span class="hljs-keyword">return</span> <span class="hljs-title function_">build</span>()
}
</code></pre><h2>Using CASL in Components</h2>
<p>The usage pattern is almost identical, with one key difference:</p>
<pre><code class="hljs language-typescript"><button class="copy-btn">Copy</button><span class="hljs-comment">// Custom: pass object directly</span>
<span class="hljs-keyword">if</span> (permissions.<span class="hljs-title function_">can</span>(<span class="hljs-string">&quot;document&quot;</span>, <span class="hljs-string">&quot;update&quot;</span>, <span class="hljs-variable language_">document</span>)) {
  <span class="hljs-comment">// ...</span>
}

<span class="hljs-comment">// CASL: wrap object with subject() helper</span>
<span class="hljs-keyword">import</span> { subject } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@casl/ability&quot;</span>

<span class="hljs-keyword">if</span> (ability.<span class="hljs-title function_">can</span>(<span class="hljs-string">&quot;update&quot;</span>, <span class="hljs-title function_">subject</span>(<span class="hljs-string">&quot;document&quot;</span>, <span class="hljs-variable language_">document</span>))) {
  <span class="hljs-comment">// ...</span>
}
</code></pre><p>Note the differences:</p>
<ol>
<li>Resource and action order is swapped: <code>can(&quot;update&quot;, &quot;document&quot;)</code> vs <code>permissions.can(&quot;document&quot;, &quot;update&quot;)</code></li>
<li>Use <code>subject()</code> helper to wrap data for condition checking</li>
</ol>
<blockquote>
<p>Why the <code>subject()</code> wrapper? CASL needs to know what <em>type</em> of object you&#39;re checking. Our custom implementation knew because we passed the resource name first. CASL uses class names by default, but since we&#39;re using plain objects, we need to tell it explicitly.</p>
</blockquote>
<h2>Field-Level Permissions with CASL</h2>
<p>CASL has built-in support for field permissions:</p>
<pre><code class="hljs language-typescript"><button class="copy-btn">Copy</button><span class="hljs-comment">// Define which fields each permission applies to</span>
<span class="hljs-title function_">can</span>(<span class="hljs-string">&quot;update&quot;</span>, <span class="hljs-string">&quot;document&quot;</span>, [<span class="hljs-string">&quot;title&quot;</span>, <span class="hljs-string">&quot;content&quot;</span>, <span class="hljs-string">&quot;status&quot;</span>], { <span class="hljs-attr">isLocked</span>: <span class="hljs-literal">false</span> })

<span class="hljs-comment">// Check field permission</span>
ability.<span class="hljs-title function_">can</span>(<span class="hljs-string">&quot;update&quot;</span>, <span class="hljs-title function_">subject</span>(<span class="hljs-string">&quot;document&quot;</span>, <span class="hljs-variable language_">document</span>), <span class="hljs-string">&quot;status&quot;</span>)
</code></pre><h2>CASL Bonus Features</h2>
<h3>1. Rule Serialization</h3>
<p>You can serialize CASL permissions to JSON and send them to the client:</p>
<pre><code class="hljs language-typescript"><button class="copy-btn">Copy</button><span class="hljs-comment">// Server: send ability rules to the client</span>
<span class="hljs-keyword">const</span> permissions = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getUserPermissions</span>()
<span class="hljs-keyword">const</span> rules = permissions.<span class="hljs-property">rules</span>

<span class="hljs-comment">// Client: recreate ability from rules</span>
<span class="hljs-keyword">import</span> { createMongoAbility } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@casl/ability&quot;</span>
<span class="hljs-keyword">const</span> clientPermissions = <span class="hljs-title function_">createMongoAbility</span>(rules)
</code></pre><p>This enables client-side permission checks without an API call.</p>
<h3>2. Advanced Conditions</h3>
<p>CASL supports MongoDB-style query operators:</p>
<pre><code class="hljs language-typescript"><button class="copy-btn">Copy</button><span class="hljs-title function_">can</span>(<span class="hljs-string">&quot;read&quot;</span>, <span class="hljs-string">&quot;document&quot;</span>, { <span class="hljs-attr">status</span>: { <span class="hljs-attr">$ne</span>: <span class="hljs-string">&quot;archived&quot;</span> } }) <span class="hljs-comment">// not equal</span>
<span class="hljs-title function_">can</span>(<span class="hljs-string">&quot;read&quot;</span>, <span class="hljs-string">&quot;document&quot;</span>, { <span class="hljs-attr">status</span>: { <span class="hljs-attr">$in</span>: [<span class="hljs-string">&quot;published&quot;</span>, <span class="hljs-string">&quot;draft&quot;</span>] } }) <span class="hljs-comment">// in array</span>
</code></pre><h2>CASL Drawbacks</h2>
<p>CASL is great at many things, but since it was created as a backend Node focused project it struggles when used with frontend frameworks like React or Next.js due to its reliance on classes.</p>
<h3>1. Reliance on Classes</h3>
<p>CASL uses class names to determine which permissions to check on an object. Since we&#39;re using plain objects (not class instances), permissions don&#39;t work by default which is why we need the <code>subject()</code> wrapper everywhere.</p>
<h3>2. React Server Component Compatibility</h3>
<p>The <code>subject()</code> function unfortunately, mutates our objects in a way that is incompatible with React Server components. There are two workarounds:</p>
<p><strong>Option A: Spread into a new object</strong></p>
<pre><code class="hljs language-typescript"><button class="copy-btn">Copy</button><span class="hljs-comment">// Always create a new object before passing to subject()</span>
ability.<span class="hljs-title function_">can</span>(<span class="hljs-string">&quot;update&quot;</span>, <span class="hljs-title function_">subject</span>(<span class="hljs-string">&quot;document&quot;</span>, { ...<span class="hljs-variable language_">document</span> }))
</code></pre><p><strong>Option B: Use <code>detectSubjectType</code></strong></p>
<p>Configure CASL to detect subject types without mutation:</p>
<pre><code class="hljs language-typescript"><button class="copy-btn">Copy</button><span class="hljs-keyword">const</span> ability = <span class="hljs-title function_">createMongoAbility</span>(rules, {
  <span class="hljs-attr">detectSubjectType</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-built_in">object</span></span>) =&gt;</span> {
    <span class="hljs-comment">// Check for a type property we add ourselves</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">object</span> &amp;&amp; <span class="hljs-keyword">typeof</span> <span class="hljs-built_in">object</span> === <span class="hljs-string">&quot;object&quot;</span> &amp;&amp; <span class="hljs-string">&quot;__typename&quot;</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">object</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">object</span>.<span class="hljs-property">__typename</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>
  },
})

<span class="hljs-comment">// In your queries, add __typename to returned objects</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable language_">document</span> = <span class="hljs-keyword">await</span> db.<span class="hljs-property">query</span>.<span class="hljs-property">documents</span>.<span class="hljs-title function_">findFirst</span>({
  <span class="hljs-attr">where</span>: <span class="hljs-title function_">eq</span>(documents.<span class="hljs-property">id</span>, id),
})

<span class="hljs-keyword">return</span> { ...<span class="hljs-variable language_">document</span>, <span class="hljs-attr">__typename</span>: <span class="hljs-string">&quot;document&quot;</span> <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span> }
</code></pre><p>This approach adds a small overhead but makes consuming CASL permissions easier.</p>
<h2>Branch Checkpoint</h2>
<p>After completing this lesson, your code should match:</p>
<pre><code class="hljs language-bash"><button class="copy-btn">Copy</button>git checkout 7-casl
</code></pre><h2>Summary</h2>
<p>Migrating to CASL gives us:</p>
<ul>
<li>✅ Battle-tested permission library</li>
<li>✅ Built-in field-level permissions</li>
<li>✅ Community support and documentation</li>
</ul>
<p>The concepts are identical to what we built, but using a library like CASL can give you extra functionality and make it easier to work with on a larger team.</p>
</div><div class="lesson-links"><a href="/fem-permission-systems-that-scale/lessons/permission-libraries/why-use-a-library" class="prev">← Previous</a><a href="/fem-permission-systems-that-scale/lessons/rebac/what-is-rebac" class="next">Next →</a></div></div><div class="details-bg"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="154" height="154" viewBox="0 0 154 154"><defs><clipPath id="clip-path"><rect id="Rectangle_2238" data-name="Rectangle 2238" width="154" height="154" transform="translate(9467 350)" fill="#fff" stroke="#707070" stroke-width="1"></rect></clipPath><clipPath id="clip-corner-image-active"><rect width="154" height="154"></rect></clipPath></defs><g id="corner-image-active" clip-path="url(#clip-corner-image-active)"><g id="Corner-image-active-2" data-name="Corner-image-active" transform="translate(-9467 -350)" clip-path="url(#clip-path)"><path id="Subtraction_34" data-name="Subtraction 34" d="M-3857.365,1740.766h0l-7.07-7.07,12.89-12.89v14.142l-5.818,5.818Zm-14.142-14.142h0l-7.071-7.07,27.033-27.033v14.143l-19.96,19.96Zm-14.143-14.143h0l-7.07-7.069,41.175-41.175v14.142Zm-14.142-14.142h0l-7.07-7.069,55.317-55.317v14.142Zm-14.142-14.142h0l-7.07-7.069,69.459-69.459v14.142Zm-14.142-14.142h0l-7.07-7.069,76.739-76.739h6.862v7.28Zm-14.143-14.143h0l-7.07-7.069,62.6-62.6h14.142Zm-14.142-14.142h0l-7.07-7.069,48.454-48.454h14.142Zm-14.142-14.142h0l-7.07-7.069,34.312-34.312h14.142Zm-14.142-14.142h0l-7.07-7.069,20.17-20.17h14.142Zm-14.142-14.142h0l-7.071-7.071,6.027-6.027h14.144l-13.1,13.1Zm367.24-56.114v-.909l.455.455-.453.453Z" transform="translate(13472.546 -1236.766)" fill="var(--corner-fill)"></path></g></g></svg></div></div></div></div><footer class="footer"><ul class="socials"><li class="social"><a href="https://twitter.com/DevSimplified"><svg fill="none" height="100%" width="32" xmlns="http://www.w3.org/2000/svg" viewBox="0.254 0.25 500 451.95400000000006"><path d="M394.033.25h76.67L303.202 191.693l197.052 260.511h-154.29L225.118 294.205 86.844 452.204H10.127l179.16-204.77L.254.25H158.46l109.234 144.417zm-26.908 406.063h42.483L135.377 43.73h-45.59z" fill="var(--footer-icons)"></path></svg></a></li><li class="social"><a href="https://github.com/WebDevSimplified"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32" height="32" viewBox="0 0 32 32"><defs><clipPath id="clip-github-social"><rect width="32" height="32"></rect></clipPath></defs><g id="github-social" clip-path="url(#clip-github-social)"><g id="Group_272" data-name="Group 272" transform="translate(13522.5 -6994)"><path id="Subtraction_33" data-name="Subtraction 33" d="M-24967.5,8041a15.9,15.9,0,0,1-11.312-4.688A15.893,15.893,0,0,1-24983.5,8025a15.893,15.893,0,0,1,4.689-11.315A15.894,15.894,0,0,1-24967.5,8009a15.894,15.894,0,0,1,11.313,4.686A15.893,15.893,0,0,1-24951.5,8025a15.893,15.893,0,0,1-4.689,11.313A15.9,15.9,0,0,1-24967.5,8041Zm-3.781-4.571h0v3.918h7.895v-6.665a1.836,1.836,0,0,0-1.2-1.718c5.1-.617,7.467-2.975,7.467-7.424a7.176,7.176,0,0,0-1.637-4.728,6.74,6.74,0,0,0,.275-1.812,4.34,4.34,0,0,0-.52-2.452.574.574,0,0,0-.359-.1c-1.061,0-3.465,1.411-3.936,1.694a16.644,16.644,0,0,0-4.2-.489,16.379,16.379,0,0,0-3.969.445c-.846-.5-2.91-1.649-3.859-1.649a.566.566,0,0,0-.354.095,4.3,4.3,0,0,0-.521,2.452,6.7,6.7,0,0,0,.244,1.718,7.346,7.346,0,0,0-1.6,4.822,7.263,7.263,0,0,0,1.533,4.985c1.193,1.359,3.115,2.165,5.871,2.464a1.826,1.826,0,0,0-1.129,1.693v.5h0l-.006,0a7.121,7.121,0,0,1-2.033.363,2.608,2.608,0,0,1-.965-.158,4.438,4.438,0,0,1-1.836-1.881,2.361,2.361,0,0,0-1.248-1.091,3.472,3.472,0,0,0-1.217-.3.584.584,0,0,0-.545.224.282.282,0,0,0,.027.367,1.875,1.875,0,0,0,.447.307,4.732,4.732,0,0,1,.561.355,10.726,10.726,0,0,1,1.682,2.755c.043.092.078.163.105.217a3.876,3.876,0,0,0,2.42,1.185,6.036,6.036,0,0,0,.607.025c.875,0,1.988-.124,2-.125Z" transform="translate(11461 -1015)" fill="var(--footer-icons)"></path><g id="Ellipse_670" data-name="Ellipse 670" transform="translate(-13522.5 6994)" fill="none" stroke="var(--footer-icons)" stroke-width="1"><circle cx="16" cy="16" r="16" stroke="none"></circle><circle cx="16" cy="16" r="15.5" fill="none"></circle></g></g></g></svg></a></li><li class="social"><div class="terms"><p>Content Licensed Under CC-BY-NC-4.0</p><p>Code Samples and Exercises Licensed Under Apache 2.0</p><p>Site Designed by<!-- --> <a href="https://www.alexdanielson.com/">Alex Danielson</a></p></div></li></ul><div class="theme-icons"><button aria-label="Activate dark mode" title="Activate dark mode" class="theme-toggle"><svg xmlns="http://www.w3.org/2000/svg" width="36px" height="100%" viewBox="0 -960 960 960" fill="var(--text-footer)" role="img"><title>Dark Mode Icon</title><path d="M480-120q-150 0-255-105T120-480q0-150 105-255t255-105q14 0 27.5 1t26.5 3q-41 29-65.5 75.5T444-660q0 90 63 153t153 63q55 0 101-24.5t75-65.5q2 13 3 26.5t1 27.5q0 150-105 255T480-120Zm0-80q88 0 158-48.5T740-375q-20 5-40 8t-40 3q-123 0-209.5-86.5T364-660q0-20 3-40t8-40q-78 32-126.5 102T200-480q0 116 82 198t198 82Z"></path></svg></button></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"attributes":{"title":"Upgrading to CASL"},"html":"\u003cp\u003eLet\u0026#39;s upgrade our custom ABAC implementation to use CASL.\u003c/p\u003e\n\u003ch2\u003eInstalling CASL\u003c/h2\u003e\n\u003cp\u003eFirst, install the CASL packages:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e\u003cbutton class=\"copy-btn\"\u003eCopy\u003c/button\u003enpm install @casl/ability\n\u003c/code\u003e\u003c/pre\u003e\u003ch2\u003eUpdating the Permission Module\u003c/h2\u003e\n\u003ch3\u003eKey Changes\u003c/h3\u003e\n\u003cp\u003eHere\u0026#39;s what changes when migrating to CASL:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cbutton class=\"copy-btn\"\u003eCopy\u003c/button\u003e\u003cspan class=\"hljs-comment\"\u003e// BEFORE (custom): resource first, action second\u003c/span\u003e\nbuilder.\u003cspan class=\"hljs-title function_\"\u003ecan\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;document\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;read\u0026quot;\u003c/span\u003e)\nbuilder.\u003cspan class=\"hljs-title function_\"\u003ecan\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;document\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;read\u0026quot;\u003c/span\u003e, { \u003cspan class=\"hljs-attr\"\u003estatus\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;published\u0026quot;\u003c/span\u003e }, [\u003cspan class=\"hljs-string\"\u003e\u0026quot;title\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;content\u0026quot;\u003c/span\u003e])\n\n\u003cspan class=\"hljs-comment\"\u003e// AFTER (CASL): action first, resource second, fields before conditions\u003c/span\u003e\n\u003cspan class=\"hljs-title function_\"\u003ecan\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;read\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;document\u0026quot;\u003c/span\u003e)\n\u003cspan class=\"hljs-title function_\"\u003ecan\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;read\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;document\u0026quot;\u003c/span\u003e, [\u003cspan class=\"hljs-string\"\u003e\u0026quot;title\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;content\u0026quot;\u003c/span\u003e], { \u003cspan class=\"hljs-attr\"\u003estatus\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;published\u0026quot;\u003c/span\u003e })\n\u003c/code\u003e\u003c/pre\u003e\u003ch3\u003eType Setup\u003c/h3\u003e\n\u003cp\u003eCASL needs types to understand your resources which are broken down into subjects and actions:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cbutton class=\"copy-btn\"\u003eCopy\u003c/button\u003e\u003cspan class=\"hljs-keyword\"\u003etype\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eFullCRUD\u003c/span\u003e = \u003cspan class=\"hljs-string\"\u003e\u0026quot;create\u0026quot;\u003c/span\u003e | \u003cspan class=\"hljs-string\"\u003e\u0026quot;read\u0026quot;\u003c/span\u003e | \u003cspan class=\"hljs-string\"\u003e\u0026quot;update\u0026quot;\u003c/span\u003e | \u003cspan class=\"hljs-string\"\u003e\u0026quot;delete\u0026quot;\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003etype\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eProjectSubject\u003c/span\u003e = \u003cspan class=\"hljs-string\"\u003e\u0026quot;project\u0026quot;\u003c/span\u003e | \u003cspan class=\"hljs-title class_\"\u003ePick\u003c/span\u003e\u0026lt;\u003cspan class=\"hljs-title class_\"\u003eProject\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;department\u0026quot;\u003c/span\u003e\u0026gt;\n\u003cspan class=\"hljs-keyword\"\u003etype\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eDocumentSubject\u003c/span\u003e =\n  | \u003cspan class=\"hljs-string\"\u003e\u0026quot;document\u0026quot;\u003c/span\u003e\n  | \u003cspan class=\"hljs-title class_\"\u003ePick\u003c/span\u003e\u0026lt;\u003cspan class=\"hljs-title class_\"\u003eDocument\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;projectId\u0026quot;\u003c/span\u003e | \u003cspan class=\"hljs-string\"\u003e\u0026quot;creatorId\u0026quot;\u003c/span\u003e | \u003cspan class=\"hljs-string\"\u003e\u0026quot;status\u0026quot;\u003c/span\u003e | \u003cspan class=\"hljs-string\"\u003e\u0026quot;isLocked\u0026quot;\u003c/span\u003e\u0026gt;\n\n\u003cspan class=\"hljs-keyword\"\u003etype\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eMyAbility\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eMongoAbility\u003c/span\u003e\u0026lt;\n  [\u003cspan class=\"hljs-title class_\"\u003eFullCRUD\u003c/span\u003e, \u003cspan class=\"hljs-title class_\"\u003eProjectSubject\u003c/span\u003e] | [\u003cspan class=\"hljs-title class_\"\u003eFullCRUD\u003c/span\u003e, \u003cspan class=\"hljs-title class_\"\u003eDocumentSubject\u003c/span\u003e]\n\u0026gt;\n\u003c/code\u003e\u003c/pre\u003e\u003ch3\u003eBuilding Permissions\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cbutton class=\"copy-btn\"\u003eCopy\u003c/button\u003e\u003cspan class=\"hljs-keyword\"\u003easync\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003egetUserPermissionsInternal\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003cspan class=\"hljs-attr\"\u003euser\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eUser\u003c/span\u003e\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e { \u003cspan class=\"hljs-attr\"\u003ecan\u003c/span\u003e: allow, build } = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eAbilityBuilder\u003c/span\u003e\u0026lt;\u003cspan class=\"hljs-title class_\"\u003eMyAbility\u003c/span\u003e\u0026gt;(\n    createMongoAbility,\n  )\n\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (user.\u003cspan class=\"hljs-property\"\u003erole\u003c/span\u003e === \u003cspan class=\"hljs-string\"\u003e\u0026quot;admin\u0026quot;\u003c/span\u003e) {\n    \u003cspan class=\"hljs-title function_\"\u003eallow\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;read\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;document\u0026quot;\u003c/span\u003e)\n    \u003cspan class=\"hljs-title function_\"\u003eallow\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;read\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;project\u0026quot;\u003c/span\u003e)\n  }\n\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (user.\u003cspan class=\"hljs-property\"\u003erole\u003c/span\u003e === \u003cspan class=\"hljs-string\"\u003e\u0026quot;viewer\u0026quot;\u003c/span\u003e) {\n    \u003cspan class=\"hljs-comment\"\u003e// Fields come BEFORE conditions in CASL\u003c/span\u003e\n    \u003cspan class=\"hljs-title function_\"\u003eallow\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;read\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;document\u0026quot;\u003c/span\u003e, [\u003cspan class=\"hljs-string\"\u003e\u0026quot;title\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;content\u0026quot;\u003c/span\u003e], { \u003cspan class=\"hljs-attr\"\u003estatus\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;published\u0026quot;\u003c/span\u003e })\n  }\n\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ebuild\u003c/span\u003e()\n}\n\u003c/code\u003e\u003c/pre\u003e\u003ch2\u003eUsing CASL in Components\u003c/h2\u003e\n\u003cp\u003eThe usage pattern is almost identical, with one key difference:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cbutton class=\"copy-btn\"\u003eCopy\u003c/button\u003e\u003cspan class=\"hljs-comment\"\u003e// Custom: pass object directly\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (permissions.\u003cspan class=\"hljs-title function_\"\u003ecan\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;document\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;update\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e)) {\n  \u003cspan class=\"hljs-comment\"\u003e// ...\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-comment\"\u003e// CASL: wrap object with subject() helper\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e { subject } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;@casl/ability\u0026quot;\u003c/span\u003e\n\n\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (ability.\u003cspan class=\"hljs-title function_\"\u003ecan\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;update\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-title function_\"\u003esubject\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;document\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e))) {\n  \u003cspan class=\"hljs-comment\"\u003e// ...\u003c/span\u003e\n}\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eNote the differences:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eResource and action order is swapped: \u003ccode\u003ecan(\u0026quot;update\u0026quot;, \u0026quot;document\u0026quot;)\u003c/code\u003e vs \u003ccode\u003epermissions.can(\u0026quot;document\u0026quot;, \u0026quot;update\u0026quot;)\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eUse \u003ccode\u003esubject()\u003c/code\u003e helper to wrap data for condition checking\u003c/li\u003e\n\u003c/ol\u003e\n\u003cblockquote\u003e\n\u003cp\u003eWhy the \u003ccode\u003esubject()\u003c/code\u003e wrapper? CASL needs to know what \u003cem\u003etype\u003c/em\u003e of object you\u0026#39;re checking. Our custom implementation knew because we passed the resource name first. CASL uses class names by default, but since we\u0026#39;re using plain objects, we need to tell it explicitly.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch2\u003eField-Level Permissions with CASL\u003c/h2\u003e\n\u003cp\u003eCASL has built-in support for field permissions:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cbutton class=\"copy-btn\"\u003eCopy\u003c/button\u003e\u003cspan class=\"hljs-comment\"\u003e// Define which fields each permission applies to\u003c/span\u003e\n\u003cspan class=\"hljs-title function_\"\u003ecan\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;update\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;document\u0026quot;\u003c/span\u003e, [\u003cspan class=\"hljs-string\"\u003e\u0026quot;title\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;content\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;status\u0026quot;\u003c/span\u003e], { \u003cspan class=\"hljs-attr\"\u003eisLocked\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e })\n\n\u003cspan class=\"hljs-comment\"\u003e// Check field permission\u003c/span\u003e\nability.\u003cspan class=\"hljs-title function_\"\u003ecan\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;update\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-title function_\"\u003esubject\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;document\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e), \u003cspan class=\"hljs-string\"\u003e\u0026quot;status\u0026quot;\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003ch2\u003eCASL Bonus Features\u003c/h2\u003e\n\u003ch3\u003e1. Rule Serialization\u003c/h3\u003e\n\u003cp\u003eYou can serialize CASL permissions to JSON and send them to the client:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cbutton class=\"copy-btn\"\u003eCopy\u003c/button\u003e\u003cspan class=\"hljs-comment\"\u003e// Server: send ability rules to the client\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e permissions = \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003egetUserPermissions\u003c/span\u003e()\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e rules = permissions.\u003cspan class=\"hljs-property\"\u003erules\u003c/span\u003e\n\n\u003cspan class=\"hljs-comment\"\u003e// Client: recreate ability from rules\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e { createMongoAbility } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;@casl/ability\u0026quot;\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e clientPermissions = \u003cspan class=\"hljs-title function_\"\u003ecreateMongoAbility\u003c/span\u003e(rules)\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eThis enables client-side permission checks without an API call.\u003c/p\u003e\n\u003ch3\u003e2. Advanced Conditions\u003c/h3\u003e\n\u003cp\u003eCASL supports MongoDB-style query operators:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cbutton class=\"copy-btn\"\u003eCopy\u003c/button\u003e\u003cspan class=\"hljs-title function_\"\u003ecan\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;read\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;document\u0026quot;\u003c/span\u003e, { \u003cspan class=\"hljs-attr\"\u003estatus\u003c/span\u003e: { \u003cspan class=\"hljs-attr\"\u003e$ne\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;archived\u0026quot;\u003c/span\u003e } }) \u003cspan class=\"hljs-comment\"\u003e// not equal\u003c/span\u003e\n\u003cspan class=\"hljs-title function_\"\u003ecan\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;read\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;document\u0026quot;\u003c/span\u003e, { \u003cspan class=\"hljs-attr\"\u003estatus\u003c/span\u003e: { \u003cspan class=\"hljs-attr\"\u003e$in\u003c/span\u003e: [\u003cspan class=\"hljs-string\"\u003e\u0026quot;published\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;draft\u0026quot;\u003c/span\u003e] } }) \u003cspan class=\"hljs-comment\"\u003e// in array\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003ch2\u003eCASL Drawbacks\u003c/h2\u003e\n\u003cp\u003eCASL is great at many things, but since it was created as a backend Node focused project it struggles when used with frontend frameworks like React or Next.js due to its reliance on classes.\u003c/p\u003e\n\u003ch3\u003e1. Reliance on Classes\u003c/h3\u003e\n\u003cp\u003eCASL uses class names to determine which permissions to check on an object. Since we\u0026#39;re using plain objects (not class instances), permissions don\u0026#39;t work by default which is why we need the \u003ccode\u003esubject()\u003c/code\u003e wrapper everywhere.\u003c/p\u003e\n\u003ch3\u003e2. React Server Component Compatibility\u003c/h3\u003e\n\u003cp\u003eThe \u003ccode\u003esubject()\u003c/code\u003e function unfortunately, mutates our objects in a way that is incompatible with React Server components. There are two workarounds:\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eOption A: Spread into a new object\u003c/strong\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cbutton class=\"copy-btn\"\u003eCopy\u003c/button\u003e\u003cspan class=\"hljs-comment\"\u003e// Always create a new object before passing to subject()\u003c/span\u003e\nability.\u003cspan class=\"hljs-title function_\"\u003ecan\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;update\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-title function_\"\u003esubject\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;document\u0026quot;\u003c/span\u003e, { ...\u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e }))\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cstrong\u003eOption B: Use \u003ccode\u003edetectSubjectType\u003c/code\u003e\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eConfigure CASL to detect subject types without mutation:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cbutton class=\"copy-btn\"\u003eCopy\u003c/button\u003e\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e ability = \u003cspan class=\"hljs-title function_\"\u003ecreateMongoAbility\u003c/span\u003e(rules, {\n  \u003cspan class=\"hljs-attr\"\u003edetectSubjectType\u003c/span\u003e: \u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003e\u003cspan class=\"hljs-built_in\"\u003eobject\u003c/span\u003e\u003c/span\u003e) =\u0026gt;\u003c/span\u003e {\n    \u003cspan class=\"hljs-comment\"\u003e// Check for a type property we add ourselves\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"hljs-built_in\"\u003eobject\u003c/span\u003e \u0026amp;\u0026amp; \u003cspan class=\"hljs-keyword\"\u003etypeof\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003eobject\u003c/span\u003e === \u003cspan class=\"hljs-string\"\u003e\u0026quot;object\u0026quot;\u003c/span\u003e \u0026amp;\u0026amp; \u003cspan class=\"hljs-string\"\u003e\u0026quot;__typename\u0026quot;\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003eobject\u003c/span\u003e) {\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003eobject\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003e__typename\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eas\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003estring\u003c/span\u003e\n    }\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003eundefined\u003c/span\u003e\n  },\n})\n\n\u003cspan class=\"hljs-comment\"\u003e// In your queries, add __typename to returned objects\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e = \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e db.\u003cspan class=\"hljs-property\"\u003equery\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003edocuments\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003efindFirst\u003c/span\u003e({\n  \u003cspan class=\"hljs-attr\"\u003ewhere\u003c/span\u003e: \u003cspan class=\"hljs-title function_\"\u003eeq\u003c/span\u003e(documents.\u003cspan class=\"hljs-property\"\u003eid\u003c/span\u003e, id),\n})\n\n\u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e { ...\u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e, \u003cspan class=\"hljs-attr\"\u003e__typename\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;document\u0026quot;\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eas\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e }\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eThis approach adds a small overhead but makes consuming CASL permissions easier.\u003c/p\u003e\n\u003ch2\u003eBranch Checkpoint\u003c/h2\u003e\n\u003cp\u003eAfter completing this lesson, your code should match:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e\u003cbutton class=\"copy-btn\"\u003eCopy\u003c/button\u003egit checkout 7-casl\n\u003c/code\u003e\u003c/pre\u003e\u003ch2\u003eSummary\u003c/h2\u003e\n\u003cp\u003eMigrating to CASL gives us:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e✅ Battle-tested permission library\u003c/li\u003e\n\u003cli\u003e✅ Built-in field-level permissions\u003c/li\u003e\n\u003cli\u003e✅ Community support and documentation\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThe concepts are identical to what we built, but using a library like CASL can give you extra functionality and make it easier to work with on a larger team.\u003c/p\u003e\n","markdown":"\nLet's upgrade our custom ABAC implementation to use CASL.\n\n## Installing CASL\n\nFirst, install the CASL packages:\n\n```bash\nnpm install @casl/ability\n```\n\n## Updating the Permission Module\n\n### Key Changes\n\nHere's what changes when migrating to CASL:\n\n```typescript\n// BEFORE (custom): resource first, action second\nbuilder.can(\"document\", \"read\")\nbuilder.can(\"document\", \"read\", { status: \"published\" }, [\"title\", \"content\"])\n\n// AFTER (CASL): action first, resource second, fields before conditions\ncan(\"read\", \"document\")\ncan(\"read\", \"document\", [\"title\", \"content\"], { status: \"published\" })\n```\n\n### Type Setup\n\nCASL needs types to understand your resources which are broken down into subjects and actions:\n\n```typescript\ntype FullCRUD = \"create\" | \"read\" | \"update\" | \"delete\"\ntype ProjectSubject = \"project\" | Pick\u003cProject, \"department\"\u003e\ntype DocumentSubject =\n  | \"document\"\n  | Pick\u003cDocument, \"projectId\" | \"creatorId\" | \"status\" | \"isLocked\"\u003e\n\ntype MyAbility = MongoAbility\u003c\n  [FullCRUD, ProjectSubject] | [FullCRUD, DocumentSubject]\n\u003e\n```\n\n### Building Permissions\n\n```typescript\nasync function getUserPermissionsInternal(user: User) {\n  const { can: allow, build } = new AbilityBuilder\u003cMyAbility\u003e(\n    createMongoAbility,\n  )\n\n  if (user.role === \"admin\") {\n    allow(\"read\", \"document\")\n    allow(\"read\", \"project\")\n  }\n\n  if (user.role === \"viewer\") {\n    // Fields come BEFORE conditions in CASL\n    allow(\"read\", \"document\", [\"title\", \"content\"], { status: \"published\" })\n  }\n\n  return build()\n}\n```\n\n## Using CASL in Components\n\nThe usage pattern is almost identical, with one key difference:\n\n```typescript\n// Custom: pass object directly\nif (permissions.can(\"document\", \"update\", document)) {\n  // ...\n}\n\n// CASL: wrap object with subject() helper\nimport { subject } from \"@casl/ability\"\n\nif (ability.can(\"update\", subject(\"document\", document))) {\n  // ...\n}\n```\n\nNote the differences:\n\n1. Resource and action order is swapped: `can(\"update\", \"document\")` vs `permissions.can(\"document\", \"update\")`\n2. Use `subject()` helper to wrap data for condition checking\n\n\u003e Why the `subject()` wrapper? CASL needs to know what _type_ of object you're checking. Our custom implementation knew because we passed the resource name first. CASL uses class names by default, but since we're using plain objects, we need to tell it explicitly.\n\n## Field-Level Permissions with CASL\n\nCASL has built-in support for field permissions:\n\n```typescript\n// Define which fields each permission applies to\ncan(\"update\", \"document\", [\"title\", \"content\", \"status\"], { isLocked: false })\n\n// Check field permission\nability.can(\"update\", subject(\"document\", document), \"status\")\n```\n\n## CASL Bonus Features\n\n### 1. Rule Serialization\n\nYou can serialize CASL permissions to JSON and send them to the client:\n\n```typescript\n// Server: send ability rules to the client\nconst permissions = await getUserPermissions()\nconst rules = permissions.rules\n\n// Client: recreate ability from rules\nimport { createMongoAbility } from \"@casl/ability\"\nconst clientPermissions = createMongoAbility(rules)\n```\n\nThis enables client-side permission checks without an API call.\n\n### 2. Advanced Conditions\n\nCASL supports MongoDB-style query operators:\n\n```typescript\ncan(\"read\", \"document\", { status: { $ne: \"archived\" } }) // not equal\ncan(\"read\", \"document\", { status: { $in: [\"published\", \"draft\"] } }) // in array\n```\n\n## CASL Drawbacks\n\nCASL is great at many things, but since it was created as a backend Node focused project it struggles when used with frontend frameworks like React or Next.js due to its reliance on classes.\n\n### 1. Reliance on Classes\n\nCASL uses class names to determine which permissions to check on an object. Since we're using plain objects (not class instances), permissions don't work by default which is why we need the `subject()` wrapper everywhere.\n\n### 2. React Server Component Compatibility\n\nThe `subject()` function unfortunately, mutates our objects in a way that is incompatible with React Server components. There are two workarounds:\n\n**Option A: Spread into a new object**\n\n```typescript\n// Always create a new object before passing to subject()\nability.can(\"update\", subject(\"document\", { ...document }))\n```\n\n**Option B: Use `detectSubjectType`**\n\nConfigure CASL to detect subject types without mutation:\n\n```typescript\nconst ability = createMongoAbility(rules, {\n  detectSubjectType: (object) =\u003e {\n    // Check for a type property we add ourselves\n    if (object \u0026\u0026 typeof object === \"object\" \u0026\u0026 \"__typename\" in object) {\n      return object.__typename as string\n    }\n    return undefined\n  },\n})\n\n// In your queries, add __typename to returned objects\nconst document = await db.query.documents.findFirst({\n  where: eq(documents.id, id),\n})\n\nreturn { ...document, __typename: \"document\" as const }\n```\n\nThis approach adds a small overhead but makes consuming CASL permissions easier.\n\n## Branch Checkpoint\n\nAfter completing this lesson, your code should match:\n\n```bash\ngit checkout 7-casl\n```\n\n## Summary\n\nMigrating to CASL gives us:\n\n- ✅ Battle-tested permission library\n- ✅ Built-in field-level permissions\n- ✅ Community support and documentation\n\nThe concepts are identical to what we built, but using a library like CASL can give you extra functionality and make it easier to work with on a larger team.\n","slug":"upgrading-to-casl","title":"Upgrading to CASL","section":"Permission Libraries","icon":"cubes","filePath":"/home/runner/work/fem-permission-systems-that-scale/fem-permission-systems-that-scale/lessons/05-permission-libraries/B-upgrading-to-casl.md","nextSlug":"/fem-permission-systems-that-scale/lessons/rebac/what-is-rebac","prevSlug":"/fem-permission-systems-that-scale/lessons/permission-libraries/why-use-a-library"}},"__N_SSG":true},"page":"/lessons/[section]/[slug]","query":{"section":"permission-libraries","slug":"upgrading-to-casl"},"buildId":"Z1s-VsOExbnNujkBZEKnx","assetPrefix":"/fem-permission-systems-that-scale","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>
<!DOCTYPE html><html><head><meta charSet="utf-8" data-next-head=""/><meta name="viewport" content="width=device-width" data-next-head=""/><link rel="apple-touch-icon" sizes="180x180" href="/fem-permission-systems-that-scale/images/apple-touch-icon.png" data-next-head=""/><link rel="icon" type="image/png" sizes="32x32" href="/fem-permission-systems-that-scale/images/favicon-32x32.png" data-next-head=""/><link rel="icon" type="image/png" sizes="16x16" href="/fem-permission-systems-that-scale/images/favicon-16x16.png" data-next-head=""/><link rel="icon" type="image/png" sizes="16x16" href="/fem-permission-systems-that-scale/images/favicon-16x16.png" data-next-head=""/><link rel="icon" type="image/x-icon" href="/fem-permission-systems-that-scale/images/favicon.ico" data-next-head=""/><title data-next-head="">Converting to RBAC ‚Äì Permission Systems that Scale</title><meta name="description" content="Learn how to implement robust permission systems in your web applications. Master RBAC, ABAC, field-level permissions, and build your own authorization engine from scratch using TypeScript." data-next-head=""/><meta name="keywords" content="Permissions,Authorization,RBAC,ABAC,Access Control,TypeScript,Security,CASL,Web Dev Simplified,Frontend Masters" data-next-head=""/><meta name="og:description" content="Learn how to implement robust permission systems in your web applications. Master RBAC, ABAC, field-level permissions, and build your own authorization engine from scratch using TypeScript." data-next-head=""/><meta name="og:title" content="Converting to RBAC ‚Äì Permission Systems that Scale" data-next-head=""/><meta name="og:image" content="/fem-permission-systems-that-scale/images/social-share-cover.jpg" data-next-head=""/><meta name="twitter:card" content="summary_large_image" data-next-head=""/><link data-next-font="size-adjust" rel="preconnect" href="/" crossorigin="anonymous"/><link rel="preload" href="/fem-permission-systems-that-scale/_next/static/css/3e2d260a483e4ce6.css" as="style"/><link rel="stylesheet" href="/fem-permission-systems-that-scale/_next/static/css/3e2d260a483e4ce6.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" noModule="" src="/fem-permission-systems-that-scale/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/fem-permission-systems-that-scale/_next/static/chunks/webpack-561d6b920ac5fc2e.js" defer=""></script><script src="/fem-permission-systems-that-scale/_next/static/chunks/framework-2f335d22a7318891.js" defer=""></script><script src="/fem-permission-systems-that-scale/_next/static/chunks/main-8377b0572add80b6.js" defer=""></script><script src="/fem-permission-systems-that-scale/_next/static/chunks/pages/_app-ab9f88be91011ccd.js" defer=""></script><script src="/fem-permission-systems-that-scale/_next/static/chunks/pages/lessons/%5Bsection%5D/%5Bslug%5D-c23b0a3ff434a742.js" defer=""></script><script src="/fem-permission-systems-that-scale/_next/static/Z1s-VsOExbnNujkBZEKnx/_buildManifest.js" defer=""></script><script src="/fem-permission-systems-that-scale/_next/static/Z1s-VsOExbnNujkBZEKnx/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="remix-app"><header class="navbar"><h1 class="navbar-brand"><a href="/fem-permission-systems-that-scale">Permission Systems that Scale</a></h1><div class="navbar-info"></div></header><div class="content-container"><div class="main"><div class="lesson-container"><div class="lesson"><div class="lesson-content"><p>Let&#39;s convert our scattered permission checks into a centralized RBAC system.</p>
<h2>The Goal</h2>
<p>Replace this scattered mess:</p>
<pre><code class="hljs language-typescript"><button class="copy-btn">Copy</button><span class="hljs-comment">// In page 1</span>
<span class="hljs-keyword">if</span> (user.<span class="hljs-property">role</span> !== <span class="hljs-string">&quot;admin&quot;</span> &amp;&amp; user.<span class="hljs-property">role</span> !== <span class="hljs-string">&quot;author&quot;</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">redirect</span>(<span class="hljs-string">&quot;/&quot;</span>)
}

<span class="hljs-comment">// In page 2 (slightly different!)</span>
<span class="hljs-keyword">if</span> (user.<span class="hljs-property">role</span> === <span class="hljs-string">&quot;viewer&quot;</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">redirect</span>(<span class="hljs-string">&quot;/&quot;</span>)
}

<span class="hljs-comment">// In mutation</span>
<span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span> || user.<span class="hljs-property">role</span> === <span class="hljs-string">&quot;viewer&quot;</span> || user.<span class="hljs-property">role</span> === <span class="hljs-string">&quot;editor&quot;</span>) {
  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthorizationError</span>()
}
</code></pre><p>With this centralized approach:</p>
<pre><code class="hljs language-typescript"><button class="copy-btn">Copy</button><span class="hljs-comment">// Everywhere</span>
<span class="hljs-keyword">if</span> (!<span class="hljs-title function_">can</span>(user, <span class="hljs-string">&quot;document:create&quot;</span>)) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">redirect</span>(<span class="hljs-string">&quot;/&quot;</span>)
}
</code></pre><h2>How RBAC Works</h2>
<p>Before we write code, let&#39;s visualize what we&#39;re building:</p>
<p><img src="/fem-permission-systems-that-scale/images/03-rbac/rbac-flow.svg" alt="RBAC Flow"></p>
<p>The role acts as an indirection layer between users and permissions. Instead of scattering role checks everywhere, we create a <strong>lookup table</strong> that maps roles to permissions, then check against that table.</p>
<h2>Step 1: Create the Permissions Module</h2>
<p>We&#39;ll create a new file <code>src/permissions/rbac.ts</code> and build it piece by piece.</p>
<h3>Part 1: Define the Permission Type</h3>
<p>First, we define all possible permissions as a TypeScript union type:</p>
<pre><code class="hljs language-typescript"><button class="copy-btn">Copy</button><span class="hljs-comment">// src/permissions/rbac.ts</span>

<span class="hljs-keyword">import</span> { <span class="hljs-title class_">User</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/drizzle/schema&quot;</span>

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Permission</span> =
  | <span class="hljs-string">&quot;project:create&quot;</span>
  | <span class="hljs-string">&quot;project:read:all&quot;</span>
  | <span class="hljs-string">&quot;project:read:own-department&quot;</span>
  | <span class="hljs-string">&quot;project:read:global-department&quot;</span>
  | <span class="hljs-string">&quot;project:update&quot;</span>
  | <span class="hljs-string">&quot;project:delete&quot;</span>
  | <span class="hljs-string">&quot;document:create&quot;</span>
  | <span class="hljs-string">&quot;document:read&quot;</span>
  | <span class="hljs-string">&quot;document:update&quot;</span>
  | <span class="hljs-string">&quot;document:delete&quot;</span>
</code></pre><p>Using a union type means TypeScript will catch typos like <code>&quot;documnet:create&quot;</code> at compile time‚Äîa huge win over string literals scattered throughout your codebase.</p>
<h3>Part 2: Map Roles to Permissions</h3>
<p>Next, we create the lookup table‚Äîthis is the heart of RBAC:</p>
<pre><code class="hljs language-typescript"><button class="copy-btn">Copy</button><span class="hljs-keyword">const</span> <span class="hljs-attr">permissionsByRole</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-title class_">User</span>[<span class="hljs-string">&quot;role&quot;</span>], <span class="hljs-title class_">Permission</span>[]&gt; = {
  <span class="hljs-attr">admin</span>: [
    <span class="hljs-string">&quot;project:create&quot;</span>,
    <span class="hljs-string">&quot;project:read:all&quot;</span>,
    <span class="hljs-string">&quot;project:update&quot;</span>,
    <span class="hljs-string">&quot;project:delete&quot;</span>,
    <span class="hljs-string">&quot;document:create&quot;</span>,
    <span class="hljs-string">&quot;document:read&quot;</span>,
    <span class="hljs-string">&quot;document:update&quot;</span>,
    <span class="hljs-string">&quot;document:delete&quot;</span>,
  ],
  <span class="hljs-attr">author</span>: [
    <span class="hljs-string">&quot;project:read:own-department&quot;</span>,
    <span class="hljs-string">&quot;project:read:global-department&quot;</span>,
    <span class="hljs-string">&quot;document:create&quot;</span>,
    <span class="hljs-string">&quot;document:read&quot;</span>,
    <span class="hljs-string">&quot;document:update&quot;</span>,
  ],
  <span class="hljs-attr">editor</span>: [
    <span class="hljs-string">&quot;project:read:own-department&quot;</span>,
    <span class="hljs-string">&quot;project:read:global-department&quot;</span>,
    <span class="hljs-string">&quot;document:read&quot;</span>,
    <span class="hljs-string">&quot;document:update&quot;</span>,
  ],
  <span class="hljs-attr">viewer</span>: [
    <span class="hljs-string">&quot;project:read:own-department&quot;</span>,
    <span class="hljs-string">&quot;project:read:global-department&quot;</span>,
    <span class="hljs-string">&quot;document:read&quot;</span>,
  ],
}
</code></pre><p>Now when requirements change‚Äîsay, authors should be able to delete their own documents‚Äîyou update <strong>one place</strong> instead of hunting through dozens of files.</p>
<h3>Part 3: The <code>can</code> Function</h3>
<p>Finally, a simple function to check permissions:</p>
<pre><code class="hljs language-typescript"><button class="copy-btn">Copy</button><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">can</span>(<span class="hljs-params">
  <span class="hljs-attr">user</span>: <span class="hljs-title class_">Pick</span>&lt;<span class="hljs-title class_">User</span>, <span class="hljs-string">&quot;role&quot;</span>&gt; | <span class="hljs-literal">null</span>,
  <span class="hljs-attr">permission</span>: <span class="hljs-title class_">Permission</span>,
</span>): <span class="hljs-built_in">boolean</span> {
  <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  <span class="hljs-keyword">return</span> permissionsByRole[user.<span class="hljs-property">role</span>].<span class="hljs-title function_">includes</span>(permission)
}
</code></pre><blockquote>
<p>üí° We use <code>Pick&lt;User, &quot;role&quot;&gt;</code> instead of the full <code>User</code> type. This makes the function flexible since you don&#39;t need a full user object to call the function.</p>
</blockquote>
<h2>Step 2: Handle Complex Permission Logic</h2>
<p>Some permissions aren&#39;t purely role-based. For example, &quot;can read project&quot; depends on:</p>
<ul>
<li>The user&#39;s role (admins can read all)</li>
<li>The user&#39;s department</li>
<li>The project&#39;s department</li>
</ul>
<p>This is where pure RBAC starts to show cracks. We need helper functions that mix role checks with attribute checks:</p>
<pre><code class="hljs language-typescript"><button class="copy-btn">Copy</button><span class="hljs-comment">// src/permissions/projects.ts</span>

<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Project</span>, <span class="hljs-title class_">User</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/drizzle/schema&quot;</span>
<span class="hljs-keyword">import</span> { can } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./rbac&quot;</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">canReadProject</span>(<span class="hljs-params">
  <span class="hljs-attr">user</span>: <span class="hljs-title class_">Pick</span>&lt;<span class="hljs-title class_">User</span>, <span class="hljs-string">&quot;role&quot;</span> | <span class="hljs-string">&quot;department&quot;</span>&gt; | <span class="hljs-literal">null</span>,
  <span class="hljs-attr">project</span>: <span class="hljs-title class_">Pick</span>&lt;<span class="hljs-title class_">Project</span>, <span class="hljs-string">&quot;department&quot;</span>&gt;,
</span>): <span class="hljs-built_in">boolean</span> {
  <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>

  <span class="hljs-keyword">return</span> (
    <span class="hljs-title function_">can</span>(user, <span class="hljs-string">&quot;project:read:all&quot;</span>) ||
    (<span class="hljs-title function_">can</span>(user, <span class="hljs-string">&quot;project:read:own-department&quot;</span>) &amp;&amp;
      project.<span class="hljs-property">department</span> === user.<span class="hljs-property">department</span>) ||
    (<span class="hljs-title function_">can</span>(user, <span class="hljs-string">&quot;project:read:global-department&quot;</span>) &amp;&amp; project.<span class="hljs-property">department</span> == <span class="hljs-literal">null</span>)
  )
}
</code></pre><blockquote>
<p>‚ö†Ô∏è Notice how we&#39;re already mixing RBAC (<code>can(user, &quot;permission&quot;)</code>) with attribute checks (<code>project.department === user.department</code>). This hybrid approach works, but it&#39;s a sign that pure RBAC may not be enough for our needs.</p>
</blockquote>
<h2>Step 3: Update the Codebase</h2>
<p>Now we replace all inline checks with our centralized functions.</p>
<h3>Before (Page Component)</h3>
<pre><code class="hljs language-typescript"><button class="copy-btn">Copy</button><span class="hljs-keyword">if</span> (
  user == <span class="hljs-literal">null</span> ||
  (user.<span class="hljs-property">role</span> !== <span class="hljs-string">&quot;admin&quot;</span> &amp;&amp;
    project.<span class="hljs-property">department</span> != <span class="hljs-literal">null</span> &amp;&amp;
    user.<span class="hljs-property">department</span> !== project.<span class="hljs-property">department</span>)
) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">redirect</span>(<span class="hljs-string">&quot;/&quot;</span>)
}
</code></pre><h3>After (Page Component)</h3>
<pre><code class="hljs language-typescript"><button class="copy-btn">Copy</button><span class="hljs-keyword">if</span> (!<span class="hljs-title function_">canReadProject</span>(user, project)) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">redirect</span>(<span class="hljs-string">&quot;/&quot;</span>)
}
</code></pre><h3>Before (Mutation)</h3>
<pre><code class="hljs language-typescript"><button class="copy-btn">Copy</button><span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span> || user.<span class="hljs-property">role</span> === <span class="hljs-string">&quot;viewer&quot;</span>) {
  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthorizationError</span>()
}
</code></pre><h3>After (Mutation)</h3>
<pre><code class="hljs language-typescript"><button class="copy-btn">Copy</button><span class="hljs-keyword">if</span> (!<span class="hljs-title function_">can</span>(user, <span class="hljs-string">&quot;document:update&quot;</span>)) {
  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthorizationError</span>()
}
</code></pre><h3>Before (UI Conditional)</h3>
<pre><code class="hljs language-typescript"><button class="copy-btn">Copy</button>{(user?.<span class="hljs-property">role</span> === <span class="hljs-string">&quot;author&quot;</span> || user?.<span class="hljs-property">role</span> === <span class="hljs-string">&quot;admin&quot;</span>) &amp;&amp; (
  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span>&gt;</span>New Document<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span></span>
)}
</code></pre><h3>After (UI Conditional)</h3>
<pre><code class="hljs language-typescript"><button class="copy-btn">Copy</button>{<span class="hljs-title function_">can</span>(user, <span class="hljs-string">&quot;document:create&quot;</span>) &amp;&amp; (
  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span>&gt;</span>New Document<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span></span>
)}
</code></pre><h2>What We Gain</h2>
<p>After this refactor:</p>
<table>
<thead>
<tr>
<th>Benefit</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Single source of truth</strong></td>
<td>All permissions defined in one place</td>
</tr>
<tr>
<td><strong>Readable code</strong></td>
<td><code>can(user, &quot;document:create&quot;)</code> is self-documenting</td>
</tr>
<tr>
<td><strong>Type safety</strong></td>
<td>TypeScript ensures we only use valid permission names</td>
</tr>
<tr>
<td><strong>Easy updates</strong></td>
<td>Change a role&#39;s permissions in one file</td>
</tr>
</tbody></table>
<h2>Branch Checkpoint</h2>
<p>After completing this conversion, your code should match:</p>
<pre><code class="hljs language-text"><button class="copy-btn">Copy</button>Branch: 3-basic-rbac
</code></pre><p>Run the following to sync up:</p>
<pre><code class="hljs language-bash"><button class="copy-btn">Copy</button>git checkout 3-basic-rbac
</code></pre><h2>What&#39;s Next</h2>
<p>Our RBAC system works great for the current permissions. But what happens when we need to add more complex rules?</p>
</div><div class="lesson-links"><a href="/fem-permission-systems-that-scale/lessons/rbac/what-is-rbac" class="prev">‚Üê Previous</a><a href="/fem-permission-systems-that-scale/lessons/rbac/adding-more-permissions" class="next">Next ‚Üí</a></div></div><div class="details-bg"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="154" height="154" viewBox="0 0 154 154"><defs><clipPath id="clip-path"><rect id="Rectangle_2238" data-name="Rectangle 2238" width="154" height="154" transform="translate(9467 350)" fill="#fff" stroke="#707070" stroke-width="1"></rect></clipPath><clipPath id="clip-corner-image-active"><rect width="154" height="154"></rect></clipPath></defs><g id="corner-image-active" clip-path="url(#clip-corner-image-active)"><g id="Corner-image-active-2" data-name="Corner-image-active" transform="translate(-9467 -350)" clip-path="url(#clip-path)"><path id="Subtraction_34" data-name="Subtraction 34" d="M-3857.365,1740.766h0l-7.07-7.07,12.89-12.89v14.142l-5.818,5.818Zm-14.142-14.142h0l-7.071-7.07,27.033-27.033v14.143l-19.96,19.96Zm-14.143-14.143h0l-7.07-7.069,41.175-41.175v14.142Zm-14.142-14.142h0l-7.07-7.069,55.317-55.317v14.142Zm-14.142-14.142h0l-7.07-7.069,69.459-69.459v14.142Zm-14.142-14.142h0l-7.07-7.069,76.739-76.739h6.862v7.28Zm-14.143-14.143h0l-7.07-7.069,62.6-62.6h14.142Zm-14.142-14.142h0l-7.07-7.069,48.454-48.454h14.142Zm-14.142-14.142h0l-7.07-7.069,34.312-34.312h14.142Zm-14.142-14.142h0l-7.07-7.069,20.17-20.17h14.142Zm-14.142-14.142h0l-7.071-7.071,6.027-6.027h14.144l-13.1,13.1Zm367.24-56.114v-.909l.455.455-.453.453Z" transform="translate(13472.546 -1236.766)" fill="var(--corner-fill)"></path></g></g></svg></div></div></div></div><footer class="footer"><ul class="socials"><li class="social"><a href="https://twitter.com/DevSimplified"><svg fill="none" height="100%" width="32" xmlns="http://www.w3.org/2000/svg" viewBox="0.254 0.25 500 451.95400000000006"><path d="M394.033.25h76.67L303.202 191.693l197.052 260.511h-154.29L225.118 294.205 86.844 452.204H10.127l179.16-204.77L.254.25H158.46l109.234 144.417zm-26.908 406.063h42.483L135.377 43.73h-45.59z" fill="var(--footer-icons)"></path></svg></a></li><li class="social"><a href="https://github.com/WebDevSimplified"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32" height="32" viewBox="0 0 32 32"><defs><clipPath id="clip-github-social"><rect width="32" height="32"></rect></clipPath></defs><g id="github-social" clip-path="url(#clip-github-social)"><g id="Group_272" data-name="Group 272" transform="translate(13522.5 -6994)"><path id="Subtraction_33" data-name="Subtraction 33" d="M-24967.5,8041a15.9,15.9,0,0,1-11.312-4.688A15.893,15.893,0,0,1-24983.5,8025a15.893,15.893,0,0,1,4.689-11.315A15.894,15.894,0,0,1-24967.5,8009a15.894,15.894,0,0,1,11.313,4.686A15.893,15.893,0,0,1-24951.5,8025a15.893,15.893,0,0,1-4.689,11.313A15.9,15.9,0,0,1-24967.5,8041Zm-3.781-4.571h0v3.918h7.895v-6.665a1.836,1.836,0,0,0-1.2-1.718c5.1-.617,7.467-2.975,7.467-7.424a7.176,7.176,0,0,0-1.637-4.728,6.74,6.74,0,0,0,.275-1.812,4.34,4.34,0,0,0-.52-2.452.574.574,0,0,0-.359-.1c-1.061,0-3.465,1.411-3.936,1.694a16.644,16.644,0,0,0-4.2-.489,16.379,16.379,0,0,0-3.969.445c-.846-.5-2.91-1.649-3.859-1.649a.566.566,0,0,0-.354.095,4.3,4.3,0,0,0-.521,2.452,6.7,6.7,0,0,0,.244,1.718,7.346,7.346,0,0,0-1.6,4.822,7.263,7.263,0,0,0,1.533,4.985c1.193,1.359,3.115,2.165,5.871,2.464a1.826,1.826,0,0,0-1.129,1.693v.5h0l-.006,0a7.121,7.121,0,0,1-2.033.363,2.608,2.608,0,0,1-.965-.158,4.438,4.438,0,0,1-1.836-1.881,2.361,2.361,0,0,0-1.248-1.091,3.472,3.472,0,0,0-1.217-.3.584.584,0,0,0-.545.224.282.282,0,0,0,.027.367,1.875,1.875,0,0,0,.447.307,4.732,4.732,0,0,1,.561.355,10.726,10.726,0,0,1,1.682,2.755c.043.092.078.163.105.217a3.876,3.876,0,0,0,2.42,1.185,6.036,6.036,0,0,0,.607.025c.875,0,1.988-.124,2-.125Z" transform="translate(11461 -1015)" fill="var(--footer-icons)"></path><g id="Ellipse_670" data-name="Ellipse 670" transform="translate(-13522.5 6994)" fill="none" stroke="var(--footer-icons)" stroke-width="1"><circle cx="16" cy="16" r="16" stroke="none"></circle><circle cx="16" cy="16" r="15.5" fill="none"></circle></g></g></g></svg></a></li><li class="social"><div class="terms"><p>Content Licensed Under CC-BY-NC-4.0</p><p>Code Samples and Exercises Licensed Under Apache 2.0</p><p>Site Designed by<!-- --> <a href="https://www.alexdanielson.com/">Alex Danielson</a></p></div></li></ul><div class="theme-icons"><button aria-label="Activate dark mode" title="Activate dark mode" class="theme-toggle"><svg xmlns="http://www.w3.org/2000/svg" width="36px" height="100%" viewBox="0 -960 960 960" fill="var(--text-footer)" role="img"><title>Dark Mode Icon</title><path d="M480-120q-150 0-255-105T120-480q0-150 105-255t255-105q14 0 27.5 1t26.5 3q-41 29-65.5 75.5T444-660q0 90 63 153t153 63q55 0 101-24.5t75-65.5q2 13 3 26.5t1 27.5q0 150-105 255T480-120Zm0-80q88 0 158-48.5T740-375q-20 5-40 8t-40 3q-123 0-209.5-86.5T364-660q0-20 3-40t8-40q-78 32-126.5 102T200-480q0 116 82 198t198 82Z"></path></svg></button></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"attributes":{"title":"Converting to RBAC"},"html":"\u003cp\u003eLet\u0026#39;s convert our scattered permission checks into a centralized RBAC system.\u003c/p\u003e\n\u003ch2\u003eThe Goal\u003c/h2\u003e\n\u003cp\u003eReplace this scattered mess:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cbutton class=\"copy-btn\"\u003eCopy\u003c/button\u003e\u003cspan class=\"hljs-comment\"\u003e// In page 1\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (user.\u003cspan class=\"hljs-property\"\u003erole\u003c/span\u003e !== \u003cspan class=\"hljs-string\"\u003e\u0026quot;admin\u0026quot;\u003c/span\u003e \u0026amp;\u0026amp; user.\u003cspan class=\"hljs-property\"\u003erole\u003c/span\u003e !== \u003cspan class=\"hljs-string\"\u003e\u0026quot;author\u0026quot;\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eredirect\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;/\u0026quot;\u003c/span\u003e)\n}\n\n\u003cspan class=\"hljs-comment\"\u003e// In page 2 (slightly different!)\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (user.\u003cspan class=\"hljs-property\"\u003erole\u003c/span\u003e === \u003cspan class=\"hljs-string\"\u003e\u0026quot;viewer\u0026quot;\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eredirect\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;/\u0026quot;\u003c/span\u003e)\n}\n\n\u003cspan class=\"hljs-comment\"\u003e// In mutation\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (user == \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e || user.\u003cspan class=\"hljs-property\"\u003erole\u003c/span\u003e === \u003cspan class=\"hljs-string\"\u003e\u0026quot;viewer\u0026quot;\u003c/span\u003e || user.\u003cspan class=\"hljs-property\"\u003erole\u003c/span\u003e === \u003cspan class=\"hljs-string\"\u003e\u0026quot;editor\u0026quot;\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003ethrow\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eAuthorizationError\u003c/span\u003e()\n}\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eWith this centralized approach:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cbutton class=\"copy-btn\"\u003eCopy\u003c/button\u003e\u003cspan class=\"hljs-comment\"\u003e// Everywhere\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!\u003cspan class=\"hljs-title function_\"\u003ecan\u003c/span\u003e(user, \u003cspan class=\"hljs-string\"\u003e\u0026quot;document:create\u0026quot;\u003c/span\u003e)) {\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eredirect\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;/\u0026quot;\u003c/span\u003e)\n}\n\u003c/code\u003e\u003c/pre\u003e\u003ch2\u003eHow RBAC Works\u003c/h2\u003e\n\u003cp\u003eBefore we write code, let\u0026#39;s visualize what we\u0026#39;re building:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/fem-permission-systems-that-scale/images/03-rbac/rbac-flow.svg\" alt=\"RBAC Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe role acts as an indirection layer between users and permissions. Instead of scattering role checks everywhere, we create a \u003cstrong\u003elookup table\u003c/strong\u003e that maps roles to permissions, then check against that table.\u003c/p\u003e\n\u003ch2\u003eStep 1: Create the Permissions Module\u003c/h2\u003e\n\u003cp\u003eWe\u0026#39;ll create a new file \u003ccode\u003esrc/permissions/rbac.ts\u003c/code\u003e and build it piece by piece.\u003c/p\u003e\n\u003ch3\u003ePart 1: Define the Permission Type\u003c/h3\u003e\n\u003cp\u003eFirst, we define all possible permissions as a TypeScript union type:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cbutton class=\"copy-btn\"\u003eCopy\u003c/button\u003e\u003cspan class=\"hljs-comment\"\u003e// src/permissions/rbac.ts\u003c/span\u003e\n\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e { \u003cspan class=\"hljs-title class_\"\u003eUser\u003c/span\u003e } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;@/drizzle/schema\u0026quot;\u003c/span\u003e\n\n\u003cspan class=\"hljs-keyword\"\u003etype\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003ePermission\u003c/span\u003e =\n  | \u003cspan class=\"hljs-string\"\u003e\u0026quot;project:create\u0026quot;\u003c/span\u003e\n  | \u003cspan class=\"hljs-string\"\u003e\u0026quot;project:read:all\u0026quot;\u003c/span\u003e\n  | \u003cspan class=\"hljs-string\"\u003e\u0026quot;project:read:own-department\u0026quot;\u003c/span\u003e\n  | \u003cspan class=\"hljs-string\"\u003e\u0026quot;project:read:global-department\u0026quot;\u003c/span\u003e\n  | \u003cspan class=\"hljs-string\"\u003e\u0026quot;project:update\u0026quot;\u003c/span\u003e\n  | \u003cspan class=\"hljs-string\"\u003e\u0026quot;project:delete\u0026quot;\u003c/span\u003e\n  | \u003cspan class=\"hljs-string\"\u003e\u0026quot;document:create\u0026quot;\u003c/span\u003e\n  | \u003cspan class=\"hljs-string\"\u003e\u0026quot;document:read\u0026quot;\u003c/span\u003e\n  | \u003cspan class=\"hljs-string\"\u003e\u0026quot;document:update\u0026quot;\u003c/span\u003e\n  | \u003cspan class=\"hljs-string\"\u003e\u0026quot;document:delete\u0026quot;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eUsing a union type means TypeScript will catch typos like \u003ccode\u003e\u0026quot;documnet:create\u0026quot;\u003c/code\u003e at compile time‚Äîa huge win over string literals scattered throughout your codebase.\u003c/p\u003e\n\u003ch3\u003ePart 2: Map Roles to Permissions\u003c/h3\u003e\n\u003cp\u003eNext, we create the lookup table‚Äîthis is the heart of RBAC:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cbutton class=\"copy-btn\"\u003eCopy\u003c/button\u003e\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003epermissionsByRole\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eRecord\u003c/span\u003e\u0026lt;\u003cspan class=\"hljs-title class_\"\u003eUser\u003c/span\u003e[\u003cspan class=\"hljs-string\"\u003e\u0026quot;role\u0026quot;\u003c/span\u003e], \u003cspan class=\"hljs-title class_\"\u003ePermission\u003c/span\u003e[]\u0026gt; = {\n  \u003cspan class=\"hljs-attr\"\u003eadmin\u003c/span\u003e: [\n    \u003cspan class=\"hljs-string\"\u003e\u0026quot;project:create\u0026quot;\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\u0026quot;project:read:all\u0026quot;\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\u0026quot;project:update\u0026quot;\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\u0026quot;project:delete\u0026quot;\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\u0026quot;document:create\u0026quot;\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\u0026quot;document:read\u0026quot;\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\u0026quot;document:update\u0026quot;\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\u0026quot;document:delete\u0026quot;\u003c/span\u003e,\n  ],\n  \u003cspan class=\"hljs-attr\"\u003eauthor\u003c/span\u003e: [\n    \u003cspan class=\"hljs-string\"\u003e\u0026quot;project:read:own-department\u0026quot;\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\u0026quot;project:read:global-department\u0026quot;\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\u0026quot;document:create\u0026quot;\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\u0026quot;document:read\u0026quot;\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\u0026quot;document:update\u0026quot;\u003c/span\u003e,\n  ],\n  \u003cspan class=\"hljs-attr\"\u003eeditor\u003c/span\u003e: [\n    \u003cspan class=\"hljs-string\"\u003e\u0026quot;project:read:own-department\u0026quot;\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\u0026quot;project:read:global-department\u0026quot;\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\u0026quot;document:read\u0026quot;\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\u0026quot;document:update\u0026quot;\u003c/span\u003e,\n  ],\n  \u003cspan class=\"hljs-attr\"\u003eviewer\u003c/span\u003e: [\n    \u003cspan class=\"hljs-string\"\u003e\u0026quot;project:read:own-department\u0026quot;\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\u0026quot;project:read:global-department\u0026quot;\u003c/span\u003e,\n    \u003cspan class=\"hljs-string\"\u003e\u0026quot;document:read\u0026quot;\u003c/span\u003e,\n  ],\n}\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eNow when requirements change‚Äîsay, authors should be able to delete their own documents‚Äîyou update \u003cstrong\u003eone place\u003c/strong\u003e instead of hunting through dozens of files.\u003c/p\u003e\n\u003ch3\u003ePart 3: The \u003ccode\u003ecan\u003c/code\u003e Function\u003c/h3\u003e\n\u003cp\u003eFinally, a simple function to check permissions:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cbutton class=\"copy-btn\"\u003eCopy\u003c/button\u003e\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ecan\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\n  \u003cspan class=\"hljs-attr\"\u003euser\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003ePick\u003c/span\u003e\u0026lt;\u003cspan class=\"hljs-title class_\"\u003eUser\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;role\u0026quot;\u003c/span\u003e\u0026gt; | \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\n  \u003cspan class=\"hljs-attr\"\u003epermission\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003ePermission\u003c/span\u003e,\n\u003c/span\u003e): \u003cspan class=\"hljs-built_in\"\u003eboolean\u003c/span\u003e {\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (user == \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e permissionsByRole[user.\u003cspan class=\"hljs-property\"\u003erole\u003c/span\u003e].\u003cspan class=\"hljs-title function_\"\u003eincludes\u003c/span\u003e(permission)\n}\n\u003c/code\u003e\u003c/pre\u003e\u003cblockquote\u003e\n\u003cp\u003eüí° We use \u003ccode\u003ePick\u0026lt;User, \u0026quot;role\u0026quot;\u0026gt;\u003c/code\u003e instead of the full \u003ccode\u003eUser\u003c/code\u003e type. This makes the function flexible since you don\u0026#39;t need a full user object to call the function.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch2\u003eStep 2: Handle Complex Permission Logic\u003c/h2\u003e\n\u003cp\u003eSome permissions aren\u0026#39;t purely role-based. For example, \u0026quot;can read project\u0026quot; depends on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eThe user\u0026#39;s role (admins can read all)\u003c/li\u003e\n\u003cli\u003eThe user\u0026#39;s department\u003c/li\u003e\n\u003cli\u003eThe project\u0026#39;s department\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis is where pure RBAC starts to show cracks. We need helper functions that mix role checks with attribute checks:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cbutton class=\"copy-btn\"\u003eCopy\u003c/button\u003e\u003cspan class=\"hljs-comment\"\u003e// src/permissions/projects.ts\u003c/span\u003e\n\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e { \u003cspan class=\"hljs-title class_\"\u003eProject\u003c/span\u003e, \u003cspan class=\"hljs-title class_\"\u003eUser\u003c/span\u003e } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;@/drizzle/schema\u0026quot;\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e { can } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;./rbac\u0026quot;\u003c/span\u003e\n\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ecanReadProject\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\n  \u003cspan class=\"hljs-attr\"\u003euser\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003ePick\u003c/span\u003e\u0026lt;\u003cspan class=\"hljs-title class_\"\u003eUser\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;role\u0026quot;\u003c/span\u003e | \u003cspan class=\"hljs-string\"\u003e\u0026quot;department\u0026quot;\u003c/span\u003e\u0026gt; | \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\n  \u003cspan class=\"hljs-attr\"\u003eproject\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003ePick\u003c/span\u003e\u0026lt;\u003cspan class=\"hljs-title class_\"\u003eProject\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;department\u0026quot;\u003c/span\u003e\u0026gt;,\n\u003c/span\u003e): \u003cspan class=\"hljs-built_in\"\u003eboolean\u003c/span\u003e {\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (user == \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e\n\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e (\n    \u003cspan class=\"hljs-title function_\"\u003ecan\u003c/span\u003e(user, \u003cspan class=\"hljs-string\"\u003e\u0026quot;project:read:all\u0026quot;\u003c/span\u003e) ||\n    (\u003cspan class=\"hljs-title function_\"\u003ecan\u003c/span\u003e(user, \u003cspan class=\"hljs-string\"\u003e\u0026quot;project:read:own-department\u0026quot;\u003c/span\u003e) \u0026amp;\u0026amp;\n      project.\u003cspan class=\"hljs-property\"\u003edepartment\u003c/span\u003e === user.\u003cspan class=\"hljs-property\"\u003edepartment\u003c/span\u003e) ||\n    (\u003cspan class=\"hljs-title function_\"\u003ecan\u003c/span\u003e(user, \u003cspan class=\"hljs-string\"\u003e\u0026quot;project:read:global-department\u0026quot;\u003c/span\u003e) \u0026amp;\u0026amp; project.\u003cspan class=\"hljs-property\"\u003edepartment\u003c/span\u003e == \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e)\n  )\n}\n\u003c/code\u003e\u003c/pre\u003e\u003cblockquote\u003e\n\u003cp\u003e‚ö†Ô∏è Notice how we\u0026#39;re already mixing RBAC (\u003ccode\u003ecan(user, \u0026quot;permission\u0026quot;)\u003c/code\u003e) with attribute checks (\u003ccode\u003eproject.department === user.department\u003c/code\u003e). This hybrid approach works, but it\u0026#39;s a sign that pure RBAC may not be enough for our needs.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch2\u003eStep 3: Update the Codebase\u003c/h2\u003e\n\u003cp\u003eNow we replace all inline checks with our centralized functions.\u003c/p\u003e\n\u003ch3\u003eBefore (Page Component)\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cbutton class=\"copy-btn\"\u003eCopy\u003c/button\u003e\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\n  user == \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e ||\n  (user.\u003cspan class=\"hljs-property\"\u003erole\u003c/span\u003e !== \u003cspan class=\"hljs-string\"\u003e\u0026quot;admin\u0026quot;\u003c/span\u003e \u0026amp;\u0026amp;\n    project.\u003cspan class=\"hljs-property\"\u003edepartment\u003c/span\u003e != \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e \u0026amp;\u0026amp;\n    user.\u003cspan class=\"hljs-property\"\u003edepartment\u003c/span\u003e !== project.\u003cspan class=\"hljs-property\"\u003edepartment\u003c/span\u003e)\n) {\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eredirect\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;/\u0026quot;\u003c/span\u003e)\n}\n\u003c/code\u003e\u003c/pre\u003e\u003ch3\u003eAfter (Page Component)\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cbutton class=\"copy-btn\"\u003eCopy\u003c/button\u003e\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!\u003cspan class=\"hljs-title function_\"\u003ecanReadProject\u003c/span\u003e(user, project)) {\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eredirect\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;/\u0026quot;\u003c/span\u003e)\n}\n\u003c/code\u003e\u003c/pre\u003e\u003ch3\u003eBefore (Mutation)\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cbutton class=\"copy-btn\"\u003eCopy\u003c/button\u003e\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (user == \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e || user.\u003cspan class=\"hljs-property\"\u003erole\u003c/span\u003e === \u003cspan class=\"hljs-string\"\u003e\u0026quot;viewer\u0026quot;\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003ethrow\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eAuthorizationError\u003c/span\u003e()\n}\n\u003c/code\u003e\u003c/pre\u003e\u003ch3\u003eAfter (Mutation)\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cbutton class=\"copy-btn\"\u003eCopy\u003c/button\u003e\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!\u003cspan class=\"hljs-title function_\"\u003ecan\u003c/span\u003e(user, \u003cspan class=\"hljs-string\"\u003e\u0026quot;document:update\u0026quot;\u003c/span\u003e)) {\n  \u003cspan class=\"hljs-keyword\"\u003ethrow\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eAuthorizationError\u003c/span\u003e()\n}\n\u003c/code\u003e\u003c/pre\u003e\u003ch3\u003eBefore (UI Conditional)\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cbutton class=\"copy-btn\"\u003eCopy\u003c/button\u003e{(user?.\u003cspan class=\"hljs-property\"\u003erole\u003c/span\u003e === \u003cspan class=\"hljs-string\"\u003e\u0026quot;author\u0026quot;\u003c/span\u003e || user?.\u003cspan class=\"hljs-property\"\u003erole\u003c/span\u003e === \u003cspan class=\"hljs-string\"\u003e\u0026quot;admin\u0026quot;\u003c/span\u003e) \u0026amp;\u0026amp; (\n  \u003cspan class=\"language-xml\"\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003eButton\u003c/span\u003e\u0026gt;\u003c/span\u003eNew Document\u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003eButton\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n)}\n\u003c/code\u003e\u003c/pre\u003e\u003ch3\u003eAfter (UI Conditional)\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cbutton class=\"copy-btn\"\u003eCopy\u003c/button\u003e{\u003cspan class=\"hljs-title function_\"\u003ecan\u003c/span\u003e(user, \u003cspan class=\"hljs-string\"\u003e\u0026quot;document:create\u0026quot;\u003c/span\u003e) \u0026amp;\u0026amp; (\n  \u003cspan class=\"language-xml\"\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003eButton\u003c/span\u003e\u0026gt;\u003c/span\u003eNew Document\u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003eButton\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n)}\n\u003c/code\u003e\u003c/pre\u003e\u003ch2\u003eWhat We Gain\u003c/h2\u003e\n\u003cp\u003eAfter this refactor:\u003c/p\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003eBenefit\u003c/th\u003e\n\u003cth\u003eDescription\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\u003ctr\u003e\n\u003ctd\u003e\u003cstrong\u003eSingle source of truth\u003c/strong\u003e\u003c/td\u003e\n\u003ctd\u003eAll permissions defined in one place\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003cstrong\u003eReadable code\u003c/strong\u003e\u003c/td\u003e\n\u003ctd\u003e\u003ccode\u003ecan(user, \u0026quot;document:create\u0026quot;)\u003c/code\u003e is self-documenting\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003cstrong\u003eType safety\u003c/strong\u003e\u003c/td\u003e\n\u003ctd\u003eTypeScript ensures we only use valid permission names\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003cstrong\u003eEasy updates\u003c/strong\u003e\u003c/td\u003e\n\u003ctd\u003eChange a role\u0026#39;s permissions in one file\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\u003c/table\u003e\n\u003ch2\u003eBranch Checkpoint\u003c/h2\u003e\n\u003cp\u003eAfter completing this conversion, your code should match:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-text\"\u003e\u003cbutton class=\"copy-btn\"\u003eCopy\u003c/button\u003eBranch: 3-basic-rbac\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eRun the following to sync up:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e\u003cbutton class=\"copy-btn\"\u003eCopy\u003c/button\u003egit checkout 3-basic-rbac\n\u003c/code\u003e\u003c/pre\u003e\u003ch2\u003eWhat\u0026#39;s Next\u003c/h2\u003e\n\u003cp\u003eOur RBAC system works great for the current permissions. But what happens when we need to add more complex rules?\u003c/p\u003e\n","markdown":"\nLet's convert our scattered permission checks into a centralized RBAC system.\n\n## The Goal\n\nReplace this scattered mess:\n\n```typescript\n// In page 1\nif (user.role !== \"admin\" \u0026\u0026 user.role !== \"author\") {\n  return redirect(\"/\")\n}\n\n// In page 2 (slightly different!)\nif (user.role === \"viewer\") {\n  return redirect(\"/\")\n}\n\n// In mutation\nif (user == null || user.role === \"viewer\" || user.role === \"editor\") {\n  throw new AuthorizationError()\n}\n```\n\nWith this centralized approach:\n\n```typescript\n// Everywhere\nif (!can(user, \"document:create\")) {\n  return redirect(\"/\")\n}\n```\n\n## How RBAC Works\n\nBefore we write code, let's visualize what we're building:\n\n![RBAC Flow](/fem-permission-systems-that-scale/images/03-rbac/rbac-flow.svg)\n\nThe role acts as an indirection layer between users and permissions. Instead of scattering role checks everywhere, we create a **lookup table** that maps roles to permissions, then check against that table.\n\n## Step 1: Create the Permissions Module\n\nWe'll create a new file `src/permissions/rbac.ts` and build it piece by piece.\n\n### Part 1: Define the Permission Type\n\nFirst, we define all possible permissions as a TypeScript union type:\n\n```typescript\n// src/permissions/rbac.ts\n\nimport { User } from \"@/drizzle/schema\"\n\ntype Permission =\n  | \"project:create\"\n  | \"project:read:all\"\n  | \"project:read:own-department\"\n  | \"project:read:global-department\"\n  | \"project:update\"\n  | \"project:delete\"\n  | \"document:create\"\n  | \"document:read\"\n  | \"document:update\"\n  | \"document:delete\"\n```\n\nUsing a union type means TypeScript will catch typos like `\"documnet:create\"` at compile time‚Äîa huge win over string literals scattered throughout your codebase.\n\n### Part 2: Map Roles to Permissions\n\nNext, we create the lookup table‚Äîthis is the heart of RBAC:\n\n```typescript\nconst permissionsByRole: Record\u003cUser[\"role\"], Permission[]\u003e = {\n  admin: [\n    \"project:create\",\n    \"project:read:all\",\n    \"project:update\",\n    \"project:delete\",\n    \"document:create\",\n    \"document:read\",\n    \"document:update\",\n    \"document:delete\",\n  ],\n  author: [\n    \"project:read:own-department\",\n    \"project:read:global-department\",\n    \"document:create\",\n    \"document:read\",\n    \"document:update\",\n  ],\n  editor: [\n    \"project:read:own-department\",\n    \"project:read:global-department\",\n    \"document:read\",\n    \"document:update\",\n  ],\n  viewer: [\n    \"project:read:own-department\",\n    \"project:read:global-department\",\n    \"document:read\",\n  ],\n}\n```\n\nNow when requirements change‚Äîsay, authors should be able to delete their own documents‚Äîyou update **one place** instead of hunting through dozens of files.\n\n### Part 3: The `can` Function\n\nFinally, a simple function to check permissions:\n\n```typescript\nexport function can(\n  user: Pick\u003cUser, \"role\"\u003e | null,\n  permission: Permission,\n): boolean {\n  if (user == null) return false\n  return permissionsByRole[user.role].includes(permission)\n}\n```\n\n\u003e üí° We use `Pick\u003cUser, \"role\"\u003e` instead of the full `User` type. This makes the function flexible since you don't need a full user object to call the function.\n\n## Step 2: Handle Complex Permission Logic\n\nSome permissions aren't purely role-based. For example, \"can read project\" depends on:\n\n- The user's role (admins can read all)\n- The user's department\n- The project's department\n\nThis is where pure RBAC starts to show cracks. We need helper functions that mix role checks with attribute checks:\n\n```typescript\n// src/permissions/projects.ts\n\nimport { Project, User } from \"@/drizzle/schema\"\nimport { can } from \"./rbac\"\n\nexport function canReadProject(\n  user: Pick\u003cUser, \"role\" | \"department\"\u003e | null,\n  project: Pick\u003cProject, \"department\"\u003e,\n): boolean {\n  if (user == null) return false\n\n  return (\n    can(user, \"project:read:all\") ||\n    (can(user, \"project:read:own-department\") \u0026\u0026\n      project.department === user.department) ||\n    (can(user, \"project:read:global-department\") \u0026\u0026 project.department == null)\n  )\n}\n```\n\n\u003e ‚ö†Ô∏è Notice how we're already mixing RBAC (`can(user, \"permission\")`) with attribute checks (`project.department === user.department`). This hybrid approach works, but it's a sign that pure RBAC may not be enough for our needs.\n\n## Step 3: Update the Codebase\n\nNow we replace all inline checks with our centralized functions.\n\n### Before (Page Component)\n\n```typescript\nif (\n  user == null ||\n  (user.role !== \"admin\" \u0026\u0026\n    project.department != null \u0026\u0026\n    user.department !== project.department)\n) {\n  return redirect(\"/\")\n}\n```\n\n### After (Page Component)\n\n```typescript\nif (!canReadProject(user, project)) {\n  return redirect(\"/\")\n}\n```\n\n### Before (Mutation)\n\n```typescript\nif (user == null || user.role === \"viewer\") {\n  throw new AuthorizationError()\n}\n```\n\n### After (Mutation)\n\n```typescript\nif (!can(user, \"document:update\")) {\n  throw new AuthorizationError()\n}\n```\n\n### Before (UI Conditional)\n\n```typescript\n{(user?.role === \"author\" || user?.role === \"admin\") \u0026\u0026 (\n  \u003cButton\u003eNew Document\u003c/Button\u003e\n)}\n```\n\n### After (UI Conditional)\n\n```typescript\n{can(user, \"document:create\") \u0026\u0026 (\n  \u003cButton\u003eNew Document\u003c/Button\u003e\n)}\n```\n\n## What We Gain\n\nAfter this refactor:\n\n| Benefit                    | Description                                           |\n| -------------------------- | ----------------------------------------------------- |\n| **Single source of truth** | All permissions defined in one place                  |\n| **Readable code**          | `can(user, \"document:create\")` is self-documenting    |\n| **Type safety**            | TypeScript ensures we only use valid permission names |\n| **Easy updates**           | Change a role's permissions in one file               |\n\n## Branch Checkpoint\n\nAfter completing this conversion, your code should match:\n\n```text\nBranch: 3-basic-rbac\n```\n\nRun the following to sync up:\n\n```bash\ngit checkout 3-basic-rbac\n```\n\n## What's Next\n\nOur RBAC system works great for the current permissions. But what happens when we need to add more complex rules?\n","slug":"converting-to-rbac","title":"Converting to RBAC","section":"Role-Based Access Control (RBAC)","icon":"shield","filePath":"/home/runner/work/fem-permission-systems-that-scale/fem-permission-systems-that-scale/lessons/03-rbac/B-converting-to-rbac.md","nextSlug":"/fem-permission-systems-that-scale/lessons/rbac/adding-more-permissions","prevSlug":"/fem-permission-systems-that-scale/lessons/rbac/what-is-rbac"}},"__N_SSG":true},"page":"/lessons/[section]/[slug]","query":{"section":"rbac","slug":"converting-to-rbac"},"buildId":"Z1s-VsOExbnNujkBZEKnx","assetPrefix":"/fem-permission-systems-that-scale","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>
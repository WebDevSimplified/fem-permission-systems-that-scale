{"pageProps":{"post":{"attributes":{"title":"Upgrading to CASL"},"html":"<p>Let&#39;s upgrade our custom ABAC implementation to use CASL.</p>\n<h2>Installing CASL</h2>\n<p>First, install the CASL packages:</p>\n<pre><code class=\"hljs language-bash\"><button class=\"copy-btn\">Copy</button>npm install @casl/ability\n</code></pre><h2>Updating the Permission Module</h2>\n<h3>Key Changes</h3>\n<p>Here&#39;s what changes when migrating to CASL:</p>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-comment\">// BEFORE (custom): resource first, action second</span>\nbuilder.<span class=\"hljs-title function_\">can</span>(<span class=\"hljs-string\">&quot;document&quot;</span>, <span class=\"hljs-string\">&quot;read&quot;</span>)\nbuilder.<span class=\"hljs-title function_\">can</span>(<span class=\"hljs-string\">&quot;document&quot;</span>, <span class=\"hljs-string\">&quot;read&quot;</span>, { <span class=\"hljs-attr\">status</span>: <span class=\"hljs-string\">&quot;published&quot;</span> }, [<span class=\"hljs-string\">&quot;title&quot;</span>, <span class=\"hljs-string\">&quot;content&quot;</span>])\n\n<span class=\"hljs-comment\">// AFTER (CASL): action first, resource second, fields before conditions</span>\n<span class=\"hljs-title function_\">can</span>(<span class=\"hljs-string\">&quot;read&quot;</span>, <span class=\"hljs-string\">&quot;document&quot;</span>)\n<span class=\"hljs-title function_\">can</span>(<span class=\"hljs-string\">&quot;read&quot;</span>, <span class=\"hljs-string\">&quot;document&quot;</span>, [<span class=\"hljs-string\">&quot;title&quot;</span>, <span class=\"hljs-string\">&quot;content&quot;</span>], { <span class=\"hljs-attr\">status</span>: <span class=\"hljs-string\">&quot;published&quot;</span> })\n</code></pre><h3>Type Setup</h3>\n<p>CASL needs types to understand your resources which are broken down into subjects and actions:</p>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-keyword\">type</span> <span class=\"hljs-title class_\">FullCRUD</span> = <span class=\"hljs-string\">&quot;create&quot;</span> | <span class=\"hljs-string\">&quot;read&quot;</span> | <span class=\"hljs-string\">&quot;update&quot;</span> | <span class=\"hljs-string\">&quot;delete&quot;</span>\n<span class=\"hljs-keyword\">type</span> <span class=\"hljs-title class_\">ProjectSubject</span> = <span class=\"hljs-string\">&quot;project&quot;</span> | <span class=\"hljs-title class_\">Pick</span>&lt;<span class=\"hljs-title class_\">Project</span>, <span class=\"hljs-string\">&quot;department&quot;</span>&gt;\n<span class=\"hljs-keyword\">type</span> <span class=\"hljs-title class_\">DocumentSubject</span> =\n  | <span class=\"hljs-string\">&quot;document&quot;</span>\n  | <span class=\"hljs-title class_\">Pick</span>&lt;<span class=\"hljs-title class_\">Document</span>, <span class=\"hljs-string\">&quot;projectId&quot;</span> | <span class=\"hljs-string\">&quot;creatorId&quot;</span> | <span class=\"hljs-string\">&quot;status&quot;</span> | <span class=\"hljs-string\">&quot;isLocked&quot;</span>&gt;\n\n<span class=\"hljs-keyword\">type</span> <span class=\"hljs-title class_\">MyAbility</span> = <span class=\"hljs-title class_\">MongoAbility</span>&lt;\n  [<span class=\"hljs-title class_\">FullCRUD</span>, <span class=\"hljs-title class_\">ProjectSubject</span>] | [<span class=\"hljs-title class_\">FullCRUD</span>, <span class=\"hljs-title class_\">DocumentSubject</span>]\n&gt;\n</code></pre><h3>Building Permissions</h3>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">getUserPermissionsInternal</span>(<span class=\"hljs-params\"><span class=\"hljs-attr\">user</span>: <span class=\"hljs-title class_\">User</span></span>) {\n  <span class=\"hljs-keyword\">const</span> { <span class=\"hljs-attr\">can</span>: allow, build } = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">AbilityBuilder</span>&lt;<span class=\"hljs-title class_\">MyAbility</span>&gt;(\n    createMongoAbility,\n  )\n\n  <span class=\"hljs-keyword\">if</span> (user.<span class=\"hljs-property\">role</span> === <span class=\"hljs-string\">&quot;admin&quot;</span>) {\n    <span class=\"hljs-title function_\">allow</span>(<span class=\"hljs-string\">&quot;read&quot;</span>, <span class=\"hljs-string\">&quot;document&quot;</span>)\n    <span class=\"hljs-title function_\">allow</span>(<span class=\"hljs-string\">&quot;read&quot;</span>, <span class=\"hljs-string\">&quot;project&quot;</span>)\n  }\n\n  <span class=\"hljs-keyword\">if</span> (user.<span class=\"hljs-property\">role</span> === <span class=\"hljs-string\">&quot;viewer&quot;</span>) {\n    <span class=\"hljs-comment\">// Fields come BEFORE conditions in CASL</span>\n    <span class=\"hljs-title function_\">allow</span>(<span class=\"hljs-string\">&quot;read&quot;</span>, <span class=\"hljs-string\">&quot;document&quot;</span>, [<span class=\"hljs-string\">&quot;title&quot;</span>, <span class=\"hljs-string\">&quot;content&quot;</span>], { <span class=\"hljs-attr\">status</span>: <span class=\"hljs-string\">&quot;published&quot;</span> })\n  }\n\n  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-title function_\">build</span>()\n}\n</code></pre><h2>Using CASL in Components</h2>\n<p>The usage pattern is almost identical, with one key difference:</p>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-comment\">// Custom: pass object directly</span>\n<span class=\"hljs-keyword\">if</span> (permissions.<span class=\"hljs-title function_\">can</span>(<span class=\"hljs-string\">&quot;document&quot;</span>, <span class=\"hljs-string\">&quot;update&quot;</span>, <span class=\"hljs-variable language_\">document</span>)) {\n  <span class=\"hljs-comment\">// ...</span>\n}\n\n<span class=\"hljs-comment\">// CASL: wrap object with subject() helper</span>\n<span class=\"hljs-keyword\">import</span> { subject } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;@casl/ability&quot;</span>\n\n<span class=\"hljs-keyword\">if</span> (ability.<span class=\"hljs-title function_\">can</span>(<span class=\"hljs-string\">&quot;update&quot;</span>, <span class=\"hljs-title function_\">subject</span>(<span class=\"hljs-string\">&quot;document&quot;</span>, <span class=\"hljs-variable language_\">document</span>))) {\n  <span class=\"hljs-comment\">// ...</span>\n}\n</code></pre><p>Note the differences:</p>\n<ol>\n<li>Resource and action order is swapped: <code>can(&quot;update&quot;, &quot;document&quot;)</code> vs <code>permissions.can(&quot;document&quot;, &quot;update&quot;)</code></li>\n<li>Use <code>subject()</code> helper to wrap data for condition checking</li>\n</ol>\n<blockquote>\n<p>Why the <code>subject()</code> wrapper? CASL needs to know what <em>type</em> of object you&#39;re checking. Our custom implementation knew because we passed the resource name first. CASL uses class names by default, but since we&#39;re using plain objects, we need to tell it explicitly.</p>\n</blockquote>\n<h2>Field-Level Permissions with CASL</h2>\n<p>CASL has built-in support for field permissions:</p>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-comment\">// Define which fields each permission applies to</span>\n<span class=\"hljs-title function_\">can</span>(<span class=\"hljs-string\">&quot;update&quot;</span>, <span class=\"hljs-string\">&quot;document&quot;</span>, [<span class=\"hljs-string\">&quot;title&quot;</span>, <span class=\"hljs-string\">&quot;content&quot;</span>, <span class=\"hljs-string\">&quot;status&quot;</span>], { <span class=\"hljs-attr\">isLocked</span>: <span class=\"hljs-literal\">false</span> })\n\n<span class=\"hljs-comment\">// Check field permission</span>\nability.<span class=\"hljs-title function_\">can</span>(<span class=\"hljs-string\">&quot;update&quot;</span>, <span class=\"hljs-title function_\">subject</span>(<span class=\"hljs-string\">&quot;document&quot;</span>, <span class=\"hljs-variable language_\">document</span>), <span class=\"hljs-string\">&quot;status&quot;</span>)\n</code></pre><h2>CASL Bonus Features</h2>\n<h3>1. Rule Serialization</h3>\n<p>You can serialize CASL permissions to JSON and send them to the client:</p>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-comment\">// Server: send ability rules to the client</span>\n<span class=\"hljs-keyword\">const</span> permissions = <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title function_\">getUserPermissions</span>()\n<span class=\"hljs-keyword\">const</span> rules = permissions.<span class=\"hljs-property\">rules</span>\n\n<span class=\"hljs-comment\">// Client: recreate ability from rules</span>\n<span class=\"hljs-keyword\">import</span> { createMongoAbility } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;@casl/ability&quot;</span>\n<span class=\"hljs-keyword\">const</span> clientPermissions = <span class=\"hljs-title function_\">createMongoAbility</span>(rules)\n</code></pre><p>This enables client-side permission checks without an API call.</p>\n<h3>2. Advanced Conditions</h3>\n<p>CASL supports MongoDB-style query operators:</p>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-title function_\">can</span>(<span class=\"hljs-string\">&quot;read&quot;</span>, <span class=\"hljs-string\">&quot;document&quot;</span>, { <span class=\"hljs-attr\">status</span>: { <span class=\"hljs-attr\">$ne</span>: <span class=\"hljs-string\">&quot;archived&quot;</span> } }) <span class=\"hljs-comment\">// not equal</span>\n<span class=\"hljs-title function_\">can</span>(<span class=\"hljs-string\">&quot;read&quot;</span>, <span class=\"hljs-string\">&quot;document&quot;</span>, { <span class=\"hljs-attr\">status</span>: { <span class=\"hljs-attr\">$in</span>: [<span class=\"hljs-string\">&quot;published&quot;</span>, <span class=\"hljs-string\">&quot;draft&quot;</span>] } }) <span class=\"hljs-comment\">// in array</span>\n</code></pre><h2>CASL Drawbacks</h2>\n<p>CASL is great at many things, but since it was created as a backend Node focused project it struggles when used with frontend frameworks like React or Next.js due to its reliance on classes.</p>\n<h3>1. Reliance on Classes</h3>\n<p>CASL uses class names to determine which permissions to check on an object. Since we&#39;re using plain objects (not class instances), permissions don&#39;t work by default which is why we need the <code>subject()</code> wrapper everywhere.</p>\n<h3>2. React Server Component Compatibility</h3>\n<p>The <code>subject()</code> function unfortunately, mutates our objects in a way that is incompatible with React Server components. There are two workarounds:</p>\n<p><strong>Option A: Spread into a new object</strong></p>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-comment\">// Always create a new object before passing to subject()</span>\nability.<span class=\"hljs-title function_\">can</span>(<span class=\"hljs-string\">&quot;update&quot;</span>, <span class=\"hljs-title function_\">subject</span>(<span class=\"hljs-string\">&quot;document&quot;</span>, { ...<span class=\"hljs-variable language_\">document</span> }))\n</code></pre><p><strong>Option B: Use <code>detectSubjectType</code></strong></p>\n<p>Configure CASL to detect subject types without mutation:</p>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-keyword\">const</span> ability = <span class=\"hljs-title function_\">createMongoAbility</span>(rules, {\n  <span class=\"hljs-attr\">detectSubjectType</span>: <span class=\"hljs-function\">(<span class=\"hljs-params\"><span class=\"hljs-built_in\">object</span></span>) =&gt;</span> {\n    <span class=\"hljs-comment\">// Check for a type property we add ourselves</span>\n    <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-built_in\">object</span> &amp;&amp; <span class=\"hljs-keyword\">typeof</span> <span class=\"hljs-built_in\">object</span> === <span class=\"hljs-string\">&quot;object&quot;</span> &amp;&amp; <span class=\"hljs-string\">&quot;__typename&quot;</span> <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">object</span>) {\n      <span class=\"hljs-keyword\">return</span> <span class=\"hljs-built_in\">object</span>.<span class=\"hljs-property\">__typename</span> <span class=\"hljs-keyword\">as</span> <span class=\"hljs-built_in\">string</span>\n    }\n    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">undefined</span>\n  },\n})\n\n<span class=\"hljs-comment\">// In your queries, add __typename to returned objects</span>\n<span class=\"hljs-keyword\">const</span> <span class=\"hljs-variable language_\">document</span> = <span class=\"hljs-keyword\">await</span> db.<span class=\"hljs-property\">query</span>.<span class=\"hljs-property\">documents</span>.<span class=\"hljs-title function_\">findFirst</span>({\n  <span class=\"hljs-attr\">where</span>: <span class=\"hljs-title function_\">eq</span>(documents.<span class=\"hljs-property\">id</span>, id),\n})\n\n<span class=\"hljs-keyword\">return</span> { ...<span class=\"hljs-variable language_\">document</span>, <span class=\"hljs-attr\">__typename</span>: <span class=\"hljs-string\">&quot;document&quot;</span> <span class=\"hljs-keyword\">as</span> <span class=\"hljs-keyword\">const</span> }\n</code></pre><p>This approach adds a small overhead but makes consuming CASL permissions easier.</p>\n<h2>Branch Checkpoint</h2>\n<p>After completing this lesson, your code should match:</p>\n<pre><code class=\"hljs language-bash\"><button class=\"copy-btn\">Copy</button>git checkout 7-casl\n</code></pre><h2>Summary</h2>\n<p>Migrating to CASL gives us:</p>\n<ul>\n<li>✅ Battle-tested permission library</li>\n<li>✅ Built-in field-level permissions</li>\n<li>✅ Community support and documentation</li>\n</ul>\n<p>The concepts are identical to what we built, but using a library like CASL can give you extra functionality and make it easier to work with on a larger team.</p>\n","markdown":"\nLet's upgrade our custom ABAC implementation to use CASL.\n\n## Installing CASL\n\nFirst, install the CASL packages:\n\n```bash\nnpm install @casl/ability\n```\n\n## Updating the Permission Module\n\n### Key Changes\n\nHere's what changes when migrating to CASL:\n\n```typescript\n// BEFORE (custom): resource first, action second\nbuilder.can(\"document\", \"read\")\nbuilder.can(\"document\", \"read\", { status: \"published\" }, [\"title\", \"content\"])\n\n// AFTER (CASL): action first, resource second, fields before conditions\ncan(\"read\", \"document\")\ncan(\"read\", \"document\", [\"title\", \"content\"], { status: \"published\" })\n```\n\n### Type Setup\n\nCASL needs types to understand your resources which are broken down into subjects and actions:\n\n```typescript\ntype FullCRUD = \"create\" | \"read\" | \"update\" | \"delete\"\ntype ProjectSubject = \"project\" | Pick<Project, \"department\">\ntype DocumentSubject =\n  | \"document\"\n  | Pick<Document, \"projectId\" | \"creatorId\" | \"status\" | \"isLocked\">\n\ntype MyAbility = MongoAbility<\n  [FullCRUD, ProjectSubject] | [FullCRUD, DocumentSubject]\n>\n```\n\n### Building Permissions\n\n```typescript\nasync function getUserPermissionsInternal(user: User) {\n  const { can: allow, build } = new AbilityBuilder<MyAbility>(\n    createMongoAbility,\n  )\n\n  if (user.role === \"admin\") {\n    allow(\"read\", \"document\")\n    allow(\"read\", \"project\")\n  }\n\n  if (user.role === \"viewer\") {\n    // Fields come BEFORE conditions in CASL\n    allow(\"read\", \"document\", [\"title\", \"content\"], { status: \"published\" })\n  }\n\n  return build()\n}\n```\n\n## Using CASL in Components\n\nThe usage pattern is almost identical, with one key difference:\n\n```typescript\n// Custom: pass object directly\nif (permissions.can(\"document\", \"update\", document)) {\n  // ...\n}\n\n// CASL: wrap object with subject() helper\nimport { subject } from \"@casl/ability\"\n\nif (ability.can(\"update\", subject(\"document\", document))) {\n  // ...\n}\n```\n\nNote the differences:\n\n1. Resource and action order is swapped: `can(\"update\", \"document\")` vs `permissions.can(\"document\", \"update\")`\n2. Use `subject()` helper to wrap data for condition checking\n\n> Why the `subject()` wrapper? CASL needs to know what _type_ of object you're checking. Our custom implementation knew because we passed the resource name first. CASL uses class names by default, but since we're using plain objects, we need to tell it explicitly.\n\n## Field-Level Permissions with CASL\n\nCASL has built-in support for field permissions:\n\n```typescript\n// Define which fields each permission applies to\ncan(\"update\", \"document\", [\"title\", \"content\", \"status\"], { isLocked: false })\n\n// Check field permission\nability.can(\"update\", subject(\"document\", document), \"status\")\n```\n\n## CASL Bonus Features\n\n### 1. Rule Serialization\n\nYou can serialize CASL permissions to JSON and send them to the client:\n\n```typescript\n// Server: send ability rules to the client\nconst permissions = await getUserPermissions()\nconst rules = permissions.rules\n\n// Client: recreate ability from rules\nimport { createMongoAbility } from \"@casl/ability\"\nconst clientPermissions = createMongoAbility(rules)\n```\n\nThis enables client-side permission checks without an API call.\n\n### 2. Advanced Conditions\n\nCASL supports MongoDB-style query operators:\n\n```typescript\ncan(\"read\", \"document\", { status: { $ne: \"archived\" } }) // not equal\ncan(\"read\", \"document\", { status: { $in: [\"published\", \"draft\"] } }) // in array\n```\n\n## CASL Drawbacks\n\nCASL is great at many things, but since it was created as a backend Node focused project it struggles when used with frontend frameworks like React or Next.js due to its reliance on classes.\n\n### 1. Reliance on Classes\n\nCASL uses class names to determine which permissions to check on an object. Since we're using plain objects (not class instances), permissions don't work by default which is why we need the `subject()` wrapper everywhere.\n\n### 2. React Server Component Compatibility\n\nThe `subject()` function unfortunately, mutates our objects in a way that is incompatible with React Server components. There are two workarounds:\n\n**Option A: Spread into a new object**\n\n```typescript\n// Always create a new object before passing to subject()\nability.can(\"update\", subject(\"document\", { ...document }))\n```\n\n**Option B: Use `detectSubjectType`**\n\nConfigure CASL to detect subject types without mutation:\n\n```typescript\nconst ability = createMongoAbility(rules, {\n  detectSubjectType: (object) => {\n    // Check for a type property we add ourselves\n    if (object && typeof object === \"object\" && \"__typename\" in object) {\n      return object.__typename as string\n    }\n    return undefined\n  },\n})\n\n// In your queries, add __typename to returned objects\nconst document = await db.query.documents.findFirst({\n  where: eq(documents.id, id),\n})\n\nreturn { ...document, __typename: \"document\" as const }\n```\n\nThis approach adds a small overhead but makes consuming CASL permissions easier.\n\n## Branch Checkpoint\n\nAfter completing this lesson, your code should match:\n\n```bash\ngit checkout 7-casl\n```\n\n## Summary\n\nMigrating to CASL gives us:\n\n- ✅ Battle-tested permission library\n- ✅ Built-in field-level permissions\n- ✅ Community support and documentation\n\nThe concepts are identical to what we built, but using a library like CASL can give you extra functionality and make it easier to work with on a larger team.\n","slug":"upgrading-to-casl","title":"Upgrading to CASL","section":"Permission Libraries","icon":"cubes","filePath":"/home/runner/work/fem-permission-systems-that-scale/fem-permission-systems-that-scale/lessons/05-permission-libraries/B-upgrading-to-casl.md","nextSlug":"/fem-permission-systems-that-scale/lessons/rebac/what-is-rebac","prevSlug":"/fem-permission-systems-that-scale/lessons/permission-libraries/why-use-a-library"}},"__N_SSG":true}
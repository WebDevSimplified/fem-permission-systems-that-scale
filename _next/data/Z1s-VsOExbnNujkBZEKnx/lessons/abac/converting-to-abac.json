{"pageProps":{"post":{"attributes":{"title":"Converting to ABAC"},"html":"<p>Let&#39;s convert our RBAC system to ABAC. This first pass will have <strong>identical functionality</strong>—we&#39;re just restructuring the code to use an attribute-based model instead of a role-based one.</p>\n<h2>The Goal</h2>\n<p>Replace this hybrid RBAC code:</p>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">canUpdateDocument</span>(<span class=\"hljs-params\">user, <span class=\"hljs-variable language_\">document</span></span>) {\n  <span class=\"hljs-keyword\">if</span> (user.<span class=\"hljs-property\">role</span> === <span class=\"hljs-string\">&quot;admin&quot;</span>) <span class=\"hljs-keyword\">return</span> !<span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-property\">isLocked</span>\n  <span class=\"hljs-keyword\">if</span> (user.<span class=\"hljs-property\">role</span> === <span class=\"hljs-string\">&quot;editor&quot;</span>) <span class=\"hljs-keyword\">return</span> !<span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-property\">isLocked</span>\n  <span class=\"hljs-keyword\">if</span> (user.<span class=\"hljs-property\">role</span> === <span class=\"hljs-string\">&quot;author&quot;</span>) {\n    <span class=\"hljs-keyword\">return</span> (\n      <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-property\">creatorId</span> === user.<span class=\"hljs-property\">id</span> &amp;&amp;\n      !<span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-property\">isLocked</span> &amp;&amp;\n      <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-property\">status</span> === <span class=\"hljs-string\">&quot;draft&quot;</span>\n    )\n  }\n  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">false</span>\n}\n</code></pre><p>With a unified ABAC API:</p>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-comment\">// Single ABAC check handles everything</span>\n<span class=\"hljs-keyword\">if</span> (!permissions.<span class=\"hljs-title function_\">can</span>(<span class=\"hljs-string\">&quot;document&quot;</span>, <span class=\"hljs-string\">&quot;update&quot;</span>, <span class=\"hljs-variable language_\">document</span>)) {\n  <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">AuthorizationError</span>()\n}\n</code></pre><h2>How ABAC Works</h2>\n<p>In ABAC, we evaluate <strong>attributes</strong> from multiple sources to make access decisions:</p>\n<p><img src=\"/fem-permission-systems-that-scale/images/04-abac/abac-flow.svg\" alt=\"ABAC Flow\"></p>\n<p>Policies evaluate attributes from both subject and resource to make decisions. The key difference from RBAC: instead of looking up permissions by role alone, we evaluate <strong>conditions</strong> against the actual data at runtime.</p>\n<h2>Step 1: Create the ABAC Module</h2>\n<p>Here&#39;s the core idea in minimal code:</p>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-comment\">// 1. Build permissions with conditions</span>\n<span class=\"hljs-keyword\">const</span> builder = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">PermissionBuilder</span>()\nbuilder.<span class=\"hljs-title function_\">allow</span>(<span class=\"hljs-string\">&quot;document&quot;</span>, <span class=\"hljs-string\">&quot;update&quot;</span>, { <span class=\"hljs-attr\">creatorId</span>: user.<span class=\"hljs-property\">id</span>, <span class=\"hljs-attr\">isLocked</span>: <span class=\"hljs-literal\">false</span> })\n<span class=\"hljs-keyword\">const</span> permissions = builder.<span class=\"hljs-title function_\">build</span>()\n\n<span class=\"hljs-comment\">// 2. Check against actual resource data</span>\npermissions.<span class=\"hljs-title function_\">can</span>(<span class=\"hljs-string\">&quot;document&quot;</span>, <span class=\"hljs-string\">&quot;update&quot;</span>, <span class=\"hljs-variable language_\">document</span>) <span class=\"hljs-comment\">// true if all conditions match</span>\n</code></pre><p>The <code>allow()</code> call says &quot;this user can update documents <strong>where</strong> they&#39;re the creator AND it&#39;s not locked.&quot; The <code>can()</code> call evaluates those conditions against the actual document.</p>\n<h3>The Entry Point</h3>\n<p>We&#39;ll create <code>src/permissions/abac.ts</code>. The entry point routes to role-specific policy builders:</p>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-comment\">// src/permissions/abac.ts</span>\n\n<span class=\"hljs-keyword\">import</span> { <span class=\"hljs-title class_\">Document</span>, <span class=\"hljs-title class_\">Project</span>, <span class=\"hljs-title class_\">User</span> } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;@/drizzle/schema&quot;</span>\n\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">getUserPermissions</span>(<span class=\"hljs-params\">\n  <span class=\"hljs-attr\">user</span>: <span class=\"hljs-title class_\">Pick</span>&lt;<span class=\"hljs-title class_\">User</span>, <span class=\"hljs-string\">&quot;department&quot;</span> | <span class=\"hljs-string\">&quot;id&quot;</span> | <span class=\"hljs-string\">&quot;role&quot;</span>&gt; | <span class=\"hljs-literal\">null</span>,\n</span>) {\n  <span class=\"hljs-keyword\">const</span> builder = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">PermissionBuilder</span>()\n  <span class=\"hljs-keyword\">if</span> (user == <span class=\"hljs-literal\">null</span>) <span class=\"hljs-keyword\">return</span> builder.<span class=\"hljs-title function_\">build</span>()\n\n  <span class=\"hljs-comment\">// Add role-specific permissions...</span>\n\n  <span class=\"hljs-keyword\">return</span> builder.<span class=\"hljs-title function_\">build</span>()\n}\n</code></pre><h2>Step 2: Define Role-Specific Policies</h2>\n<p>Next we need to define the policies for each role.</p>\n<h3>Editor Permissions Example</h3>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button>builder\n  <span class=\"hljs-comment\">// Can read projects in their department or global projects</span>\n  .<span class=\"hljs-title function_\">allow</span>(<span class=\"hljs-string\">&quot;project&quot;</span>, <span class=\"hljs-string\">&quot;read&quot;</span>, { <span class=\"hljs-attr\">department</span>: user.<span class=\"hljs-property\">department</span> })\n  .<span class=\"hljs-title function_\">allow</span>(<span class=\"hljs-string\">&quot;project&quot;</span>, <span class=\"hljs-string\">&quot;read&quot;</span>, { <span class=\"hljs-attr\">department</span>: <span class=\"hljs-literal\">null</span> })\n  <span class=\"hljs-comment\">// Can read all documents, edit unlocked ones</span>\n  .<span class=\"hljs-title function_\">allow</span>(<span class=\"hljs-string\">&quot;document&quot;</span>, <span class=\"hljs-string\">&quot;read&quot;</span>)\n  .<span class=\"hljs-title function_\">allow</span>(<span class=\"hljs-string\">&quot;document&quot;</span>, <span class=\"hljs-string\">&quot;update&quot;</span>, { <span class=\"hljs-attr\">isLocked</span>: <span class=\"hljs-literal\">false</span> })\n</code></pre><p>Look at that last <code>.allow()</code> call: &quot;editors can update documents that are unlocked.&quot; In RBAC, this would require a helper function with manual attribute checks. In ABAC, it&#39;s declarative.</p>\n<h2>Step 3: The Permission Builder</h2>\n<p>The builder pattern makes policies easy to compose. Let&#39;s build it piece by piece.</p>\n<h3>Type Definitions</h3>\n<p>First, we define what resources exist and what attributes they have:</p>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-keyword\">type</span> <span class=\"hljs-title class_\">Resources</span> = {\n  <span class=\"hljs-attr\">project</span>: {\n    <span class=\"hljs-attr\">action</span>: <span class=\"hljs-string\">&quot;create&quot;</span> | <span class=\"hljs-string\">&quot;read&quot;</span> | <span class=\"hljs-string\">&quot;update&quot;</span> | <span class=\"hljs-string\">&quot;delete&quot;</span>\n    <span class=\"hljs-attr\">condition</span>: <span class=\"hljs-title class_\">Pick</span>&lt;<span class=\"hljs-title class_\">Project</span>, <span class=\"hljs-string\">&quot;department&quot;</span>&gt;\n  }\n  <span class=\"hljs-attr\">document</span>: {\n    <span class=\"hljs-attr\">action</span>: <span class=\"hljs-string\">&quot;create&quot;</span> | <span class=\"hljs-string\">&quot;read&quot;</span> | <span class=\"hljs-string\">&quot;update&quot;</span> | <span class=\"hljs-string\">&quot;delete&quot;</span>\n    <span class=\"hljs-attr\">condition</span>: <span class=\"hljs-title class_\">Pick</span>&lt;<span class=\"hljs-title class_\">Document</span>, <span class=\"hljs-string\">&quot;projectId&quot;</span> | <span class=\"hljs-string\">&quot;creatorId&quot;</span> | <span class=\"hljs-string\">&quot;status&quot;</span> | <span class=\"hljs-string\">&quot;isLocked&quot;</span>&gt;\n  }\n}\n</code></pre><p>This gives us type safety: TypeScript knows that <code>project</code> conditions can only include <code>department</code>, while <code>document</code> conditions can include <code>status</code>, <code>isLocked</code>, etc.</p>\n<h3>The <code>allow()</code> Method</h3>\n<p>The <code>allow()</code> method accumulates permission rules:</p>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">PermissionBuilder</span> {\n  #<span class=\"hljs-attr\">permissions</span>: <span class=\"hljs-title class_\">PermissionStore</span> = {\n    <span class=\"hljs-attr\">project</span>: [],\n    <span class=\"hljs-attr\">document</span>: [],\n  }\n\n  allow&lt;<span class=\"hljs-title class_\">Res</span> <span class=\"hljs-keyword\">extends</span> keyof <span class=\"hljs-title class_\">Resources</span>&gt;(\n    <span class=\"hljs-attr\">resource</span>: <span class=\"hljs-title class_\">Res</span>,\n    <span class=\"hljs-attr\">action</span>: <span class=\"hljs-title class_\">Resources</span>[<span class=\"hljs-title class_\">Res</span>][<span class=\"hljs-string\">&quot;action&quot;</span>],\n    <span class=\"hljs-attr\">condition</span>?: <span class=\"hljs-title class_\">Partial</span>&lt;<span class=\"hljs-title class_\">Resources</span>[<span class=\"hljs-title class_\">Res</span>][<span class=\"hljs-string\">&quot;condition&quot;</span>]&gt;,\n  ) {\n    <span class=\"hljs-variable language_\">this</span>.#permissions[resource].<span class=\"hljs-title function_\">push</span>({ action, condition })\n    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-variable language_\">this</span> <span class=\"hljs-comment\">// Enable chaining: .allow(...).allow(...)</span>\n  }\n}\n</code></pre><h3>The <code>can()</code> Method</h3>\n<p>The <code>can()</code> method is where the magic happens—it evaluates conditions against actual data:</p>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-title function_\">build</span>(<span class=\"hljs-params\"></span>) {\n  <span class=\"hljs-keyword\">const</span> permissions = <span class=\"hljs-variable language_\">this</span>.#permissions\n\n  <span class=\"hljs-keyword\">return</span> {\n    can&lt;<span class=\"hljs-title class_\">Res</span> <span class=\"hljs-keyword\">extends</span> keyof <span class=\"hljs-title class_\">Resources</span>&gt;(\n      <span class=\"hljs-attr\">resource</span>: <span class=\"hljs-title class_\">Res</span>,\n      <span class=\"hljs-attr\">action</span>: <span class=\"hljs-title class_\">Resources</span>[<span class=\"hljs-title class_\">Res</span>][<span class=\"hljs-string\">&quot;action&quot;</span>],\n      <span class=\"hljs-attr\">data</span>?: <span class=\"hljs-title class_\">Resources</span>[<span class=\"hljs-title class_\">Res</span>][<span class=\"hljs-string\">&quot;condition&quot;</span>],\n    ) {\n      <span class=\"hljs-keyword\">return</span> permissions[resource].<span class=\"hljs-title function_\">some</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">perm</span>) =&gt;</span> {\n        <span class=\"hljs-comment\">// Must match the requested action</span>\n        <span class=\"hljs-keyword\">if</span> (perm.<span class=\"hljs-property\">action</span> !== action) <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">false</span>\n\n        <span class=\"hljs-comment\">// No condition = always allowed for this action</span>\n        <span class=\"hljs-keyword\">if</span> (perm.<span class=\"hljs-property\">condition</span> == <span class=\"hljs-literal\">null</span>) <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">true</span>\n\n        <span class=\"hljs-comment\">// No data provided = just checking if action is possible</span>\n        <span class=\"hljs-keyword\">if</span> (data == <span class=\"hljs-literal\">null</span>) <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">true</span>\n\n        <span class=\"hljs-comment\">// Check all conditions match the resource</span>\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-title class_\">Object</span>.<span class=\"hljs-title function_\">entries</span>(perm.<span class=\"hljs-property\">condition</span>).<span class=\"hljs-title function_\">every</span>(\n          <span class=\"hljs-function\">(<span class=\"hljs-params\">[key, value]</span>) =&gt;</span> data[key <span class=\"hljs-keyword\">as</span> keyof <span class=\"hljs-keyword\">typeof</span> data] === value,\n        )\n      })\n    },\n  }\n}\n</code></pre><p>The algorithm:</p>\n<ol>\n<li>Find any permission matching the action</li>\n<li>If that permission has no conditions, allow immediately</li>\n<li>Otherwise, verify every condition matches the resource&#39;s attributes</li>\n</ol>\n<h2>Step 4: Update the Codebase</h2>\n<p>Now we replace all permission checks with the new API.</p>\n<h3>Before (Page Component)</h3>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-keyword\">import</span> { can } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;@/permissions/rbac&quot;</span>\n<span class=\"hljs-keyword\">import</span> { canReadProject } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;@/permissions/projects&quot;</span>\n<span class=\"hljs-keyword\">import</span> { canUpdateDocument } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;@/permissions/documents&quot;</span>\n\n<span class=\"hljs-keyword\">const</span> user = <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title function_\">getCurrentUser</span>()\n<span class=\"hljs-keyword\">if</span> (!<span class=\"hljs-title function_\">canReadProject</span>(user, project)) {\n  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-title function_\">redirect</span>(<span class=\"hljs-string\">&quot;/&quot;</span>)\n}\n<span class=\"hljs-keyword\">if</span> (!<span class=\"hljs-title function_\">canUpdateDocument</span>(user, <span class=\"hljs-variable language_\">document</span>)) {\n  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-title function_\">redirect</span>(<span class=\"hljs-string\">`/projects/<span class=\"hljs-subst\">${projectId}</span>`</span>)\n}\n</code></pre><h3>After (Page Component)</h3>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-keyword\">import</span> { getUserPermissions } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;@/permissions/abac&quot;</span>\n\n<span class=\"hljs-keyword\">const</span> user = <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title function_\">getCurrentUser</span>()\n<span class=\"hljs-keyword\">const</span> permissions = <span class=\"hljs-title function_\">getUserPermissions</span>(user)\n\n<span class=\"hljs-keyword\">if</span> (!permissions.<span class=\"hljs-title function_\">can</span>(<span class=\"hljs-string\">&quot;project&quot;</span>, <span class=\"hljs-string\">&quot;read&quot;</span>, project)) {\n  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-title function_\">redirect</span>(<span class=\"hljs-string\">&quot;/&quot;</span>)\n}\n<span class=\"hljs-keyword\">if</span> (!permissions.<span class=\"hljs-title function_\">can</span>(<span class=\"hljs-string\">&quot;document&quot;</span>, <span class=\"hljs-string\">&quot;update&quot;</span>, <span class=\"hljs-variable language_\">document</span>)) {\n  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-title function_\">redirect</span>(<span class=\"hljs-string\">`/projects/<span class=\"hljs-subst\">${projectId}</span>`</span>)\n}\n</code></pre><h3>Before (Mutation)</h3>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-keyword\">import</span> { can } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;@/permissions/rbac&quot;</span>\n<span class=\"hljs-keyword\">import</span> { canUpdateDocument } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;@/permissions/documents&quot;</span>\n\n<span class=\"hljs-keyword\">const</span> user = <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title function_\">getCurrentUser</span>()\n<span class=\"hljs-keyword\">const</span> <span class=\"hljs-variable language_\">document</span> = <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title function_\">getDocumentById</span>(documentId)\n<span class=\"hljs-keyword\">if</span> (!<span class=\"hljs-title function_\">canUpdateDocument</span>(user, <span class=\"hljs-variable language_\">document</span>)) {\n  <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">AuthorizationError</span>()\n}\n</code></pre><h3>After (Mutation)</h3>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-keyword\">import</span> { getUserPermissions } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;@/permissions/abac&quot;</span>\n\n<span class=\"hljs-keyword\">const</span> user = <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title function_\">getCurrentUser</span>()\n<span class=\"hljs-keyword\">const</span> permissions = <span class=\"hljs-title function_\">getUserPermissions</span>(user)\n<span class=\"hljs-keyword\">const</span> <span class=\"hljs-variable language_\">document</span> = <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title function_\">getDocumentById</span>(documentId)\n\n<span class=\"hljs-keyword\">if</span> (!permissions.<span class=\"hljs-title function_\">can</span>(<span class=\"hljs-string\">&quot;document&quot;</span>, <span class=\"hljs-string\">&quot;update&quot;</span>, <span class=\"hljs-variable language_\">document</span>)) {\n  <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">AuthorizationError</span>()\n}\n</code></pre><h2>What We Gain</h2>\n<table>\n<thead>\n<tr>\n<th>Benefit</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>Unified API</strong></td>\n<td>One <code>can()</code> function for all checks</td>\n</tr>\n<tr>\n<td><strong>Declarative policies</strong></td>\n<td>Conditions describe what&#39;s allowed</td>\n</tr>\n<tr>\n<td><strong>No helper functions</strong></td>\n<td>No more <code>canUpdateDocument</code>, <code>canReadProject</code>, etc.</td>\n</tr>\n<tr>\n<td><strong>Type safety</strong></td>\n<td>TypeScript enforces valid resources, actions, and conditions</td>\n</tr>\n<tr>\n<td><strong>Composable</strong></td>\n<td>Easy to add new conditions without new permission strings</td>\n</tr>\n</tbody></table>\n<h2>What We Delete</h2>\n<p>With ABAC in place, we can remove:</p>\n<ul>\n<li><code>src/permissions/rbac.ts</code> - The old RBAC module</li>\n<li><code>src/permissions/documents.ts</code> - The document helper functions</li>\n<li><code>src/permissions/projects.ts</code> - The project helper functions</li>\n</ul>\n<p>Everything is now in <code>src/permissions/abac.ts</code>.</p>\n<h2>Branch Checkpoint</h2>\n<p>After completing this conversion, your code should match:</p>\n<pre><code class=\"hljs language-text\"><button class=\"copy-btn\">Copy</button>Branch: 5-abac-basic\n</code></pre><p>Run the following to sync up:</p>\n<pre><code class=\"hljs language-bash\"><button class=\"copy-btn\">Copy</button>git checkout 5-abac-basic\n</code></pre><h2>What&#39;s Next</h2>\n<p>This basic ABAC system has the same functionality as our RBAC + helpers approach, just with cleaner architecture. In the next lesson, we&#39;ll add <strong>advanced features</strong> that ABAC makes possible—like field-level permissions and automatic query filtering.</p>\n","markdown":"\nLet's convert our RBAC system to ABAC. This first pass will have **identical functionality**—we're just restructuring the code to use an attribute-based model instead of a role-based one.\n\n## The Goal\n\nReplace this hybrid RBAC code:\n\n```typescript\nexport function canUpdateDocument(user, document) {\n  if (user.role === \"admin\") return !document.isLocked\n  if (user.role === \"editor\") return !document.isLocked\n  if (user.role === \"author\") {\n    return (\n      document.creatorId === user.id &&\n      !document.isLocked &&\n      document.status === \"draft\"\n    )\n  }\n  return false\n}\n```\n\nWith a unified ABAC API:\n\n```typescript\n// Single ABAC check handles everything\nif (!permissions.can(\"document\", \"update\", document)) {\n  throw new AuthorizationError()\n}\n```\n\n## How ABAC Works\n\nIn ABAC, we evaluate **attributes** from multiple sources to make access decisions:\n\n![ABAC Flow](/fem-permission-systems-that-scale/images/04-abac/abac-flow.svg)\n\nPolicies evaluate attributes from both subject and resource to make decisions. The key difference from RBAC: instead of looking up permissions by role alone, we evaluate **conditions** against the actual data at runtime.\n\n## Step 1: Create the ABAC Module\n\nHere's the core idea in minimal code:\n\n```typescript\n// 1. Build permissions with conditions\nconst builder = new PermissionBuilder()\nbuilder.allow(\"document\", \"update\", { creatorId: user.id, isLocked: false })\nconst permissions = builder.build()\n\n// 2. Check against actual resource data\npermissions.can(\"document\", \"update\", document) // true if all conditions match\n```\n\nThe `allow()` call says \"this user can update documents **where** they're the creator AND it's not locked.\" The `can()` call evaluates those conditions against the actual document.\n\n### The Entry Point\n\nWe'll create `src/permissions/abac.ts`. The entry point routes to role-specific policy builders:\n\n```typescript\n// src/permissions/abac.ts\n\nimport { Document, Project, User } from \"@/drizzle/schema\"\n\nexport function getUserPermissions(\n  user: Pick<User, \"department\" | \"id\" | \"role\"> | null,\n) {\n  const builder = new PermissionBuilder()\n  if (user == null) return builder.build()\n\n  // Add role-specific permissions...\n\n  return builder.build()\n}\n```\n\n## Step 2: Define Role-Specific Policies\n\nNext we need to define the policies for each role.\n\n### Editor Permissions Example\n\n```typescript\nbuilder\n  // Can read projects in their department or global projects\n  .allow(\"project\", \"read\", { department: user.department })\n  .allow(\"project\", \"read\", { department: null })\n  // Can read all documents, edit unlocked ones\n  .allow(\"document\", \"read\")\n  .allow(\"document\", \"update\", { isLocked: false })\n```\n\nLook at that last `.allow()` call: \"editors can update documents that are unlocked.\" In RBAC, this would require a helper function with manual attribute checks. In ABAC, it's declarative.\n\n## Step 3: The Permission Builder\n\nThe builder pattern makes policies easy to compose. Let's build it piece by piece.\n\n### Type Definitions\n\nFirst, we define what resources exist and what attributes they have:\n\n```typescript\ntype Resources = {\n  project: {\n    action: \"create\" | \"read\" | \"update\" | \"delete\"\n    condition: Pick<Project, \"department\">\n  }\n  document: {\n    action: \"create\" | \"read\" | \"update\" | \"delete\"\n    condition: Pick<Document, \"projectId\" | \"creatorId\" | \"status\" | \"isLocked\">\n  }\n}\n```\n\nThis gives us type safety: TypeScript knows that `project` conditions can only include `department`, while `document` conditions can include `status`, `isLocked`, etc.\n\n### The `allow()` Method\n\nThe `allow()` method accumulates permission rules:\n\n```typescript\nclass PermissionBuilder {\n  #permissions: PermissionStore = {\n    project: [],\n    document: [],\n  }\n\n  allow<Res extends keyof Resources>(\n    resource: Res,\n    action: Resources[Res][\"action\"],\n    condition?: Partial<Resources[Res][\"condition\"]>,\n  ) {\n    this.#permissions[resource].push({ action, condition })\n    return this // Enable chaining: .allow(...).allow(...)\n  }\n}\n```\n\n### The `can()` Method\n\nThe `can()` method is where the magic happens—it evaluates conditions against actual data:\n\n```typescript\nbuild() {\n  const permissions = this.#permissions\n\n  return {\n    can<Res extends keyof Resources>(\n      resource: Res,\n      action: Resources[Res][\"action\"],\n      data?: Resources[Res][\"condition\"],\n    ) {\n      return permissions[resource].some((perm) => {\n        // Must match the requested action\n        if (perm.action !== action) return false\n\n        // No condition = always allowed for this action\n        if (perm.condition == null) return true\n\n        // No data provided = just checking if action is possible\n        if (data == null) return true\n\n        // Check all conditions match the resource\n        return Object.entries(perm.condition).every(\n          ([key, value]) => data[key as keyof typeof data] === value,\n        )\n      })\n    },\n  }\n}\n```\n\nThe algorithm:\n\n1. Find any permission matching the action\n2. If that permission has no conditions, allow immediately\n3. Otherwise, verify every condition matches the resource's attributes\n\n## Step 4: Update the Codebase\n\nNow we replace all permission checks with the new API.\n\n### Before (Page Component)\n\n```typescript\nimport { can } from \"@/permissions/rbac\"\nimport { canReadProject } from \"@/permissions/projects\"\nimport { canUpdateDocument } from \"@/permissions/documents\"\n\nconst user = await getCurrentUser()\nif (!canReadProject(user, project)) {\n  return redirect(\"/\")\n}\nif (!canUpdateDocument(user, document)) {\n  return redirect(`/projects/${projectId}`)\n}\n```\n\n### After (Page Component)\n\n```typescript\nimport { getUserPermissions } from \"@/permissions/abac\"\n\nconst user = await getCurrentUser()\nconst permissions = getUserPermissions(user)\n\nif (!permissions.can(\"project\", \"read\", project)) {\n  return redirect(\"/\")\n}\nif (!permissions.can(\"document\", \"update\", document)) {\n  return redirect(`/projects/${projectId}`)\n}\n```\n\n### Before (Mutation)\n\n```typescript\nimport { can } from \"@/permissions/rbac\"\nimport { canUpdateDocument } from \"@/permissions/documents\"\n\nconst user = await getCurrentUser()\nconst document = await getDocumentById(documentId)\nif (!canUpdateDocument(user, document)) {\n  throw new AuthorizationError()\n}\n```\n\n### After (Mutation)\n\n```typescript\nimport { getUserPermissions } from \"@/permissions/abac\"\n\nconst user = await getCurrentUser()\nconst permissions = getUserPermissions(user)\nconst document = await getDocumentById(documentId)\n\nif (!permissions.can(\"document\", \"update\", document)) {\n  throw new AuthorizationError()\n}\n```\n\n## What We Gain\n\n| Benefit                  | Description                                                  |\n| ------------------------ | ------------------------------------------------------------ |\n| **Unified API**          | One `can()` function for all checks                          |\n| **Declarative policies** | Conditions describe what's allowed                           |\n| **No helper functions**  | No more `canUpdateDocument`, `canReadProject`, etc.          |\n| **Type safety**          | TypeScript enforces valid resources, actions, and conditions |\n| **Composable**           | Easy to add new conditions without new permission strings    |\n\n## What We Delete\n\nWith ABAC in place, we can remove:\n\n- `src/permissions/rbac.ts` - The old RBAC module\n- `src/permissions/documents.ts` - The document helper functions\n- `src/permissions/projects.ts` - The project helper functions\n\nEverything is now in `src/permissions/abac.ts`.\n\n## Branch Checkpoint\n\nAfter completing this conversion, your code should match:\n\n```text\nBranch: 5-abac-basic\n```\n\nRun the following to sync up:\n\n```bash\ngit checkout 5-abac-basic\n```\n\n## What's Next\n\nThis basic ABAC system has the same functionality as our RBAC + helpers approach, just with cleaner architecture. In the next lesson, we'll add **advanced features** that ABAC makes possible—like field-level permissions and automatic query filtering.\n","slug":"converting-to-abac","title":"Converting to ABAC","section":"Attribute-Based Access Control (ABAC)","icon":"cog","filePath":"/home/runner/work/fem-permission-systems-that-scale/fem-permission-systems-that-scale/lessons/04-abac/B-converting-to-abac.md","nextSlug":"/fem-permission-systems-that-scale/lessons/abac/advanced-abac-features","prevSlug":"/fem-permission-systems-that-scale/lessons/abac/what-is-abac"}},"__N_SSG":true}
{"pageProps":{"post":{"attributes":{"title":"Advanced ABAC Features"},"html":"<p>Our basic ABAC system works, but real applications need more sophisticated features. Let&#39;s add <strong>field-level permissions</strong> and explore how ABAC can express complex policies.</p>\n<h2>New Requirements</h2>\n<p>In many applications certain users are restricted on which fields they can read or modify. This is something that is impossible to do in RBAC, but ABAC makes these policies straightforward to express using field-level permissions.</p>\n<h3>1. Field-Level Read Permissions</h3>\n<p>Different roles should see different fields on documents:</p>\n<table>\n<thead>\n<tr>\n<th>Field</th>\n<th>Admin</th>\n<th>Editor</th>\n<th>Author</th>\n<th>Viewer</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>title</code></td>\n<td>✅</td>\n<td>✅</td>\n<td>✅</td>\n<td>✅</td>\n</tr>\n<tr>\n<td><code>content</code></td>\n<td>✅</td>\n<td>✅</td>\n<td>✅</td>\n<td>✅</td>\n</tr>\n<tr>\n<td><code>status</code></td>\n<td>✅</td>\n<td>✅</td>\n<td>✅</td>\n<td>✅</td>\n</tr>\n<tr>\n<td><code>isLocked</code></td>\n<td>✅</td>\n<td>✅</td>\n<td>✅</td>\n<td>❌</td>\n</tr>\n<tr>\n<td><code>creatorId</code></td>\n<td>✅</td>\n<td>✅</td>\n<td>✅</td>\n<td>❌</td>\n</tr>\n<tr>\n<td><code>lastEditedById</code></td>\n<td>✅</td>\n<td>✅</td>\n<td>✅</td>\n<td>❌</td>\n</tr>\n<tr>\n<td><code>createdAt</code></td>\n<td>✅</td>\n<td>✅</td>\n<td>✅</td>\n<td>❌</td>\n</tr>\n<tr>\n<td><code>updatedAt</code></td>\n<td>✅</td>\n<td>✅</td>\n<td>✅</td>\n<td>❌</td>\n</tr>\n</tbody></table>\n<h3>2. Field-Level Write Permissions</h3>\n<p>When creating or editing documents, only certain fields should be writable:</p>\n<table>\n<thead>\n<tr>\n<th>Field</th>\n<th>Admin</th>\n<th>Editor</th>\n<th>Author</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>title</code></td>\n<td>✅</td>\n<td>✅</td>\n<td>✅</td>\n</tr>\n<tr>\n<td><code>content</code></td>\n<td>✅</td>\n<td>✅</td>\n<td>✅</td>\n</tr>\n<tr>\n<td><code>status</code></td>\n<td>✅</td>\n<td>✅</td>\n<td>❌</td>\n</tr>\n<tr>\n<td><code>isLocked</code></td>\n<td>✅</td>\n<td>❌</td>\n<td>❌</td>\n</tr>\n</tbody></table>\n<p>Authors can write content but can&#39;t change document status or lock documents.</p>\n<h3>3. 3. Environment-Based Rules</h3>\n<p>Since this company values work-life balance, editors and authors are not allowed to make changes on weekends which is an example of an <strong>environment-based</strong> rule that uses attributes from neither the user nor the resource.</p>\n<h2>Extending the Permission API</h2>\n<p>We need to enhance our <code>can()</code> function to support field checks:</p>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-comment\">// Check if user can read a specific field</span>\npermissions.<span class=\"hljs-title function_\">can</span>(<span class=\"hljs-string\">&quot;document&quot;</span>, <span class=\"hljs-string\">&quot;read&quot;</span>, <span class=\"hljs-variable language_\">document</span>, <span class=\"hljs-string\">&quot;isLocked&quot;</span>)\n\n<span class=\"hljs-comment\">// Check if user can update a specific field</span>\npermissions.<span class=\"hljs-title function_\">can</span>(<span class=\"hljs-string\">&quot;document&quot;</span>, <span class=\"hljs-string\">&quot;update&quot;</span>, <span class=\"hljs-variable language_\">document</span>, <span class=\"hljs-string\">&quot;status&quot;</span>)\n</code></pre><h2>Enhanced Policy Definitions</h2>\n<p>The <code>allow</code> function now accepts an optional fields array as a fourth parameter:</p>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">addEditorPermissions</span>(<span class=\"hljs-params\">\n  <span class=\"hljs-attr\">builder</span>: <span class=\"hljs-title class_\">PermissionBuilder</span>,\n  <span class=\"hljs-attr\">user</span>: <span class=\"hljs-title class_\">Pick</span>&lt;<span class=\"hljs-title class_\">User</span>, <span class=\"hljs-string\">&quot;department&quot;</span>&gt;,\n</span>) {\n  builder.<span class=\"hljs-title function_\">allow</span>(<span class=\"hljs-string\">&quot;document&quot;</span>, <span class=\"hljs-string\">&quot;read&quot;</span>) <span class=\"hljs-comment\">// All fields by default</span>\n\n  builder.<span class=\"hljs-title function_\">allow</span>(\n    <span class=\"hljs-string\">&quot;document&quot;</span>,\n    <span class=\"hljs-string\">&quot;update&quot;</span>,\n    { <span class=\"hljs-attr\">isLocked</span>: <span class=\"hljs-literal\">false</span> }, <span class=\"hljs-comment\">// Condition: only unlocked docs</span>\n    [<span class=\"hljs-string\">&quot;content&quot;</span>, <span class=\"hljs-string\">&quot;title&quot;</span>, <span class=\"hljs-string\">&quot;status&quot;</span>], <span class=\"hljs-comment\">// Restricted to these fields</span>\n  )\n}\n</code></pre><h2>Updating the Permission Builder</h2>\n<p>We only need to change two things in our existing builder:</p>\n<h3>1. Add <code>fields</code> to the <code>allow()</code> method</h3>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button>allow&lt;<span class=\"hljs-title class_\">Res</span> <span class=\"hljs-keyword\">extends</span> keyof <span class=\"hljs-title class_\">Resources</span>&gt;(\n  <span class=\"hljs-attr\">resource</span>: <span class=\"hljs-title class_\">Res</span>,\n  <span class=\"hljs-attr\">action</span>: <span class=\"hljs-title class_\">Resources</span>[<span class=\"hljs-title class_\">Res</span>][<span class=\"hljs-string\">&quot;action&quot;</span>],\n  <span class=\"hljs-attr\">condition</span>?: <span class=\"hljs-title class_\">Partial</span>&lt;<span class=\"hljs-title class_\">Resources</span>[<span class=\"hljs-title class_\">Res</span>][<span class=\"hljs-string\">&quot;condition&quot;</span>]&gt;,\n  <span class=\"hljs-attr\">fields</span>?: <span class=\"hljs-built_in\">string</span>[], <span class=\"hljs-comment\">// NEW: optional field restriction</span>\n) {\n  <span class=\"hljs-variable language_\">this</span>.#permissions[resource].<span class=\"hljs-title function_\">push</span>({ action, condition, fields })\n  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-variable language_\">this</span>\n}\n</code></pre><h3>2. Check fields in <code>can()</code></h3>\n<p>Add this after the condition check passes:</p>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-comment\">// Check field permission (new logic)</span>\n<span class=\"hljs-keyword\">if</span> (field != <span class=\"hljs-literal\">null</span> &amp;&amp; perm.<span class=\"hljs-property\">fields</span> != <span class=\"hljs-literal\">null</span>) {\n  <span class=\"hljs-keyword\">return</span> perm.<span class=\"hljs-property\">fields</span>.<span class=\"hljs-title function_\">includes</span>(field)\n}\n</code></pre><p>The full logic: if a field is requested AND this permission specifies allowed fields, check if the field is in the list. If <code>perm.fields</code> is <code>null</code>, all fields are allowed.</p>\n<h2>Using Field Permissions</h2>\n<p>Adding support for field permissions takes a little bit of TypeScript wizardry and extra work, but for the most part isn&#39;t too bad. Where field permissions become difficult to work with is when consuming which fields a user has access to and ensuring your UI works for all possible permutations.</p>\n<h3>In Forms</h3>\n<p>We compute which fields the user can modify, then pass that info to the form component:</p>\n<pre><code class=\"hljs language-tsx\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-comment\">// Edit document page</span>\n<span class=\"hljs-keyword\">const</span> permissions = <span class=\"hljs-title function_\">getUserPermissions</span>(user)\n\n&lt;<span class=\"hljs-title class_\">DocumentForm</span>\n  <span class=\"hljs-variable language_\">document</span>={<span class=\"hljs-variable language_\">document</span>}\n  projectId={projectId}\n  canModify={{\n    <span class=\"hljs-attr\">status</span>: permissions.<span class=\"hljs-title function_\">can</span>(<span class=\"hljs-string\">&quot;document&quot;</span>, <span class=\"hljs-string\">&quot;update&quot;</span>, <span class=\"hljs-variable language_\">document</span>, <span class=\"hljs-string\">&quot;status&quot;</span>),\n    <span class=\"hljs-attr\">isLocked</span>: permissions.<span class=\"hljs-title function_\">can</span>(<span class=\"hljs-string\">&quot;document&quot;</span>, <span class=\"hljs-string\">&quot;update&quot;</span>, <span class=\"hljs-variable language_\">document</span>, <span class=\"hljs-string\">&quot;isLocked&quot;</span>),\n  }}\n/&gt;\n</code></pre><p>Why pass <code>canModify</code> as a prop instead of checking permissions inside the form? This keeps the form component <strong>pure</strong> since it just renders based on props, making it easier to test and reuse. It also ensures these components are easier to test and reuse.</p>\n<h3>In the Form Component</h3>\n<p>The form conditionally renders fields based on permissions:</p>\n<pre><code class=\"hljs language-tsx\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">DocumentForm</span>(<span class=\"hljs-params\">{ <span class=\"hljs-variable language_\">document</span>, projectId, canModify }</span>) {\n  <span class=\"hljs-keyword\">return</span> (\n    <span class=\"language-xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">Form</span>&gt;</span>\n      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">Input</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">&quot;title&quot;</span> /&gt;</span>\n      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">Textarea</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">&quot;content&quot;</span> /&gt;</span>\n\n      {canModify.status &amp;&amp; (\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">Select</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">&quot;status&quot;</span>&gt;</span>\n          <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">option</span> <span class=\"hljs-attr\">value</span>=<span class=\"hljs-string\">&quot;draft&quot;</span>&gt;</span>Draft<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">option</span>&gt;</span>\n          <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">option</span> <span class=\"hljs-attr\">value</span>=<span class=\"hljs-string\">&quot;published&quot;</span>&gt;</span>Published<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">option</span>&gt;</span>\n          <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">option</span> <span class=\"hljs-attr\">value</span>=<span class=\"hljs-string\">&quot;archived&quot;</span>&gt;</span>Archived<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">option</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">Select</span>&gt;</span>\n      )}\n\n      {canModify.isLocked &amp;&amp; <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">Checkbox</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">&quot;isLocked&quot;</span> <span class=\"hljs-attr\">label</span>=<span class=\"hljs-string\">&quot;Lock document&quot;</span> /&gt;</span>}\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">Form</span>&gt;</span></span>\n  )\n}\n</code></pre><h3>In Display Components</h3>\n<p>For read permissions, we hide fields the user can&#39;t see:</p>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-comment\">// Document detail page</span>\n<span class=\"hljs-keyword\">const</span> permissions = <span class=\"hljs-title function_\">getUserPermissions</span>(user)\n\n<span class=\"hljs-keyword\">const</span> canReadField = {\n  <span class=\"hljs-attr\">isLocked</span>: permissions.<span class=\"hljs-title function_\">can</span>(<span class=\"hljs-string\">&quot;document&quot;</span>, <span class=\"hljs-string\">&quot;read&quot;</span>, <span class=\"hljs-variable language_\">document</span>, <span class=\"hljs-string\">&quot;isLocked&quot;</span>),\n  <span class=\"hljs-attr\">creator</span>: permissions.<span class=\"hljs-title function_\">can</span>(<span class=\"hljs-string\">&quot;document&quot;</span>, <span class=\"hljs-string\">&quot;read&quot;</span>, <span class=\"hljs-variable language_\">document</span>, <span class=\"hljs-string\">&quot;creatorId&quot;</span>),\n}\n\n<span class=\"hljs-comment\">// In JSX</span>\n{canReadField.<span class=\"hljs-property\">isLocked</span> &amp;&amp; <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-property\">isLocked</span> &amp;&amp; (\n  <span class=\"language-xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">Badge</span>&gt;</span>Locked<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">Badge</span>&gt;</span></span>\n)}\n\n{canReadField.<span class=\"hljs-property\">creator</span> &amp;&amp; (\n  <span class=\"language-xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span>&gt;</span>Created by: {document.creator.name}<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span>\n)}\n</code></pre><h2>Filtering Permitted Fields</h2>\n<p>When handling form submissions, we need to filter out fields the user isn&#39;t allowed to modify, even if they try to send them from the client:</p>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-keyword\">function</span> pickPermittedFields&lt;T <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title class_\">Record</span>&lt;<span class=\"hljs-built_in\">string</span>, <span class=\"hljs-built_in\">unknown</span>&gt;&gt;(\n  <span class=\"hljs-attr\">permissions</span>: <span class=\"hljs-title class_\">ReturnType</span>&lt;<span class=\"hljs-keyword\">typeof</span> getUserPermissions&gt;,\n  <span class=\"hljs-attr\">resource</span>: keyof <span class=\"hljs-title class_\">Resources</span>,\n  <span class=\"hljs-attr\">action</span>: <span class=\"hljs-built_in\">string</span>,\n  <span class=\"hljs-attr\">data</span>: T,\n  <span class=\"hljs-attr\">resourceData</span>?: <span class=\"hljs-title class_\">Resources</span>[keyof <span class=\"hljs-title class_\">Resources</span>][<span class=\"hljs-string\">&quot;condition&quot;</span>],\n): <span class=\"hljs-title class_\">Partial</span>&lt;T&gt; {\n  <span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">result</span>: <span class=\"hljs-title class_\">Record</span>&lt;<span class=\"hljs-built_in\">string</span>, <span class=\"hljs-built_in\">unknown</span>&gt; = {}\n\n  <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">const</span> [key, value] <span class=\"hljs-keyword\">of</span> <span class=\"hljs-title class_\">Object</span>.<span class=\"hljs-title function_\">entries</span>(data)) {\n    <span class=\"hljs-keyword\">if</span> (permissions.<span class=\"hljs-title function_\">can</span>(resource, action, resourceData, key)) {\n      result[key] = value\n    }\n  }\n\n  <span class=\"hljs-keyword\">return</span> result <span class=\"hljs-keyword\">as</span> <span class=\"hljs-title class_\">Partial</span>&lt;T&gt;\n}\n</code></pre><p>This is useful during mutations since it ensures security even if someone bypasses the UI:</p>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-keyword\">const</span> restrictedData = <span class=\"hljs-title function_\">pickPermittedFields</span>(\n  permissions,\n  <span class=\"hljs-string\">&quot;document&quot;</span>,\n  <span class=\"hljs-string\">&quot;update&quot;</span>,\n  formData,\n  existingDocument,\n)\n<span class=\"hljs-comment\">// restrictedData only contains fields the user can actually modify</span>\n</code></pre><h2>Implementing Environment Rules</h2>\n<p>For weekend restrictions, we check the current day when building permissions:</p>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">addEditorPermissions</span>(<span class=\"hljs-params\">\n  <span class=\"hljs-attr\">builder</span>: <span class=\"hljs-title class_\">PermissionBuilder</span>,\n  <span class=\"hljs-attr\">user</span>: <span class=\"hljs-title class_\">Pick</span>&lt;<span class=\"hljs-title class_\">User</span>, <span class=\"hljs-string\">&quot;department&quot;</span>&gt;,\n</span>) {\n  <span class=\"hljs-keyword\">const</span> dayOfWeek = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">Date</span>().<span class=\"hljs-title function_\">getDay</span>()\n  <span class=\"hljs-keyword\">const</span> isWeekend = dayOfWeek === <span class=\"hljs-number\">0</span> || dayOfWeek === <span class=\"hljs-number\">6</span>\n\n  builder\n    .<span class=\"hljs-title function_\">allow</span>(<span class=\"hljs-string\">&quot;project&quot;</span>, <span class=\"hljs-string\">&quot;read&quot;</span>, { <span class=\"hljs-attr\">department</span>: user.<span class=\"hljs-property\">department</span> })\n    .<span class=\"hljs-title function_\">allow</span>(<span class=\"hljs-string\">&quot;project&quot;</span>, <span class=\"hljs-string\">&quot;read&quot;</span>, { <span class=\"hljs-attr\">department</span>: <span class=\"hljs-literal\">null</span> })\n    .<span class=\"hljs-title function_\">allow</span>(<span class=\"hljs-string\">&quot;document&quot;</span>, <span class=\"hljs-string\">&quot;read&quot;</span>)\n\n  <span class=\"hljs-comment\">// Only allow updates on weekdays</span>\n  <span class=\"hljs-keyword\">if</span> (!isWeekend) {\n    builder.<span class=\"hljs-title function_\">allow</span>(<span class=\"hljs-string\">&quot;document&quot;</span>, <span class=\"hljs-string\">&quot;update&quot;</span>, { <span class=\"hljs-attr\">isLocked</span>: <span class=\"hljs-literal\">false</span> })\n  }\n}\n</code></pre><p>The permission decision can incorporate <strong>any</strong> attribute: user, resource, or environment.</p>\n<h2>The Power of ABAC</h2>\n<p>Notice what we can now express:</p>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-comment\">// &quot;Authors can read the createdAt field only on documents they created&quot;</span>\npermissions.<span class=\"hljs-title function_\">can</span>(<span class=\"hljs-string\">&quot;document&quot;</span>, <span class=\"hljs-string\">&quot;read&quot;</span>, { <span class=\"hljs-attr\">creatorId</span>: user.<span class=\"hljs-property\">id</span> }, <span class=\"hljs-string\">&quot;createdAt&quot;</span>)\n\n<span class=\"hljs-comment\">// &quot;Editors can update status on unlocked documents&quot;</span>\npermissions.<span class=\"hljs-title function_\">can</span>(<span class=\"hljs-string\">&quot;document&quot;</span>, <span class=\"hljs-string\">&quot;update&quot;</span>, { <span class=\"hljs-attr\">isLocked</span>: <span class=\"hljs-literal\">false</span> }, <span class=\"hljs-string\">&quot;status&quot;</span>)\n</code></pre><p>These complex, conditional, field-level permissions are natural in ABAC but would require an explosion of permission strings in RBAC.</p>\n<h2>What&#39;s Next</h2>\n<p>Our ABAC system is powerful, but we still have permission checks scattered throughout:</p>\n<ul>\n<li>Page components</li>\n<li>Server actions</li>\n<li>Mutations</li>\n<li>Query functions</li>\n</ul>\n<p>In the next lesson, we&#39;ll create a <strong>services layer</strong> that centralizes all authorization logic and even converts permissions to database queries automatically.</p>\n","markdown":"\nOur basic ABAC system works, but real applications need more sophisticated features. Let's add **field-level permissions** and explore how ABAC can express complex policies.\n\n## New Requirements\n\nIn many applications certain users are restricted on which fields they can read or modify. This is something that is impossible to do in RBAC, but ABAC makes these policies straightforward to express using field-level permissions.\n\n### 1. Field-Level Read Permissions\n\nDifferent roles should see different fields on documents:\n\n| Field            | Admin | Editor | Author | Viewer |\n| ---------------- | ----- | ------ | ------ | ------ |\n| `title`          | ✅    | ✅     | ✅     | ✅     |\n| `content`        | ✅    | ✅     | ✅     | ✅     |\n| `status`         | ✅    | ✅     | ✅     | ✅     |\n| `isLocked`       | ✅    | ✅     | ✅     | ❌     |\n| `creatorId`      | ✅    | ✅     | ✅     | ❌     |\n| `lastEditedById` | ✅    | ✅     | ✅     | ❌     |\n| `createdAt`      | ✅    | ✅     | ✅     | ❌     |\n| `updatedAt`      | ✅    | ✅     | ✅     | ❌     |\n\n### 2. Field-Level Write Permissions\n\nWhen creating or editing documents, only certain fields should be writable:\n\n| Field      | Admin | Editor | Author |\n| ---------- | ----- | ------ | ------ |\n| `title`    | ✅    | ✅     | ✅     |\n| `content`  | ✅    | ✅     | ✅     |\n| `status`   | ✅    | ✅     | ❌     |\n| `isLocked` | ✅    | ❌     | ❌     |\n\nAuthors can write content but can't change document status or lock documents.\n\n### 3. 3. Environment-Based Rules\n\nSince this company values work-life balance, editors and authors are not allowed to make changes on weekends which is an example of an **environment-based** rule that uses attributes from neither the user nor the resource.\n\n## Extending the Permission API\n\nWe need to enhance our `can()` function to support field checks:\n\n```typescript\n// Check if user can read a specific field\npermissions.can(\"document\", \"read\", document, \"isLocked\")\n\n// Check if user can update a specific field\npermissions.can(\"document\", \"update\", document, \"status\")\n```\n\n## Enhanced Policy Definitions\n\nThe `allow` function now accepts an optional fields array as a fourth parameter:\n\n```typescript\nfunction addEditorPermissions(\n  builder: PermissionBuilder,\n  user: Pick<User, \"department\">,\n) {\n  builder.allow(\"document\", \"read\") // All fields by default\n\n  builder.allow(\n    \"document\",\n    \"update\",\n    { isLocked: false }, // Condition: only unlocked docs\n    [\"content\", \"title\", \"status\"], // Restricted to these fields\n  )\n}\n```\n\n## Updating the Permission Builder\n\nWe only need to change two things in our existing builder:\n\n### 1. Add `fields` to the `allow()` method\n\n```typescript\nallow<Res extends keyof Resources>(\n  resource: Res,\n  action: Resources[Res][\"action\"],\n  condition?: Partial<Resources[Res][\"condition\"]>,\n  fields?: string[], // NEW: optional field restriction\n) {\n  this.#permissions[resource].push({ action, condition, fields })\n  return this\n}\n```\n\n### 2. Check fields in `can()`\n\nAdd this after the condition check passes:\n\n```typescript\n// Check field permission (new logic)\nif (field != null && perm.fields != null) {\n  return perm.fields.includes(field)\n}\n```\n\nThe full logic: if a field is requested AND this permission specifies allowed fields, check if the field is in the list. If `perm.fields` is `null`, all fields are allowed.\n\n## Using Field Permissions\n\nAdding support for field permissions takes a little bit of TypeScript wizardry and extra work, but for the most part isn't too bad. Where field permissions become difficult to work with is when consuming which fields a user has access to and ensuring your UI works for all possible permutations.\n\n### In Forms\n\nWe compute which fields the user can modify, then pass that info to the form component:\n\n```tsx\n// Edit document page\nconst permissions = getUserPermissions(user)\n\n<DocumentForm\n  document={document}\n  projectId={projectId}\n  canModify={{\n    status: permissions.can(\"document\", \"update\", document, \"status\"),\n    isLocked: permissions.can(\"document\", \"update\", document, \"isLocked\"),\n  }}\n/>\n```\n\nWhy pass `canModify` as a prop instead of checking permissions inside the form? This keeps the form component **pure** since it just renders based on props, making it easier to test and reuse. It also ensures these components are easier to test and reuse.\n\n### In the Form Component\n\nThe form conditionally renders fields based on permissions:\n\n```tsx\nfunction DocumentForm({ document, projectId, canModify }) {\n  return (\n    <Form>\n      <Input name=\"title\" />\n      <Textarea name=\"content\" />\n\n      {canModify.status && (\n        <Select name=\"status\">\n          <option value=\"draft\">Draft</option>\n          <option value=\"published\">Published</option>\n          <option value=\"archived\">Archived</option>\n        </Select>\n      )}\n\n      {canModify.isLocked && <Checkbox name=\"isLocked\" label=\"Lock document\" />}\n    </Form>\n  )\n}\n```\n\n### In Display Components\n\nFor read permissions, we hide fields the user can't see:\n\n```typescript\n// Document detail page\nconst permissions = getUserPermissions(user)\n\nconst canReadField = {\n  isLocked: permissions.can(\"document\", \"read\", document, \"isLocked\"),\n  creator: permissions.can(\"document\", \"read\", document, \"creatorId\"),\n}\n\n// In JSX\n{canReadField.isLocked && document.isLocked && (\n  <Badge>Locked</Badge>\n)}\n\n{canReadField.creator && (\n  <div>Created by: {document.creator.name}</div>\n)}\n```\n\n## Filtering Permitted Fields\n\nWhen handling form submissions, we need to filter out fields the user isn't allowed to modify, even if they try to send them from the client:\n\n```typescript\nfunction pickPermittedFields<T extends Record<string, unknown>>(\n  permissions: ReturnType<typeof getUserPermissions>,\n  resource: keyof Resources,\n  action: string,\n  data: T,\n  resourceData?: Resources[keyof Resources][\"condition\"],\n): Partial<T> {\n  const result: Record<string, unknown> = {}\n\n  for (const [key, value] of Object.entries(data)) {\n    if (permissions.can(resource, action, resourceData, key)) {\n      result[key] = value\n    }\n  }\n\n  return result as Partial<T>\n}\n```\n\nThis is useful during mutations since it ensures security even if someone bypasses the UI:\n\n```typescript\nconst restrictedData = pickPermittedFields(\n  permissions,\n  \"document\",\n  \"update\",\n  formData,\n  existingDocument,\n)\n// restrictedData only contains fields the user can actually modify\n```\n\n## Implementing Environment Rules\n\nFor weekend restrictions, we check the current day when building permissions:\n\n```typescript\nfunction addEditorPermissions(\n  builder: PermissionBuilder,\n  user: Pick<User, \"department\">,\n) {\n  const dayOfWeek = new Date().getDay()\n  const isWeekend = dayOfWeek === 0 || dayOfWeek === 6\n\n  builder\n    .allow(\"project\", \"read\", { department: user.department })\n    .allow(\"project\", \"read\", { department: null })\n    .allow(\"document\", \"read\")\n\n  // Only allow updates on weekdays\n  if (!isWeekend) {\n    builder.allow(\"document\", \"update\", { isLocked: false })\n  }\n}\n```\n\nThe permission decision can incorporate **any** attribute: user, resource, or environment.\n\n## The Power of ABAC\n\nNotice what we can now express:\n\n```typescript\n// \"Authors can read the createdAt field only on documents they created\"\npermissions.can(\"document\", \"read\", { creatorId: user.id }, \"createdAt\")\n\n// \"Editors can update status on unlocked documents\"\npermissions.can(\"document\", \"update\", { isLocked: false }, \"status\")\n```\n\nThese complex, conditional, field-level permissions are natural in ABAC but would require an explosion of permission strings in RBAC.\n\n## What's Next\n\nOur ABAC system is powerful, but we still have permission checks scattered throughout:\n\n- Page components\n- Server actions\n- Mutations\n- Query functions\n\nIn the next lesson, we'll create a **services layer** that centralizes all authorization logic and even converts permissions to database queries automatically.\n","slug":"advanced-abac-features","title":"Advanced ABAC Features","section":"Attribute-Based Access Control (ABAC)","icon":"cog","filePath":"/home/runner/work/fem-permission-systems-that-scale/fem-permission-systems-that-scale/lessons/04-abac/C-advanced-abac-features.md","nextSlug":"/fem-permission-systems-that-scale/lessons/abac/clean-architecture-services","prevSlug":"/fem-permission-systems-that-scale/lessons/abac/converting-to-abac"}},"__N_SSG":true}
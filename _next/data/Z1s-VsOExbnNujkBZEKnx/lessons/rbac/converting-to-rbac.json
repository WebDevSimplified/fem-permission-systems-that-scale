{"pageProps":{"post":{"attributes":{"title":"Converting to RBAC"},"html":"<p>Let&#39;s convert our scattered permission checks into a centralized RBAC system.</p>\n<h2>The Goal</h2>\n<p>Replace this scattered mess:</p>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-comment\">// In page 1</span>\n<span class=\"hljs-keyword\">if</span> (user.<span class=\"hljs-property\">role</span> !== <span class=\"hljs-string\">&quot;admin&quot;</span> &amp;&amp; user.<span class=\"hljs-property\">role</span> !== <span class=\"hljs-string\">&quot;author&quot;</span>) {\n  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-title function_\">redirect</span>(<span class=\"hljs-string\">&quot;/&quot;</span>)\n}\n\n<span class=\"hljs-comment\">// In page 2 (slightly different!)</span>\n<span class=\"hljs-keyword\">if</span> (user.<span class=\"hljs-property\">role</span> === <span class=\"hljs-string\">&quot;viewer&quot;</span>) {\n  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-title function_\">redirect</span>(<span class=\"hljs-string\">&quot;/&quot;</span>)\n}\n\n<span class=\"hljs-comment\">// In mutation</span>\n<span class=\"hljs-keyword\">if</span> (user == <span class=\"hljs-literal\">null</span> || user.<span class=\"hljs-property\">role</span> === <span class=\"hljs-string\">&quot;viewer&quot;</span> || user.<span class=\"hljs-property\">role</span> === <span class=\"hljs-string\">&quot;editor&quot;</span>) {\n  <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">AuthorizationError</span>()\n}\n</code></pre><p>With this centralized approach:</p>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-comment\">// Everywhere</span>\n<span class=\"hljs-keyword\">if</span> (!<span class=\"hljs-title function_\">can</span>(user, <span class=\"hljs-string\">&quot;document:create&quot;</span>)) {\n  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-title function_\">redirect</span>(<span class=\"hljs-string\">&quot;/&quot;</span>)\n}\n</code></pre><h2>How RBAC Works</h2>\n<p>Before we write code, let&#39;s visualize what we&#39;re building:</p>\n<p><img src=\"/fem-permission-systems-that-scale/images/03-rbac/rbac-flow.svg\" alt=\"RBAC Flow\"></p>\n<p>The role acts as an indirection layer between users and permissions. Instead of scattering role checks everywhere, we create a <strong>lookup table</strong> that maps roles to permissions, then check against that table.</p>\n<h2>Step 1: Create the Permissions Module</h2>\n<p>We&#39;ll create a new file <code>src/permissions/rbac.ts</code> and build it piece by piece.</p>\n<h3>Part 1: Define the Permission Type</h3>\n<p>First, we define all possible permissions as a TypeScript union type:</p>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-comment\">// src/permissions/rbac.ts</span>\n\n<span class=\"hljs-keyword\">import</span> { <span class=\"hljs-title class_\">User</span> } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;@/drizzle/schema&quot;</span>\n\n<span class=\"hljs-keyword\">type</span> <span class=\"hljs-title class_\">Permission</span> =\n  | <span class=\"hljs-string\">&quot;project:create&quot;</span>\n  | <span class=\"hljs-string\">&quot;project:read:all&quot;</span>\n  | <span class=\"hljs-string\">&quot;project:read:own-department&quot;</span>\n  | <span class=\"hljs-string\">&quot;project:read:global-department&quot;</span>\n  | <span class=\"hljs-string\">&quot;project:update&quot;</span>\n  | <span class=\"hljs-string\">&quot;project:delete&quot;</span>\n  | <span class=\"hljs-string\">&quot;document:create&quot;</span>\n  | <span class=\"hljs-string\">&quot;document:read&quot;</span>\n  | <span class=\"hljs-string\">&quot;document:update&quot;</span>\n  | <span class=\"hljs-string\">&quot;document:delete&quot;</span>\n</code></pre><p>Using a union type means TypeScript will catch typos like <code>&quot;documnet:create&quot;</code> at compile time‚Äîa huge win over string literals scattered throughout your codebase.</p>\n<h3>Part 2: Map Roles to Permissions</h3>\n<p>Next, we create the lookup table‚Äîthis is the heart of RBAC:</p>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">permissionsByRole</span>: <span class=\"hljs-title class_\">Record</span>&lt;<span class=\"hljs-title class_\">User</span>[<span class=\"hljs-string\">&quot;role&quot;</span>], <span class=\"hljs-title class_\">Permission</span>[]&gt; = {\n  <span class=\"hljs-attr\">admin</span>: [\n    <span class=\"hljs-string\">&quot;project:create&quot;</span>,\n    <span class=\"hljs-string\">&quot;project:read:all&quot;</span>,\n    <span class=\"hljs-string\">&quot;project:update&quot;</span>,\n    <span class=\"hljs-string\">&quot;project:delete&quot;</span>,\n    <span class=\"hljs-string\">&quot;document:create&quot;</span>,\n    <span class=\"hljs-string\">&quot;document:read&quot;</span>,\n    <span class=\"hljs-string\">&quot;document:update&quot;</span>,\n    <span class=\"hljs-string\">&quot;document:delete&quot;</span>,\n  ],\n  <span class=\"hljs-attr\">author</span>: [\n    <span class=\"hljs-string\">&quot;project:read:own-department&quot;</span>,\n    <span class=\"hljs-string\">&quot;project:read:global-department&quot;</span>,\n    <span class=\"hljs-string\">&quot;document:create&quot;</span>,\n    <span class=\"hljs-string\">&quot;document:read&quot;</span>,\n    <span class=\"hljs-string\">&quot;document:update&quot;</span>,\n  ],\n  <span class=\"hljs-attr\">editor</span>: [\n    <span class=\"hljs-string\">&quot;project:read:own-department&quot;</span>,\n    <span class=\"hljs-string\">&quot;project:read:global-department&quot;</span>,\n    <span class=\"hljs-string\">&quot;document:read&quot;</span>,\n    <span class=\"hljs-string\">&quot;document:update&quot;</span>,\n  ],\n  <span class=\"hljs-attr\">viewer</span>: [\n    <span class=\"hljs-string\">&quot;project:read:own-department&quot;</span>,\n    <span class=\"hljs-string\">&quot;project:read:global-department&quot;</span>,\n    <span class=\"hljs-string\">&quot;document:read&quot;</span>,\n  ],\n}\n</code></pre><p>Now when requirements change‚Äîsay, authors should be able to delete their own documents‚Äîyou update <strong>one place</strong> instead of hunting through dozens of files.</p>\n<h3>Part 3: The <code>can</code> Function</h3>\n<p>Finally, a simple function to check permissions:</p>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">can</span>(<span class=\"hljs-params\">\n  <span class=\"hljs-attr\">user</span>: <span class=\"hljs-title class_\">Pick</span>&lt;<span class=\"hljs-title class_\">User</span>, <span class=\"hljs-string\">&quot;role&quot;</span>&gt; | <span class=\"hljs-literal\">null</span>,\n  <span class=\"hljs-attr\">permission</span>: <span class=\"hljs-title class_\">Permission</span>,\n</span>): <span class=\"hljs-built_in\">boolean</span> {\n  <span class=\"hljs-keyword\">if</span> (user == <span class=\"hljs-literal\">null</span>) <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">false</span>\n  <span class=\"hljs-keyword\">return</span> permissionsByRole[user.<span class=\"hljs-property\">role</span>].<span class=\"hljs-title function_\">includes</span>(permission)\n}\n</code></pre><blockquote>\n<p>üí° We use <code>Pick&lt;User, &quot;role&quot;&gt;</code> instead of the full <code>User</code> type. This makes the function flexible since you don&#39;t need a full user object to call the function.</p>\n</blockquote>\n<h2>Step 2: Handle Complex Permission Logic</h2>\n<p>Some permissions aren&#39;t purely role-based. For example, &quot;can read project&quot; depends on:</p>\n<ul>\n<li>The user&#39;s role (admins can read all)</li>\n<li>The user&#39;s department</li>\n<li>The project&#39;s department</li>\n</ul>\n<p>This is where pure RBAC starts to show cracks. We need helper functions that mix role checks with attribute checks:</p>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-comment\">// src/permissions/projects.ts</span>\n\n<span class=\"hljs-keyword\">import</span> { <span class=\"hljs-title class_\">Project</span>, <span class=\"hljs-title class_\">User</span> } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;@/drizzle/schema&quot;</span>\n<span class=\"hljs-keyword\">import</span> { can } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;./rbac&quot;</span>\n\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">canReadProject</span>(<span class=\"hljs-params\">\n  <span class=\"hljs-attr\">user</span>: <span class=\"hljs-title class_\">Pick</span>&lt;<span class=\"hljs-title class_\">User</span>, <span class=\"hljs-string\">&quot;role&quot;</span> | <span class=\"hljs-string\">&quot;department&quot;</span>&gt; | <span class=\"hljs-literal\">null</span>,\n  <span class=\"hljs-attr\">project</span>: <span class=\"hljs-title class_\">Pick</span>&lt;<span class=\"hljs-title class_\">Project</span>, <span class=\"hljs-string\">&quot;department&quot;</span>&gt;,\n</span>): <span class=\"hljs-built_in\">boolean</span> {\n  <span class=\"hljs-keyword\">if</span> (user == <span class=\"hljs-literal\">null</span>) <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">false</span>\n\n  <span class=\"hljs-keyword\">return</span> (\n    <span class=\"hljs-title function_\">can</span>(user, <span class=\"hljs-string\">&quot;project:read:all&quot;</span>) ||\n    (<span class=\"hljs-title function_\">can</span>(user, <span class=\"hljs-string\">&quot;project:read:own-department&quot;</span>) &amp;&amp;\n      project.<span class=\"hljs-property\">department</span> === user.<span class=\"hljs-property\">department</span>) ||\n    (<span class=\"hljs-title function_\">can</span>(user, <span class=\"hljs-string\">&quot;project:read:global-department&quot;</span>) &amp;&amp; project.<span class=\"hljs-property\">department</span> == <span class=\"hljs-literal\">null</span>)\n  )\n}\n</code></pre><blockquote>\n<p>‚ö†Ô∏è Notice how we&#39;re already mixing RBAC (<code>can(user, &quot;permission&quot;)</code>) with attribute checks (<code>project.department === user.department</code>). This hybrid approach works, but it&#39;s a sign that pure RBAC may not be enough for our needs.</p>\n</blockquote>\n<h2>Step 3: Update the Codebase</h2>\n<p>Now we replace all inline checks with our centralized functions.</p>\n<h3>Before (Page Component)</h3>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-keyword\">if</span> (\n  user == <span class=\"hljs-literal\">null</span> ||\n  (user.<span class=\"hljs-property\">role</span> !== <span class=\"hljs-string\">&quot;admin&quot;</span> &amp;&amp;\n    project.<span class=\"hljs-property\">department</span> != <span class=\"hljs-literal\">null</span> &amp;&amp;\n    user.<span class=\"hljs-property\">department</span> !== project.<span class=\"hljs-property\">department</span>)\n) {\n  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-title function_\">redirect</span>(<span class=\"hljs-string\">&quot;/&quot;</span>)\n}\n</code></pre><h3>After (Page Component)</h3>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-keyword\">if</span> (!<span class=\"hljs-title function_\">canReadProject</span>(user, project)) {\n  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-title function_\">redirect</span>(<span class=\"hljs-string\">&quot;/&quot;</span>)\n}\n</code></pre><h3>Before (Mutation)</h3>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-keyword\">if</span> (user == <span class=\"hljs-literal\">null</span> || user.<span class=\"hljs-property\">role</span> === <span class=\"hljs-string\">&quot;viewer&quot;</span>) {\n  <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">AuthorizationError</span>()\n}\n</code></pre><h3>After (Mutation)</h3>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-keyword\">if</span> (!<span class=\"hljs-title function_\">can</span>(user, <span class=\"hljs-string\">&quot;document:update&quot;</span>)) {\n  <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">AuthorizationError</span>()\n}\n</code></pre><h3>Before (UI Conditional)</h3>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button>{(user?.<span class=\"hljs-property\">role</span> === <span class=\"hljs-string\">&quot;author&quot;</span> || user?.<span class=\"hljs-property\">role</span> === <span class=\"hljs-string\">&quot;admin&quot;</span>) &amp;&amp; (\n  <span class=\"language-xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">Button</span>&gt;</span>New Document<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">Button</span>&gt;</span></span>\n)}\n</code></pre><h3>After (UI Conditional)</h3>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button>{<span class=\"hljs-title function_\">can</span>(user, <span class=\"hljs-string\">&quot;document:create&quot;</span>) &amp;&amp; (\n  <span class=\"language-xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">Button</span>&gt;</span>New Document<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">Button</span>&gt;</span></span>\n)}\n</code></pre><h2>What We Gain</h2>\n<p>After this refactor:</p>\n<table>\n<thead>\n<tr>\n<th>Benefit</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>Single source of truth</strong></td>\n<td>All permissions defined in one place</td>\n</tr>\n<tr>\n<td><strong>Readable code</strong></td>\n<td><code>can(user, &quot;document:create&quot;)</code> is self-documenting</td>\n</tr>\n<tr>\n<td><strong>Type safety</strong></td>\n<td>TypeScript ensures we only use valid permission names</td>\n</tr>\n<tr>\n<td><strong>Easy updates</strong></td>\n<td>Change a role&#39;s permissions in one file</td>\n</tr>\n</tbody></table>\n<h2>Branch Checkpoint</h2>\n<p>After completing this conversion, your code should match:</p>\n<pre><code class=\"hljs language-text\"><button class=\"copy-btn\">Copy</button>Branch: 3-basic-rbac\n</code></pre><p>Run the following to sync up:</p>\n<pre><code class=\"hljs language-bash\"><button class=\"copy-btn\">Copy</button>git checkout 3-basic-rbac\n</code></pre><h2>What&#39;s Next</h2>\n<p>Our RBAC system works great for the current permissions. But what happens when we need to add more complex rules?</p>\n","markdown":"\nLet's convert our scattered permission checks into a centralized RBAC system.\n\n## The Goal\n\nReplace this scattered mess:\n\n```typescript\n// In page 1\nif (user.role !== \"admin\" && user.role !== \"author\") {\n  return redirect(\"/\")\n}\n\n// In page 2 (slightly different!)\nif (user.role === \"viewer\") {\n  return redirect(\"/\")\n}\n\n// In mutation\nif (user == null || user.role === \"viewer\" || user.role === \"editor\") {\n  throw new AuthorizationError()\n}\n```\n\nWith this centralized approach:\n\n```typescript\n// Everywhere\nif (!can(user, \"document:create\")) {\n  return redirect(\"/\")\n}\n```\n\n## How RBAC Works\n\nBefore we write code, let's visualize what we're building:\n\n![RBAC Flow](/fem-permission-systems-that-scale/images/03-rbac/rbac-flow.svg)\n\nThe role acts as an indirection layer between users and permissions. Instead of scattering role checks everywhere, we create a **lookup table** that maps roles to permissions, then check against that table.\n\n## Step 1: Create the Permissions Module\n\nWe'll create a new file `src/permissions/rbac.ts` and build it piece by piece.\n\n### Part 1: Define the Permission Type\n\nFirst, we define all possible permissions as a TypeScript union type:\n\n```typescript\n// src/permissions/rbac.ts\n\nimport { User } from \"@/drizzle/schema\"\n\ntype Permission =\n  | \"project:create\"\n  | \"project:read:all\"\n  | \"project:read:own-department\"\n  | \"project:read:global-department\"\n  | \"project:update\"\n  | \"project:delete\"\n  | \"document:create\"\n  | \"document:read\"\n  | \"document:update\"\n  | \"document:delete\"\n```\n\nUsing a union type means TypeScript will catch typos like `\"documnet:create\"` at compile time‚Äîa huge win over string literals scattered throughout your codebase.\n\n### Part 2: Map Roles to Permissions\n\nNext, we create the lookup table‚Äîthis is the heart of RBAC:\n\n```typescript\nconst permissionsByRole: Record<User[\"role\"], Permission[]> = {\n  admin: [\n    \"project:create\",\n    \"project:read:all\",\n    \"project:update\",\n    \"project:delete\",\n    \"document:create\",\n    \"document:read\",\n    \"document:update\",\n    \"document:delete\",\n  ],\n  author: [\n    \"project:read:own-department\",\n    \"project:read:global-department\",\n    \"document:create\",\n    \"document:read\",\n    \"document:update\",\n  ],\n  editor: [\n    \"project:read:own-department\",\n    \"project:read:global-department\",\n    \"document:read\",\n    \"document:update\",\n  ],\n  viewer: [\n    \"project:read:own-department\",\n    \"project:read:global-department\",\n    \"document:read\",\n  ],\n}\n```\n\nNow when requirements change‚Äîsay, authors should be able to delete their own documents‚Äîyou update **one place** instead of hunting through dozens of files.\n\n### Part 3: The `can` Function\n\nFinally, a simple function to check permissions:\n\n```typescript\nexport function can(\n  user: Pick<User, \"role\"> | null,\n  permission: Permission,\n): boolean {\n  if (user == null) return false\n  return permissionsByRole[user.role].includes(permission)\n}\n```\n\n> üí° We use `Pick<User, \"role\">` instead of the full `User` type. This makes the function flexible since you don't need a full user object to call the function.\n\n## Step 2: Handle Complex Permission Logic\n\nSome permissions aren't purely role-based. For example, \"can read project\" depends on:\n\n- The user's role (admins can read all)\n- The user's department\n- The project's department\n\nThis is where pure RBAC starts to show cracks. We need helper functions that mix role checks with attribute checks:\n\n```typescript\n// src/permissions/projects.ts\n\nimport { Project, User } from \"@/drizzle/schema\"\nimport { can } from \"./rbac\"\n\nexport function canReadProject(\n  user: Pick<User, \"role\" | \"department\"> | null,\n  project: Pick<Project, \"department\">,\n): boolean {\n  if (user == null) return false\n\n  return (\n    can(user, \"project:read:all\") ||\n    (can(user, \"project:read:own-department\") &&\n      project.department === user.department) ||\n    (can(user, \"project:read:global-department\") && project.department == null)\n  )\n}\n```\n\n> ‚ö†Ô∏è Notice how we're already mixing RBAC (`can(user, \"permission\")`) with attribute checks (`project.department === user.department`). This hybrid approach works, but it's a sign that pure RBAC may not be enough for our needs.\n\n## Step 3: Update the Codebase\n\nNow we replace all inline checks with our centralized functions.\n\n### Before (Page Component)\n\n```typescript\nif (\n  user == null ||\n  (user.role !== \"admin\" &&\n    project.department != null &&\n    user.department !== project.department)\n) {\n  return redirect(\"/\")\n}\n```\n\n### After (Page Component)\n\n```typescript\nif (!canReadProject(user, project)) {\n  return redirect(\"/\")\n}\n```\n\n### Before (Mutation)\n\n```typescript\nif (user == null || user.role === \"viewer\") {\n  throw new AuthorizationError()\n}\n```\n\n### After (Mutation)\n\n```typescript\nif (!can(user, \"document:update\")) {\n  throw new AuthorizationError()\n}\n```\n\n### Before (UI Conditional)\n\n```typescript\n{(user?.role === \"author\" || user?.role === \"admin\") && (\n  <Button>New Document</Button>\n)}\n```\n\n### After (UI Conditional)\n\n```typescript\n{can(user, \"document:create\") && (\n  <Button>New Document</Button>\n)}\n```\n\n## What We Gain\n\nAfter this refactor:\n\n| Benefit                    | Description                                           |\n| -------------------------- | ----------------------------------------------------- |\n| **Single source of truth** | All permissions defined in one place                  |\n| **Readable code**          | `can(user, \"document:create\")` is self-documenting    |\n| **Type safety**            | TypeScript ensures we only use valid permission names |\n| **Easy updates**           | Change a role's permissions in one file               |\n\n## Branch Checkpoint\n\nAfter completing this conversion, your code should match:\n\n```text\nBranch: 3-basic-rbac\n```\n\nRun the following to sync up:\n\n```bash\ngit checkout 3-basic-rbac\n```\n\n## What's Next\n\nOur RBAC system works great for the current permissions. But what happens when we need to add more complex rules?\n","slug":"converting-to-rbac","title":"Converting to RBAC","section":"Role-Based Access Control (RBAC)","icon":"shield","filePath":"/home/runner/work/fem-permission-systems-that-scale/fem-permission-systems-that-scale/lessons/03-rbac/B-converting-to-rbac.md","nextSlug":"/fem-permission-systems-that-scale/lessons/rbac/adding-more-permissions","prevSlug":"/fem-permission-systems-that-scale/lessons/rbac/what-is-rbac"}},"__N_SSG":true}
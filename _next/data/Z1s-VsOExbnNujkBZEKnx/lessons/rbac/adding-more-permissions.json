{"pageProps":{"post":{"attributes":{"title":"Adding More Permissions"},"html":"<p>Our RBAC system works great—until the business asks for &quot;just a few more rules.&quot; Let&#39;s add some realistic permission requirements and see how RBAC handles them.</p>\n<h2>New Permission Requirements</h2>\n<p>Our system is currently very bare-bones and a more realistic set of permissions may include the following:</p>\n<h3>1. Locked Documents</h3>\n<p>Documents can be <strong>locked</strong> to prevent editing. Only admins can edit locked documents.</p>\n<h3>2. Draft Visibility</h3>\n<p><strong>Draft documents</strong> should only be visible to:</p>\n<ul>\n<li>The document creator (authors can see their own drafts)</li>\n<li>Editors and admins (they can see all drafts)</li>\n<li>Viewers should <strong>not</strong> see drafts</li>\n</ul>\n<h3>3. Author Edit Restrictions</h3>\n<p>Authors should only be able to edit:</p>\n<ul>\n<li>Documents <strong>they created</strong></li>\n<li>That are <strong>not locked</strong></li>\n<li>That are still in <strong>draft status</strong></li>\n</ul>\n<p>Once a document is published, only editors and admins can modify it.</p>\n<h3>Full Permission Matrix</h3>\n<p>Here&#39;s the complete permission matrix we need to implement:</p>\n<table>\n<thead>\n<tr>\n<th>Action</th>\n<th>Admin</th>\n<th>Editor</th>\n<th>Author</th>\n<th>Viewer</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>View</strong> published/archived docs</td>\n<td>✅</td>\n<td>✅</td>\n<td>✅</td>\n<td>✅</td>\n</tr>\n<tr>\n<td><strong>View</strong> draft docs (any)</td>\n<td>✅</td>\n<td>✅</td>\n<td>❌</td>\n<td>❌</td>\n</tr>\n<tr>\n<td><strong>View</strong> draft docs (own)</td>\n<td>✅</td>\n<td>✅</td>\n<td>✅</td>\n<td>❌</td>\n</tr>\n<tr>\n<td><strong>Edit</strong> unlocked docs</td>\n<td>✅</td>\n<td>✅</td>\n<td>❌</td>\n<td>❌</td>\n</tr>\n<tr>\n<td><strong>Edit</strong> own unlocked draft docs</td>\n<td>✅</td>\n<td>✅</td>\n<td>✅</td>\n<td>❌</td>\n</tr>\n<tr>\n<td><strong>Edit</strong> locked docs</td>\n<td>✅</td>\n<td>❌</td>\n<td>❌</td>\n<td>❌</td>\n</tr>\n<tr>\n<td><strong>Delete</strong> docs</td>\n<td>✅</td>\n<td>❌</td>\n<td>❌</td>\n<td>❌</td>\n</tr>\n<tr>\n<td><strong>Create</strong> docs</td>\n<td>✅</td>\n<td>❌</td>\n<td>✅</td>\n<td>❌</td>\n</tr>\n</tbody></table>\n<h2>The Problem Emerges</h2>\n<p>Look at the &quot;Author Edit&quot; requirement again:</p>\n<blockquote>\n<p>Authors can edit documents <strong>they created</strong>, that are <strong>not locked</strong>, in <strong>draft status</strong></p>\n</blockquote>\n<p>This permission depends on:</p>\n<ul>\n<li>The <strong>user&#39;s role</strong> (must be author)</li>\n<li>The <strong>user&#39;s ID</strong> (must be the creator)</li>\n<li>The <strong>document&#39;s isLocked</strong> attribute</li>\n<li>The <strong>document&#39;s status</strong> attribute</li>\n</ul>\n<p>Pure RBAC struggles to express this. We need to check <strong>attributes</strong> of both the user and the resource.</p>\n<h2>Attempting RBAC Solutions</h2>\n<p>To solve this in RBAC, we need to create very specific permissions:</p>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-keyword\">type</span> <span class=\"hljs-title class_\">Permission</span> =\n  <span class=\"hljs-comment\">// ...existing permissions...</span>\n  | <span class=\"hljs-string\">&quot;document:update:unlocked&quot;</span>\n  | <span class=\"hljs-string\">&quot;document:update:own-unlocked-draft&quot;</span>\n  | <span class=\"hljs-string\">&quot;document:read:all&quot;</span>\n  | <span class=\"hljs-string\">&quot;document:read:own&quot;</span>\n  | <span class=\"hljs-string\">&quot;document:read:non-draft&quot;</span>\n</code></pre><p>Then assign them to roles:</p>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-keyword\">const</span> permissionsByRole = {\n  <span class=\"hljs-attr\">admin</span>: [\n    <span class=\"hljs-string\">&quot;document:update:unlocked&quot;</span>, <span class=\"hljs-comment\">// Can edit any unlocked doc</span>\n    <span class=\"hljs-string\">&quot;document:read:all&quot;</span>,\n    <span class=\"hljs-comment\">// ...</span>\n  ],\n  <span class=\"hljs-attr\">author</span>: [\n    <span class=\"hljs-string\">&quot;document:update:own-unlocked-draft&quot;</span>, <span class=\"hljs-comment\">// Very specific!</span>\n    <span class=\"hljs-string\">&quot;document:read:own&quot;</span>,\n    <span class=\"hljs-string\">&quot;document:read:non-draft&quot;</span>,\n    <span class=\"hljs-comment\">// ...</span>\n  ],\n  <span class=\"hljs-comment\">// ...</span>\n}\n</code></pre><p>But now we need helper functions to use these effectively:</p>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">canUpdateDocument</span>(<span class=\"hljs-params\">\n  <span class=\"hljs-attr\">user</span>: <span class=\"hljs-title class_\">Pick</span>&lt;<span class=\"hljs-title class_\">User</span>, <span class=\"hljs-string\">&quot;role&quot;</span> | <span class=\"hljs-string\">&quot;id&quot;</span>&gt; | <span class=\"hljs-literal\">null</span>,\n  <span class=\"hljs-attr\">document</span>: <span class=\"hljs-title class_\">Pick</span>&lt;<span class=\"hljs-title class_\">Document</span>, <span class=\"hljs-string\">&quot;creatorId&quot;</span> | <span class=\"hljs-string\">&quot;status&quot;</span> | <span class=\"hljs-string\">&quot;isLocked&quot;</span>&gt;,\n</span>): <span class=\"hljs-built_in\">boolean</span> {\n  <span class=\"hljs-keyword\">if</span> (user == <span class=\"hljs-literal\">null</span>) <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">false</span>\n\n  <span class=\"hljs-keyword\">return</span> (\n    <span class=\"hljs-comment\">// Admins/editors: can edit any unlocked document</span>\n    (<span class=\"hljs-title function_\">can</span>(user, <span class=\"hljs-string\">&quot;document:update:unlocked&quot;</span>) &amp;&amp; !<span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-property\">isLocked</span>) ||\n    <span class=\"hljs-comment\">// Authors: only their own, unlocked, draft documents</span>\n    (<span class=\"hljs-title function_\">can</span>(user, <span class=\"hljs-string\">&quot;document:update:own-unlocked-draft&quot;</span>) &amp;&amp;\n      <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-property\">creatorId</span> === user.<span class=\"hljs-property\">id</span> &amp;&amp;\n      !<span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-property\">isLocked</span> &amp;&amp;\n      <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-property\">status</span> === <span class=\"hljs-string\">&quot;draft&quot;</span>)\n  )\n}\n</code></pre><h2>What Went Wrong?</h2>\n<p>Notice the problems:</p>\n<h3>1. Permissions Exploded In Complexity</h3>\n<p>We now have 3 permissions to read a document, 2 for updating, and 3 for reading a project. This problem also grows exponentially as more attributes and conditions are added since if we needed to check just 2 more attributes on a document we would need to create permissions for every permutation of those attributes.</p>\n<h3>2. Logic Scattered Again</h3>\n<p>Our simple <code>can</code> function is no longer able to handle complex permission checks on its own which leads to many helper functions that are complex and easy to misuse.</p>\n<h3>3. Database Queries Duplicate Permissions</h3>\n<p>With the current RBAC implementation, we need to essentially rewrite each permission check into its corresponding database query when querying multiple items (such as getting all the projects that user has access to). This leads to duplicated logic between the permission system code and the database layer, making it harder to maintain and increasing the risk of inconsistencies.</p>\n<h2>Branch Checkpoint</h2>\n<p>After adding these permissions, your code should match:</p>\n<pre><code class=\"hljs language-text\"><button class=\"copy-btn\">Copy</button>Branch: 4-rbac-limits\n</code></pre><p>Run the following to sync up:</p>\n<pre><code class=\"hljs language-bash\"><button class=\"copy-btn\">Copy</button>git checkout 4-rbac-limits\n</code></pre>","markdown":"\nOur RBAC system works great—until the business asks for \"just a few more rules.\" Let's add some realistic permission requirements and see how RBAC handles them.\n\n## New Permission Requirements\n\nOur system is currently very bare-bones and a more realistic set of permissions may include the following:\n\n### 1. Locked Documents\n\nDocuments can be **locked** to prevent editing. Only admins can edit locked documents.\n\n### 2. Draft Visibility\n\n**Draft documents** should only be visible to:\n\n- The document creator (authors can see their own drafts)\n- Editors and admins (they can see all drafts)\n- Viewers should **not** see drafts\n\n### 3. Author Edit Restrictions\n\nAuthors should only be able to edit:\n\n- Documents **they created**\n- That are **not locked**\n- That are still in **draft status**\n\nOnce a document is published, only editors and admins can modify it.\n\n### Full Permission Matrix\n\nHere's the complete permission matrix we need to implement:\n\n| Action                           | Admin | Editor | Author | Viewer |\n| -------------------------------- | ----- | ------ | ------ | ------ |\n| **View** published/archived docs | ✅    | ✅     | ✅     | ✅     |\n| **View** draft docs (any)        | ✅    | ✅     | ❌     | ❌     |\n| **View** draft docs (own)        | ✅    | ✅     | ✅     | ❌     |\n| **Edit** unlocked docs           | ✅    | ✅     | ❌     | ❌     |\n| **Edit** own unlocked draft docs | ✅    | ✅     | ✅     | ❌     |\n| **Edit** locked docs             | ✅    | ❌     | ❌     | ❌     |\n| **Delete** docs                  | ✅    | ❌     | ❌     | ❌     |\n| **Create** docs                  | ✅    | ❌     | ✅     | ❌     |\n\n## The Problem Emerges\n\nLook at the \"Author Edit\" requirement again:\n\n> Authors can edit documents **they created**, that are **not locked**, in **draft status**\n\nThis permission depends on:\n\n- The **user's role** (must be author)\n- The **user's ID** (must be the creator)\n- The **document's isLocked** attribute\n- The **document's status** attribute\n\nPure RBAC struggles to express this. We need to check **attributes** of both the user and the resource.\n\n## Attempting RBAC Solutions\n\nTo solve this in RBAC, we need to create very specific permissions:\n\n```typescript\ntype Permission =\n  // ...existing permissions...\n  | \"document:update:unlocked\"\n  | \"document:update:own-unlocked-draft\"\n  | \"document:read:all\"\n  | \"document:read:own\"\n  | \"document:read:non-draft\"\n```\n\nThen assign them to roles:\n\n```typescript\nconst permissionsByRole = {\n  admin: [\n    \"document:update:unlocked\", // Can edit any unlocked doc\n    \"document:read:all\",\n    // ...\n  ],\n  author: [\n    \"document:update:own-unlocked-draft\", // Very specific!\n    \"document:read:own\",\n    \"document:read:non-draft\",\n    // ...\n  ],\n  // ...\n}\n```\n\nBut now we need helper functions to use these effectively:\n\n```typescript\nexport function canUpdateDocument(\n  user: Pick<User, \"role\" | \"id\"> | null,\n  document: Pick<Document, \"creatorId\" | \"status\" | \"isLocked\">,\n): boolean {\n  if (user == null) return false\n\n  return (\n    // Admins/editors: can edit any unlocked document\n    (can(user, \"document:update:unlocked\") && !document.isLocked) ||\n    // Authors: only their own, unlocked, draft documents\n    (can(user, \"document:update:own-unlocked-draft\") &&\n      document.creatorId === user.id &&\n      !document.isLocked &&\n      document.status === \"draft\")\n  )\n}\n```\n\n## What Went Wrong?\n\nNotice the problems:\n\n### 1. Permissions Exploded In Complexity\n\nWe now have 3 permissions to read a document, 2 for updating, and 3 for reading a project. This problem also grows exponentially as more attributes and conditions are added since if we needed to check just 2 more attributes on a document we would need to create permissions for every permutation of those attributes.\n\n### 2. Logic Scattered Again\n\nOur simple `can` function is no longer able to handle complex permission checks on its own which leads to many helper functions that are complex and easy to misuse.\n\n### 3. Database Queries Duplicate Permissions\n\nWith the current RBAC implementation, we need to essentially rewrite each permission check into its corresponding database query when querying multiple items (such as getting all the projects that user has access to). This leads to duplicated logic between the permission system code and the database layer, making it harder to maintain and increasing the risk of inconsistencies.\n\n## Branch Checkpoint\n\nAfter adding these permissions, your code should match:\n\n```text\nBranch: 4-rbac-limits\n```\n\nRun the following to sync up:\n\n```bash\ngit checkout 4-rbac-limits\n```\n","slug":"adding-more-permissions","title":"Adding More Permissions","section":"Role-Based Access Control (RBAC)","icon":"shield","filePath":"/home/runner/work/fem-permission-systems-that-scale/fem-permission-systems-that-scale/lessons/03-rbac/C-adding-more-permissions.md","nextSlug":"/fem-permission-systems-that-scale/lessons/rbac/rbac-limitations","prevSlug":"/fem-permission-systems-that-scale/lessons/rbac/converting-to-rbac"}},"__N_SSG":true}
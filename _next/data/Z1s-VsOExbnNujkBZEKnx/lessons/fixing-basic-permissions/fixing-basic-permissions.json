{"pageProps":{"post":{"attributes":{"title":"Fixing Basic Permissions"},"html":"<p>Let&#39;s focus on fixing the errors with our basic permission system.</p>\n<blockquote>\n<p>ðŸ’¡ <strong>Important:</strong> Each issue is labeled with the comment <code>FIX:</code> to make them easier to find.</p>\n</blockquote>\n<h2>Vulnerable Pages</h2>\n<p>Our app has several pages that are missing permission checks:</p>\n<table>\n<thead>\n<tr>\n<th>Page</th>\n<th>Who Should Access</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>/projects/[id]</code></td>\n<td>Users in same department, or Admins</td>\n</tr>\n<tr>\n<td><code>/projects/[id]/edit</code></td>\n<td>Admins only</td>\n</tr>\n<tr>\n<td><code>/projects/new</code></td>\n<td>Admins only</td>\n</tr>\n<tr>\n<td><code>/projects/[id]/documents/[id]</code></td>\n<td>Users in same department, or Admins</td>\n</tr>\n<tr>\n<td><code>/projects/[id]/documents/[id]/edit</code></td>\n<td>Editors/Authors in department, or Admins</td>\n</tr>\n<tr>\n<td><code>/projects/[id]/documents/new</code></td>\n<td>Authors in department, or Admins</td>\n</tr>\n</tbody></table>\n<h2>Incorrect Permissions</h2>\n<p>There are multiple places where our permission checks are wrong.</p>\n<table>\n<thead>\n<tr>\n<th>File</th>\n<th>Issue</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>app/(dashboard)/projects/[projectId]/page.tsx</code></td>\n<td>Admins should be able to view the new document button</td>\n</tr>\n<tr>\n<td><code>dal/documents/mutations.ts</code></td>\n<td>Viewers should not be able to create documents</td>\n</tr>\n</tbody></table>\n<h2>Example Fix</h2>\n<p>Here&#39;s an example of adding a missing permission check:</p>\n<pre><code class=\"hljs language-typescript\"><button class=\"copy-btn\">Copy</button><span class=\"hljs-comment\">// Before: No permission check!</span>\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> <span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">ProjectEditPage</span>(<span class=\"hljs-params\">{ params }</span>) {\n  <span class=\"hljs-keyword\">const</span> project = <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title function_\">getProjectById</span>(params.<span class=\"hljs-property\">projectId</span>)\n  <span class=\"hljs-keyword\">return</span> <span class=\"language-xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">ProjectForm</span> <span class=\"hljs-attr\">project</span>=<span class=\"hljs-string\">{project}</span> /&gt;</span></span>\n}\n\n<span class=\"hljs-comment\">// After: Check user role before rendering</span>\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> <span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">ProjectEditPage</span>(<span class=\"hljs-params\">{ params }</span>) {\n  <span class=\"hljs-keyword\">const</span> user = <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title function_\">getCurrentUser</span>()\n\n  <span class=\"hljs-comment\">// Only admins can edit projects</span>\n  <span class=\"hljs-keyword\">if</span> (user?.<span class=\"hljs-property\">role</span> !== <span class=\"hljs-string\">&quot;admin&quot;</span>) {\n    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-title function_\">redirect</span>(<span class=\"hljs-string\">&quot;/&quot;</span>)\n  }\n\n  <span class=\"hljs-keyword\">const</span> project = <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title function_\">getProjectById</span>(params.<span class=\"hljs-property\">projectId</span>)\n  <span class=\"hljs-keyword\">return</span> <span class=\"language-xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">ProjectForm</span> <span class=\"hljs-attr\">project</span>=<span class=\"hljs-string\">{project}</span> /&gt;</span></span>\n}\n</code></pre><p>Notice the pattern: check permissions <strong>before</strong> fetching data or rendering the page.</p>\n<h2>The Problem With This System</h2>\n<p>As we add these checks, notice how we&#39;re:</p>\n<ul>\n<li>Copying and pasting the same permission checks everywhere</li>\n<li>Hoping we don&#39;t make typos or forget a condition</li>\n</ul>\n<p>This is exactly why we need to <strong>centralize</strong> this logic. If our department permission rule changes, we now have to update it in <strong>every single file</strong>.</p>\n<h2>Branch Checkpoint</h2>\n<p>After completing these fixes, your code should match:</p>\n<pre><code class=\"hljs language-text\"><button class=\"copy-btn\">Copy</button>Branch: 2-fix-basic-permission-errors\n</code></pre><p>Run the following to sync up:</p>\n<pre><code class=\"hljs language-bash\"><button class=\"copy-btn\">Copy</button>git checkout 2-fix-basic-permission-errors\n</code></pre>","markdown":"\nLet's focus on fixing the errors with our basic permission system.\n\n> ðŸ’¡ **Important:** Each issue is labeled with the comment `FIX:` to make them easier to find.\n\n## Vulnerable Pages\n\nOur app has several pages that are missing permission checks:\n\n| Page                                 | Who Should Access                        |\n| ------------------------------------ | ---------------------------------------- |\n| `/projects/[id]`                     | Users in same department, or Admins      |\n| `/projects/[id]/edit`                | Admins only                              |\n| `/projects/new`                      | Admins only                              |\n| `/projects/[id]/documents/[id]`      | Users in same department, or Admins      |\n| `/projects/[id]/documents/[id]/edit` | Editors/Authors in department, or Admins |\n| `/projects/[id]/documents/new`       | Authors in department, or Admins         |\n\n## Incorrect Permissions\n\nThere are multiple places where our permission checks are wrong.\n\n| File                                            | Issue                                                 |\n| ----------------------------------------------- | ----------------------------------------------------- |\n| `app/(dashboard)/projects/[projectId]/page.tsx` | Admins should be able to view the new document button |\n| `dal/documents/mutations.ts`                    | Viewers should not be able to create documents        |\n\n## Example Fix\n\nHere's an example of adding a missing permission check:\n\n```typescript\n// Before: No permission check!\nexport default async function ProjectEditPage({ params }) {\n  const project = await getProjectById(params.projectId)\n  return <ProjectForm project={project} />\n}\n\n// After: Check user role before rendering\nexport default async function ProjectEditPage({ params }) {\n  const user = await getCurrentUser()\n\n  // Only admins can edit projects\n  if (user?.role !== \"admin\") {\n    return redirect(\"/\")\n  }\n\n  const project = await getProjectById(params.projectId)\n  return <ProjectForm project={project} />\n}\n```\n\nNotice the pattern: check permissions **before** fetching data or rendering the page.\n\n## The Problem With This System\n\nAs we add these checks, notice how we're:\n\n- Copying and pasting the same permission checks everywhere\n- Hoping we don't make typos or forget a condition\n\nThis is exactly why we need to **centralize** this logic. If our department permission rule changes, we now have to update it in **every single file**.\n\n## Branch Checkpoint\n\nAfter completing these fixes, your code should match:\n\n```text\nBranch: 2-fix-basic-permission-errors\n```\n\nRun the following to sync up:\n\n```bash\ngit checkout 2-fix-basic-permission-errors\n```\n","slug":"fixing-basic-permissions","title":"Fixing Basic Permissions","section":"Fixing Basic Permissions","icon":"wrench","filePath":"/home/runner/work/fem-permission-systems-that-scale/fem-permission-systems-that-scale/lessons/02-fixing-basic-permissions/B-fixing-basic-permissions.md","nextSlug":"/fem-permission-systems-that-scale/lessons/fixing-basic-permissions/the-case-for-better-architecture","prevSlug":"/fem-permission-systems-that-scale/lessons/fixing-basic-permissions/common-permission-mistakes"}},"__N_SSG":true}